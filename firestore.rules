rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a user to read and write their own profile data.
     * @path /users/{userId}
     * @allow (create, update, get, delete, list) if request.auth.uid == userId
     * @deny (create, update, get, delete, list) if request.auth.uid != userId
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

     /**
     * @description Allows a user to manage their own followers.
     * @path /users/{userId}/followers/{followerId}
     * @allow (create, update, get, delete, list) if request.auth.uid == userId
     * @deny (create, update, get, delete, list) if request.auth.uid != userId
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/followers/{followerId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if false;
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows a user to manage who they are following.
     * @path /users/{userId}/following/{followedId}
     * @allow (create, update, get, delete, list) if request.auth.uid == userId
     * @deny (create, update, get, delete, list) if request.auth.uid != userId
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/following/{followedId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if false;
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows a user to read and write their own preferences.
     * @path /users/{userId}/preferences/default
     * @allow (create, update, get, delete, list) if request.auth.uid == userId
     * @deny (create, update, get, delete, list) if request.auth.uid != userId
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/preferences/default {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows a user to manage their awarded badges.
     * @path /users/{userId}/badges/{badgeId}
     * @allow (create, update, get, delete, list) if request.auth.uid == userId
     * @deny (create, update, get, delete, list) if request.auth.uid != userId
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/badges/{badgeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if false;
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows a user to manage their bookmarked temples.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (create, update, get, delete, list) if request.auth.uid == userId
     * @deny (create, update, get, delete, list) if request.auth.uid != userId
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if false;
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows a user to manage their virtual offerings.
     * @path /users/{userId}/virtualOfferings/{offeringId}
     * @allow (create, update, get, delete, list) if request.auth.uid == userId
     * @deny (create, update, get, delete, list) if request.auth.uid != userId
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/virtualOfferings/{offeringId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if false;
      allow delete: if isSignedIn() && isOwner(userId);
    }

     /**
      * @description Allows a user to manage their shopping cart.
      * @path /users/{userId}/cart/{productId}
      * @allow (create, update, get, delete, list) if request.auth.uid == userId
      * @deny (create, update, get, delete, list) if request.auth.uid != userId
      * @principle Enforces document ownership for all operations.
      */
    match /users/{userId}/cart/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows a user to view their order history.
     * @path /users/{userId}/orders/{orderId}
     * @allow (create, update, get, delete, list) if request.auth.uid == userId
     * @deny (create, update, get, delete, list) if request.auth.uid != userId
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/orders/{orderId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(userId) {
            return request.auth.uid == userId;
        }

        allow get: if isSignedIn() && isOwner(userId);
        allow list: if isSignedIn() && isOwner(userId);
        allow create: if isSignedIn() && isOwner(userId);
        allow update: if false;
        allow delete: if false;
    }

    /**
     * @description Allows a user to manage their playlists.
     * @path /users/{userId}/playlists/{playlistId}
     * @allow (create, update, get, delete, list) if request.auth.uid == userId
     * @deny (create, update, get, delete, list) if request.auth.uid != userId
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/playlists/{playlistId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows a user to manage their challenge progress.
     * @path /users/{userId}/challenges/{challengeId}
     * @allow (create, update, get, delete, list) if request.auth.uid == userId
     * @deny (create, update, get, delete, list) if request.auth.uid != userId
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/challenges/{challengeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows anyone to read media, but only the owner can modify it.
     * @path /media/{mediaId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if request.auth.uid == resource.data.userId
     * @deny (create, update, delete) if request.auth.uid != resource.data.userId
     * @principle Public read access with owner-only writes.
     */
    match /media/{mediaId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    /**
     * @description Allows anyone to read comments for a media item, but only the owner can create them.
     * @path /media/{mediaId}/comments/{commentId}
     * @allow (get, list) if true
     * @allow (create) if request.auth.uid != null
     * @allow (update, delete) if request.auth.uid == resource.data.authorId
     * @deny (update, delete) if request.auth.uid != resource.data.authorId
     * @principle Public read access with owner-only writes.
     */
     match /media/{mediaId}/comments/{commentId} {
        function isSignedIn() {
          return request.auth != null;
        }

        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && request.auth.uid == resource.data.authorId;
        allow delete: if isSignedIn() && request.auth.uid == resource.data.authorId;
    }

    /**
     * @description Allows a user to like a media item
     * @path /media/{mediaId}/likes/{userId}
     * @allow create: if request.auth.uid == userId
     * @allow delete: if request.auth.uid == userId && resource != null
     * @allow get: if true;
     * @allow list: if true;
     * @allow update: if false;
     * @principle Self-creation with public read access.
     */
     match /media/{mediaId}/likes/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update: if false;
        allow delete: if isSignedIn() && request.auth.uid == userId && existsAfter(/databases/$(database)/documents/media/$(mediaId)/likes/$(userId));
    }

    /**
     * @description Allows anyone to read channel, but only the owner can modify it.
     * @path /channels/{channelId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if request.auth.uid == resource.data.userId
     * @deny (create, update, delete) if request.auth.uid != resource.data.userId
     * @principle Public read access with owner-only writes.
     */
    match /channels/{channelId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    /**
     * @description Allows anyone to read playlists, but only the owner can modify it.
     * @path /playlists/{playlistId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if request.auth.uid == resource.data.creatorId
     * @deny (create, update, delete) if request.auth.uid != resource.data.creatorId
     * @principle Public read access with owner-only writes.
     */
    match /playlists/{playlistId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.creatorId;
      allow update: if isSignedIn() && request.auth.uid == resource.data.creatorId;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.creatorId;
    }

    /**
     * @description Allows a user to read and write their own horoscopes.
     * @path /users/{userId}/horoscopes/{horoscopeId}
     * @allow (create, update, get, delete, list) if request.auth.uid == userId
     * @deny (create, update, get, delete, list) if request.auth.uid != userId
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/horoscopes/{horoscopeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows anyone to read deities.
     * @path /deities/{deityId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Public read access, no writes allowed.
     */
    match /deities/{deityId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

     /**
      * @description Allows a shop owner to read/write their shop data, but allows anyone to read.
      * @path /shops/{shopId}
      * @allow (get, list) if true
      * @allow (create, update, delete) if request.auth.uid == resource.data.ownerId
      * @deny (create, update, delete) if request.auth.uid != resource.data.ownerId
      * @principle Public read access with owner-only writes.
      */
    match /shops/{shopId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.ownerId;
      allow update: if isSignedIn() && request.auth.uid == resource.data.ownerId;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.ownerId;
    }

    /**
     * @description Allows anyone to read product data, but only the shop owner can modify it.
     * @path /products/{productId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if get(/databases/$(database)/documents/shops/$(resource.data.shopId)).data.ownerId == request.auth.uid
     * @deny (create, update, delete) if get(/databases/$(database)/documents/shops/$(resource.data.shopId)).data.ownerId != request.auth.uid
     * @principle Public read access with shop-owner-only writes.
     */
    match /products/{productId} {
        function isSignedIn() {
          return request.auth != null;
        }
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn() && request.resource.data.keys().hasAll(['shopId']) && get(/databases/$(database)/documents/shops/$(request.resource.data.shopId)).data.ownerId == request.auth.uid;
        allow update: if isSignedIn() && request.resource.data.keys().hasAll(['shopId']) && get(/databases/$(database)/documents/shops/$(resource.data.shopId)).data.ownerId == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.keys().hasAll(['shopId']) && get(/databases/$(database)/documents/shops/$(resource.data.shopId)).data.ownerId == request.auth.uid;
    }

    /**
     * @description Allows anyone to read temple data.
     * @path /temples/{templeId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Public read access, no writes allowed.
     */
    match /temples/{templeId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read temple reviews, but only the review author can modify their own reviews.
     * @path /temples/{templeId}/reviews/{reviewId}
     * @allow (get, list) if true
     * @allow (create) if request.auth.uid != null
     * @allow (update, delete) if request.auth.uid == resource.data.userId
     * @deny (update, delete) if request.auth.uid != resource.data.userId
     * @principle Public read access, owner-only writes for updates and deletes.
     */
    match /temples/{templeId}/reviews/{reviewId} {
        function isSignedIn() {
          return request.auth != null;
        }

        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && request.auth.uid == resource.data.userId;
        allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    /**
     * @description Allows anyone to read temple posts, and only the author can modify their posts.
     * @path /temples/{templeId}/posts/{postId}
     * @allow (get, list) if true
     * @allow (create) if request.auth.uid != null
     * @allow (update, delete) if request.auth.uid == resource.data.authorId
     * @deny (update, delete) if request.auth.uid != resource.data.authorId
     * @principle Public read access, owner-only writes for updates and deletes.
     */
     match /temples/{templeId}/posts/{postId} {
        function isSignedIn() {
          return request.auth != null;
        }

        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && request.auth.uid == resource.data.authorId;
        allow delete: if isSignedIn() && request.auth.uid == resource.data.authorId;
    }

    /**
     * @description Allows anyone to read story data.
     * @path /stories/{storyId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Public read access, no writes allowed.
     */
    match /stories/{storyId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read epic hero data.
     * @path /epicHeroes/{heroId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Public read access, no writes allowed.
     */
    match /epicHeroes/{heroId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read ritual data.
     * @path /rituals/{ritualId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Public read access, no writes allowed.
     */
    match /rituals/{ritualId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read panchang data.
     * @path /panchang/{date}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Public read access, no writes allowed.
     */
    match /panchang/{date} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read festival data.
     * @path /festivals/{festivalId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Public read access, no writes allowed.
     */
    match /festivals/{festivalId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read group data.
     * @path /groups/{groupId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     */
    match /groups/{groupId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows users to manage their group memberships.
     * @path /groups/{groupId}/members/{userId}
     * @allow create: if request.auth.uid == userId
     * @allow delete: if request.auth.uid == userId && resource != null
     * @allow get: if true;
     * @allow list: if true;
     * @allow update: if false;
     * @principle Self-creation with public read access.
     */
     match /groups/{groupId}/members/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update: if false;
        allow delete: if isSignedIn() && request.auth.uid == userId && existsAfter(/databases/$(database)/documents/groups/$(groupId)/members/$(userId));
    }

     /**
     * @description Allows anyone to read forum posts, and only the author can modify their posts.
     * @path /groups/{groupId}/posts/{postId}
     * @allow (get, list) if true
     * @allow (create) if request.auth.uid != null
     * @allow (update, delete) if request.auth.uid == resource.data.authorId
     * @deny (update, delete) if request.auth.uid != resource.data.authorId
     * @principle Public read access, owner-only writes for updates and deletes.
     */
     match /groups/{groupId}/posts/{postId} {
        function isSignedIn() {
          return request.auth != null;
        }

        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && request.auth.uid == resource.data.authorId;
        allow delete: if isSignedIn() && request.auth.uid == resource.data.authorId;
    }

    /**
     * @description Allows anyone to read comments on group posts, and only the author can modify their comments.
     * @path /groups/{groupId}/posts/{postId}/comments/{commentId}
     * @allow (get, list) if true
     * @allow (create) if request.auth.uid != null
     * @allow (update, delete) if request.auth.uid == resource.data.authorId
     * @deny (update, delete) if request.auth.uid != resource.data.authorId
     * @principle Public read access, owner-only writes for updates and deletes.
     */
     match /groups/{groupId}/posts/{postId}/comments/{commentId} {
        function isSignedIn() {
          return request.auth != null;
        }

        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && request.auth.uid == resource.data.authorId;
        allow delete: if isSignedIn() && request.auth.uid == resource.data.authorId;
    }

    /**
     * @description Allows a user to like a group post
     * @path /groups/{groupId}/posts/{postId}/likes/{userId}
     * @allow create: if request.auth.uid == userId
     * @allow delete: if request.auth.uid == userId && resource != null
     * @allow get: if true;
     * @allow list: if true;
     * @allow update: if false;
     * @principle Self-creation with public read access.
     */
     match /groups/{groupId}/posts/{postId}/likes/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update: if false;
        allow delete: if isSignedIn() && request.auth.uid == userId && existsAfter(/databases/$(database)/documents/groups/$(groupId)/posts/$(postId)/likes/$(userId));
    }

     /**
     * @description Allows anyone to read challenge data.
     * @path /challenges/{challengeId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Public read access, no writes allowed.
     */
    match /challenges/{challengeId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}