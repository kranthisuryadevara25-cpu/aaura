/**
 * @fileoverview Firestore Security Rules for the aaura app.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for private data, while allowing public read access to certain collections.
 * User-generated content is generally associated with the user's ID for authorization.
 *
 * Data Structure:
 * - User profiles and related data (followers, following, preferences, bookmarks, virtual offerings, cart, orders, playlists, challenges, horoscopes) are nested under /users/{userId}.
 * - Public content (media, channels, deities, shops, products, temples, stories, epic heroes, rituals, festivals, challenges) is stored in top-level collections.
 * - Group and Temple posts exist in the top level domain and are contextualized by contextId and contextType.
 *
 * Key Security Decisions:
 * - Users can only manage their own profiles and associated data.
 * - Public content is readable by all, but write access is restricted to authorized users.
 * - Listing of other user's data is generally denied for privacy.
 * - Data consistency is enforced between document IDs and user IDs in nested collections.
 * - Write operations on existing documents require the document to exist.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if the authenticated user is the owner of the resource
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to check if the authenticated user is the owner of the existing resource
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces user-ownership for user profiles.
     * @path /users/{userId}
     * @allow (create) User 'user123' can create their profile if request.auth.uid == 'user123'.
     * @deny (create) User 'user456' cannot create a profile with ID 'user123'.
     * @allow (get, update, delete) User 'user123' can get, update, or delete their own profile.
     * @deny (get, update, delete) User 'user123' cannot get, update, or delete profile 'user456'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if true;
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for followers subcollection.
     * @path /users/{userId}/followers/{followerId}
     * @allow (create) User 'follower123' can create a follow document under 'user123's followers collection if they are logged in.
     * @deny (create) User 'follower123' cannot create a follow document if they are not the follower.
     * @allow (get, list) User 'user123' can get and list their own followers.
     * @deny (update, delete) No one can update or delete follow documents.
     * @principle Restricts access to a user's own followers.
     */
    match /users/{userId}/followers/{followerId} {
      allow get, list: if isOwner(userId);
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Enforces user-ownership for following subcollection.
     * @path /users/{userId}/following/{followedId}
     * @allow (create) User 'user123' can create a follow document under their own following collection if they are logged in.
     * @deny (create) User 'user123' cannot create a follow document if they are not the one following.
     * @allow (get, list) User 'user123' can get and list the users they are following.
     * @deny (update, delete) No one can update or delete following documents.
     * @principle Restricts access to a user's own following list.
     */
    match /users/{userId}/following/{followedId} {
      allow get, list: if isOwner(userId);
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Enforces user-ownership for user preferences.
     * @path /users/{userId}/preferences/default
     * @allow (get, update, delete) User 'user123' can manage their own preferences.
     * @deny (create) Creating new preference documents is forbidden (singleton document).
     * @principle Restricts access to a user's own preferences.
     */
    match /users/{userId}/preferences/default {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if false;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for badges awarded to a user.
     * @path /users/{userId}/badges/{badgeId}
     * @allow (get, list) User 'user123' can view their own awarded badges.
     * @deny (create, update, delete) Only the system can award/manage badges.
     * @principle Restricts badge management to the system.
     */
    match /users/{userId}/badges/{badgeId} {
      allow get, list: if isOwner(userId);
      allow create, update, delete: if false;
    }

    /**
     * @description Enforces user-ownership for bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (get, create, delete, list) User 'user123' can manage their own bookmarks.
     * @deny (update) Bookmarks should not be updated, only created or deleted.
     * @principle Restricts bookmark management to the user.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for virtual offerings.
     * @path /users/{userId}/virtualOfferings/{offeringId}
     * @allow (get, create, list) User 'user123' can create and view their own offerings.
     * @deny (update, delete) Offerings are immutable once created.
     * @principle Restricts virtual offering management to the user.
     */
    match /users/{userId}/virtualOfferings/{offeringId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update, delete: if false;
    }

    /**
     * @description Enforces user-ownership for cart items.
     * @path /users/{userId}/cart/{productId}
     * @allow (get, create, update, delete, list) User 'user123' can manage their own cart items.
     * @principle Restricts cart management to the user.
     */
    match /users/{userId}/cart/{productId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for orders.
     * @path /users/{userId}/orders/{orderId}
     * @allow (get, list) User 'user123' can view their own orders.
     * @deny (create, update, delete) Orders are created by the system and cannot be modified by users.
     * @principle Restricts order management to the system.
     */
    match /users/{userId}/orders/{orderId} {
      allow get, list: if isOwner(userId);
      allow create, update, delete: if false;
    }

    /**
     * @description Enforces user-ownership for playlists.
     * @path /users/{userId}/playlists/{playlistId}
     * @allow (get, create, list) User 'user123' can manage their own playlist references.
     * @deny (update, delete) Playlist references are immutable once created.
     * @principle Restricts playlist reference management to the user.
     */
    match /users/{userId}/playlists/{playlistId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update, delete: if false;
    }

    /**
     * @description Enforces user-ownership for user challenge progress.
     * @path /users/{userId}/challenges/{challengeId}
     * @allow (get, create, update, list) User 'user123' can manage their own challenge progress.
     * @deny (delete) Challenge progress should not be deleted.
     * @principle Restricts challenge progress management to the user.
     */
    match /users/{userId}/challenges/{challengeId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Allows public read access to media, restricts writes to authorized users.
     * @path /media/{mediaId}
     * @allow (get, list) Anyone can read media content.
     * @deny (create, update, delete) Media content is managed by authorized users.
     * @principle Public read, restricted write.
     */
    match /media/{mediaId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Enforces user-ownership for comments on media.
     * @path /media/{mediaId}/comments/{commentId}
     * @allow (get, create, list) Anyone can read and create comments.
     * @deny (update, delete) Only the owner can update or delete a comment.
     * @principle Public read/create, owner-only update/delete.
     */
    match /media/{mediaId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

       /**
        * @description Allows authenticated users to like media content
        * @path /media/{mediaId}/likes/{userId}
        * @allow (create) Allows a user to like a media.
        * @deny (delete) Prevent media owner from deleting the like.
        * @principle Authenticated users may like/unlike media, but may not delete other user's likes.
        */
    match /media/{mediaId}/likes/{userId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Enforces user-ownership for channels.
     * @path /channels/{channelId}
     * @allow (get, list) Anyone can read channel information.
     * @allow (create) The owner of the channel can create.
     * @deny (update, delete) Only the owner of the channel can update or delete it.
     * @principle Owner-only write access.
     */
    match /channels/{channelId} {
      allow get, list: if true;
      allow create: if request.auth.uid == request.resource.data.userId;
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Allows public read access to playlists, restricts writes to authorized users.
     * @path /playlists/{playlistId}
     * @allow (get, list) Anyone can read playlist information.
     * @deny (create, update, delete) Playlist management is restricted.
     * @principle Public read, restricted write.
     */
    match /playlists/{playlistId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Enforces user-ownership for horoscopes.
     * @path /users/{userId}/horoscopes/{horoscopeId}
     * @allow (get, list) User 'user123' can read their own horoscopes.
     * @deny (create, update, delete) Horoscope creation/management is restricted to the system.
     * @principle User-only read access.
     */
    match /users/{userId}/horoscopes/{horoscopeId} {
      allow get, list: if isOwner(userId);
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to deity information.
     * @path /deities/{deityId}
     * @allow (get, list) Anyone can read deity information.
     * @deny (create, update, delete) Deity information is managed by authorized users.
     * @principle Public read, restricted write.
     */
    match /deities/{deityId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to shops, restricts writes to shop owners.
     * @path /shops/{shopId}
     * @allow (get, list) Anyone can read shop information.
     * @deny (create, update, delete) Shop management is restricted to the shop owner.
     * @principle Public read, owner-only write.
     */
    match /shops/{shopId} {
      allow get, list: if true;
      allow create: if request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.ownerId);
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Allows public read access to products.
     * @path /products/{productId}
     * @allow (get, list) Anyone can read product information.
     * @deny (create, update, delete) Product management is restricted.
     * @principle Public read, restricted write.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to temple information.
     * @path /temples/{templeId}
     * @allow (get, list) Anyone can read temple information.
     * @deny (create, update, delete) Temple data is managed by authorized users.
     * @principle Public read, restricted write.
     */
    match /temples/{templeId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Enforces user-ownership for temple reviews.
     * @path /temples/{templeId}/reviews/{reviewId}
     * @allow (get, create, list) Anyone can read and create reviews.
     * @deny (update, delete) Only the owner can update or delete a review.
     * @principle Public read/create, owner-only update/delete.
     */
    match /temples/{templeId}/reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

     /**
      * @description Allows public read access to Story information.
      * @path /stories/{storyId}
      * @allow (get, list) Anyone can read story information.
      * @deny (create, update, delete) Stories data is managed by authorized users.
      * @principle Public read, restricted write.
      */
    match /stories/{storyId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to epic heroes information.
     * @path /epicHeroes/{heroId}
     * @allow (get, list) Anyone can read epic heroes information.
     * @deny (create, update, delete) Epic Heros data is managed by authorized users.
     * @principle Public read, restricted write.
     */
    match /epicHeroes/{heroId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

   /**
    * @description Allows public read access to Ritual information.
    * @path /rituals/{ritualId}
    * @allow (get, list) Anyone can read Ritual information.
    * @deny (create, update, delete) Ritual data is managed by authorized users.
    * @principle Public read, restricted write.
    */
    match /rituals/{ritualId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to Panchang information.
     * @path /panchang/{date}
     * @allow (get, list) Anyone can read Panchang information.
     * @deny (create, update, delete) Panchang data is managed by authorized users.
     * @principle Public read, restricted write.
     */
    match /panchang/{date} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to Festival information.
     * @path /festivals/{festivalId}
     * @allow (get, list) Anyone can read Festival information.
     * @deny (create, update, delete) Festival data is managed by authorized users.
     * @principle Public read, restricted write.
     */
    match /festivals/{festivalId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

     /**
      * @description Allows public read access to Group information.
      * @path /groups/{groupId}
      * @allow (get, list) Anyone can read group information.
      * @deny (create, update, delete) Group data is managed by authorized users.
      * @principle Public read, restricted write.
      */
    match /groups/{groupId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Enforces user-ownership for temple posts.
     * @path /temples/{templeId}/posts/{postId}
     * @allow (get, create, list) Anyone can read and create posts.
     * @deny (update, delete) Only the owner can update or delete a post.
     * @principle Public read/create, owner-only update/delete.
     */
    match /temples/{templeId}/posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

     /**
      * @description Enforces user-ownership for group members.
      * @path /groups/{groupId}/members/{userId}
      * @allow (create) A user can create their own membership record.
      * @allow (get, list) Anyone can read list the group's member records.
      * @deny (update, delete) Only the owner can update or delete a membership.
      * @principle Authenticated users may join and leave groups, but may not edit other members.
      */
    match /groups/{groupId}/members/{userId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

   /**
    * @description Enforces user-ownership for group posts.
    * @path /groups/{groupId}/posts/{postId}
    * @allow (get, create, list) Anyone can read and create posts.
    * @deny (update, delete) Only the owner can update or delete a post.
    * @principle Public read/create, owner-only update/delete.
    */
    match /groups/{groupId}/posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

   /**
    * @description Enforces user-ownership for comment for a specific post within a group.
    * @path /groups/{groupId}/posts/{postId}/comments/{commentId}
    * @allow (get, create, list) Anyone can read and create comments.
    * @deny (update, delete) Only the owner can update or delete a comment.
    * @principle Public read/create, owner-only update/delete.
    */
    match /groups/{groupId}/posts/{postId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

  /**
   * @description Allows authenticated users to like posts in a specific group
   * @path /groups/{groupId}/posts/{postId}/likes/{userId}
   * @allow (create) Allows a user to like a post.
   * @deny (delete) Prevent media owner from deleting the like.
   * @principle Authenticated users may like/unlike media, but may not delete other user's likes.
   */
    match /groups/{groupId}/posts/{postId}/likes/{userId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

   /**
    * @description Allows public read access to Challenge information.
    * @path /challenges/{challengeId}
    * @allow (get, list) Anyone can read challenge information.
    * @deny (create, update, delete) Challenge data is managed by authorized users.
    * @principle Public read, restricted write.
    */
    match /challenges/{challengeId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }
  }
}