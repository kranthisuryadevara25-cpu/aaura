/**
 * @fileoverview Firestore Security Rules for the aaura app.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal data
 * while allowing public read access to shared content.  Write access to
 * user-specific data is restricted to the owning user. Public content can
 * only be modified by authorized users with appropriate roles (not implemented).
 *
 * Data Structure:
 * - User-specific data is nested under `/users/{userId}`.
 * - Public content resides in top-level collections like `/media`, `/temples`, etc.
 *
 * Key Security Decisions:
 * - Users can only access their own data under their respective `/users/{userId}` path.
 * - Listing of users is disallowed to prevent data scraping.
 * - Public content is readable by everyone, but write access is restricted (currently to no one).
 *
 * Denormalization for Authorization:
 *  The ruleset depends on the `request.auth.uid` matching the `userId` in the path for most write operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Controls access to user profiles.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create their profile at /users/user123 if request.auth.uid == 'user123'.
     * @allow (get,update,delete) - User with UID 'user123' can read, update, or delete their profile at /users/user123 if request.auth.uid == 'user123'.
     * @deny (create) - User with UID 'user456' cannot create a profile at /users/user123.
     * @deny (get,update,delete) - User with UID 'user456' cannot read, update, or delete the profile at /users/user123.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Tracks user progress in a specific contest.
     * @path /users/{userId}/contestProgress/{contestId}
     * @allow (create,update,delete,get,list) - User with UID 'user123' can create, update, delete or read their contest progress at /users/user123/contestProgress/{contestId} if request.auth.uid == 'user123'.
     * @deny (create,update,delete,get) - User with UID 'user456' cannot create, update, delete or read contest progress at /users/user123/contestProgress/{contestId}.
     * @principle Enforces document ownership for user contest progress.
     */
    match /users/{userId}/contestProgress/{contestId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores the users who are following a user.
     * @path /users/{userId}/followers/{followerId}
     * @allow (create) - User 'follower789' can create a follow relationship to 'user123' at /users/user123/followers/follower789 if request.auth.uid == 'follower789'.
     * @allow (get,list) - User 'user123' can see who is following them.
     * @deny (create) - User 'anotherUser' cannot create a follow relationship for another user.
     * @deny (update,delete) - Follow relationships should not be updated or deleted directly (handle with code logic).
     * @principle Only the follower can create the follow document.
     */
    match /users/{userId}/followers/{followerId} {
      allow get, list: if isOwner(userId);
      allow create: if request.auth.uid == followerId;
      allow update, delete: if false; // Follower relationships are not directly mutable
    }

    /**
     * @description Stores the users a user is following.
     * @path /users/{userId}/following/{followedId}
     * @allow (create) - User 'user123' can create a following relationship at /users/user123/following/followed456 if request.auth.uid == 'user123'.
     * @allow (get,list) - User 'user123' can see who they are following.
     * @deny (create) - User 'anotherUser' cannot create a following relationship for another user.
     * @deny (update,delete) - Following relationships should not be updated or deleted directly (handle with code logic).
     * @principle Only the user can create the following document.
     */
    match /users/{userId}/following/{followedId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update, delete: if false; // Following relationships are not directly mutable
    }

    /**
     * @description Stores user preferences.
     * @path /users/{userId}/preferences/default
     * @allow (create,update,delete,get,list) - User with UID 'user123' can create, update, delete or read their preferences at /users/user123/preferences/default if request.auth.uid == 'user123'.
     * @deny (create,update,delete,get) - User with UID 'user456' cannot create, update, delete or read preferences at /users/user123/preferences/default.
     * @principle Enforces document ownership for user preferences.
     */
    match /users/{userId}/preferences/default {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores gamification badges awarded to the user.
     * @path /users/{userId}/badges/{badgeId}
     * @allow (create,update,delete,get,list) - User with UID 'user123' can create, update, delete or read their badges at /users/user123/badges/{badgeId} if request.auth.uid == 'user123'.
     * @deny (create,update,delete,get) - User with UID 'user456' cannot create, update, delete or read badges at /users/user123/badges/{badgeId}.
     * @principle Enforces document ownership for user badges.
     */
    match /users/{userId}/badges/{badgeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores user bookmarks for temples.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (create,update,delete,get,list) - User with UID 'user123' can create, update, delete or read their bookmarks at /users/user123/bookmarks/{bookmarkId} if request.auth.uid == 'user123'.
     * @deny (create,update,delete,get) - User with UID 'user456' cannot create, update, delete or read bookmarks at /users/user123/bookmarks/{bookmarkId}.
     * @principle Enforces document ownership for user bookmarks.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores a user's interactions in the virtual pooja room.
     * @path /users/{userId}/virtualOfferings/{offeringId}
     * @allow (create,update,delete,get,list) - User with UID 'user123' can create, update, delete or read their virtual offerings at /users/user123/virtualOfferings/{offeringId} if request.auth.uid == 'user123'.
     * @deny (create,update,delete,get) - User with UID 'user456' cannot create, update, delete or read virtual offerings at /users/user123/virtualOfferings/{offeringId}.
     * @principle Enforces document ownership for user virtual offerings.
     */
    match /users/{userId}/virtualOfferings/{offeringId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores items in a user's shopping cart.
     * @path /users/{userId}/cart/{productId}
     * @allow (create,update,delete,get,list) - User with UID 'user123' can create, update, delete or read their cart at /users/user123/cart/{productId} if request.auth.uid == 'user123'.
     * @deny (create,update,delete,get) - User with UID 'user456' cannot create, update, delete or read cart items at /users/user123/cart/{productId}.
     * @principle Enforces document ownership for shopping cart.
     */
    match /users/{userId}/cart/{productId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores a user's past orders.
     * @path /users/{userId}/orders/{orderId}
     * @allow (create,update,delete,get,list) - User with UID 'user123' can create, update, delete or read their orders at /users/user123/orders/{orderId} if request.auth.uid == 'user123'.
     * @deny (create,update,delete,get) - User with UID 'user456' cannot create, update, delete or read orders at /users/user123/orders/{orderId}.
     * @principle Enforces document ownership for orders.
     */
    match /users/{userId}/orders/{orderId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Reference to playlists created by the user.
     * @path /users/{userId}/playlists/{playlistId}
     * @allow (create,update,delete,get,list) - User with UID 'user123' can create, update, delete or read their playlists at /users/user123/playlists/{playlistId} if request.auth.uid == 'user123'.
     * @deny (create,update,delete,get) - User with UID 'user456' cannot create, update, delete or read playlists at /users/user123/playlists/{playlistId}.
     * @principle Enforces document ownership for playlists.
     */
    match /users/{userId}/playlists/{playlistId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Tracks user progress in community challenges.
     * @path /users/{userId}/challenges/{challengeId}
     * @allow (create,update,delete,get,list) - User with UID 'user123' can create, update, delete or read their challenges at /users/user123/challenges/{challengeId} if request.auth.uid == 'user123'.
     * @deny (create,update,delete,get) - User with UID 'user456' cannot create, update, delete or read challenges at /users/user123/challenges/{challengeId}.
     * @principle Enforces document ownership for user challenges.
     */
    match /users/{userId}/challenges/{challengeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores all media on the platform.
     * @path /media/{mediaId}
     * @allow (get,list) - Any user can read any media.
     * // CRITICAL: Cannot implement owner-only writes. The 'Media' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /media/{mediaId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores comments for a specific media item.
     * @path /media/{mediaId}/comments/{commentId}
     * @allow (get,list) - Any user can read comments on any media.
     * // CRITICAL: Cannot implement owner-only writes. The 'Comment' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /media/{mediaId}/comments/{commentId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores likes for a specific media item. Document ID is the user's UID.
     * @path /media/{mediaId}/likes/{userId}
     * @allow (create) - Any signed-in user can like a media item.
     * @allow (get,list) - Any user can view the likes.
     * @deny (update,delete) - Users can't update or delete likes directly.
     * @principle Anyone signed in can like media.
     */
    match /media/{mediaId}/likes/{userId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update, delete: if false;
    }

    /**
     * @description Stores all channels on the platform.
     * @path /channels/{channelId}
     * @allow (get,list) - Any user can read any channel.
     * // CRITICAL: Cannot implement owner-only writes. The 'Channel' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /channels/{channelId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores all public or user-created playlists.
     * @path /playlists/{playlistId}
     * @allow (get,list) - Any user can read any playlist.
     * // CRITICAL: Cannot implement owner-only writes. The 'Playlist' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /playlists/{playlistId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores horoscopes generated for users.
     * @path /users/{userId}/horoscopes/{horoscopeId}
     * @allow (create,update,delete,get,list) - User with UID 'user123' can create, update, delete or read their horoscopes at /users/user123/horoscopes/{horoscopeId} if request.auth.uid == 'user123'.
     * @deny (create,update,delete,get) - User with UID 'user456' cannot create, update, delete or read horoscopes at /users/user123/horoscopes/{horoscopeId}.
     * @principle Enforces document ownership for user horoscopes.
     */
    match /users/{userId}/horoscopes/{horoscopeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores information about Hindu deities.
     * @path /deities/{deityId}
     * @allow (get,list) - Any user can read any deity.
     * // CRITICAL: Cannot implement owner-only writes. The 'Deity' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /deities/{deityId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores all shops for the marketplace.
     * @path /shops/{shopId}
     * @allow (get,list) - Any user can read any shop.
     * // CRITICAL: Cannot implement owner-only writes. The 'Shop' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /shops/{shopId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores all products for the marketplace.
     * @path /products/{productId}
     * @allow (get,list) - Any user can read any product.
     * // CRITICAL: Cannot implement owner-only writes. The 'Product' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores all temple and pilgrimage data.
     * @path /temples/{templeId}
     * @allow (get,list) - Any user can read any temple.
     * // CRITICAL: Cannot implement owner-only writes. The 'Temple' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /temples/{templeId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores user reviews for a specific temple.
     * @path /temples/{templeId}/reviews/{reviewId}
     * @allow (get,list) - Any user can read any review.
     * // CRITICAL: Cannot implement owner-only writes. The 'Review' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /temples/{templeId}/reviews/{reviewId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores user posts for a specific temple.
     * @path /temples/{templeId}/posts/{postId}
     * @allow (get,list) - Any user can read any post.
     * // CRITICAL: Cannot implement owner-only writes. The 'Post' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /temples/{templeId}/posts/{postId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores mythological stories.
     * @path /stories/{storyId}
     * @allow (get,list) - Any user can read any story.
     * // CRITICAL: Cannot implement owner-only writes. The 'Story' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /stories/{storyId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores mythological heroes and characters.
     * @path /epicHeroes/{heroId}
     * @allow (get,list) - Any user can read any epic hero.
     * // CRITICAL: Cannot implement owner-only writes. The 'EpicHero' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /epicHeroes/{heroId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores guidelines for various rituals and poojas.
     * @path /rituals/{ritualId}
     * @allow (get,list) - Any user can read any ritual.
     * // CRITICAL: Cannot implement owner-only writes. The 'Ritual' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /rituals/{ritualId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores daily panchang data.
     * @path /panchang/{date}
     * @allow (get,list) - Any user can read any panchang.
     * // CRITICAL: Cannot implement owner-only writes. The 'Panchang' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /panchang/{date} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores details about cultural and religious festivals.
     * @path /festivals/{festivalId}
     * @allow (get,list) - Any user can read any festival.
     * // CRITICAL: Cannot implement owner-only writes. The 'Festival' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /festivals/{festivalId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores community groups.
     * @path /groups/{groupId}
     * @allow (get,list) - Any user can read any group.
     * // CRITICAL: Cannot implement owner-only writes. The 'Group' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /groups/{groupId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

     /**
     * @description Stores members of a group.
     * @path /groups/{groupId}/members/{userId}
     * @allow (create) - If group membership is open, any user can join.  If closed, handle logic in the app.
     * @allow (get,list) - Members can see the membership list.
     * @deny (update,delete) - Group membership is not directly mutable.
     * @principle Group members can see who is in the group.
     */
    match /groups/{groupId}/members/{userId} {
        allow get, list: if true;
        allow create: if isSignedIn(); // Implement closed groups via backend functions
        allow update, delete: if false;
    }

    /**
     * @description Stores posts within a specific group.
     * @path /posts/{postId}
     * @allow (get,list) - Any user can read any post.
     * // CRITICAL: Cannot implement owner-only writes. The 'Post' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /posts/{postId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

     /**
     * @description Stores comments for a specific post within a group.
     * @path /posts/{postId}/comments/{commentId}
     * @allow (get,list) - Any user can read comments on any post.
     * // CRITICAL: Cannot implement owner-only writes. The 'Comment' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /posts/{postId}/comments/{commentId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores likes for a specific forum post. Document ID is the user's UID.
     * @path /posts/{postId}/likes/{userId}
     * @allow (create) - Any signed-in user can like a post.
     * @allow (get,list) - Any user can view the likes.
     * @deny (update,delete) - Users can't update or delete likes directly.
     * @principle Anyone signed in can like a post.
     */
    match /posts/{postId}/likes/{userId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update, delete: if false;
    }

    /**
     * @description Stores community challenges.
     * @path /challenges/{challengeId}
     * @allow (get,list) - Any user can read any challenge.
     * // CRITICAL: Cannot implement owner-only writes. The 'Challenge' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /challenges/{challengeId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores global chanting contests.
     * @path /contests/{contestId}
     * @allow (get,list) - Any user can read any contest.
     * // CRITICAL: Cannot implement owner-only writes. The 'Contest' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /contests/{contestId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

     /**
     * @description Stores user-submitted manifestation techniques and stories.
     * @path /manifestations/{manifestationId}
     * @allow (get,list) - Any user can read any manifestation.
     * // CRITICAL: Cannot implement owner-only writes. The 'Manifestation' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /manifestations/{manifestationId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

     /**
     * @description Stores comments on a manifestation post.
     * @path /manifestations/{manifestationId}/comments/{commentId}
     * @allow (get,list) - Any user can read comments on any manifestation.
     * // CRITICAL: Cannot implement owner-only writes. The 'Comment' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /manifestations/{manifestationId}/comments/{commentId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores likes for a manifestation post. Document ID is the user's UID.
     * @path /manifestations/{manifestationId}/likes/{userId}
     * @allow (create) - Any signed-in user can like a manifestation post.
     * @allow (get,list) - Any user can view the likes.
     * @deny (update,delete) - Users can't update or delete likes directly.
     * @principle Anyone signed in can like a manifestation post.
     */
    match /manifestations/{manifestationId}/likes/{userId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update, delete: if false;
    }
  }
}