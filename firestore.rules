/**
 * @fileoverview Firestore Security Rules for the aaura app.
 *
 * Core Philosophy:
 * This ruleset employs a strict user-ownership model for personal data nested under `/users/{userId}`.
 * Top-level collections like `/media`, `/deities`, and `/temples` are designed for broader access,
 * typically with public read access and restricted write access. The rules prioritize simplicity and
 * security, opting for clear ownership checks over complex data validation in this prototyping phase.
 *
 * Data Structure:
 * - User data: `/users/{userId}` and subcollections (e.g., `/contestProgress`, `/badges`, `/bookmarks`).
 * - Public content: `/media`, `/deities`, `/temples`, `/stories`, `/epicHeroes`, `/rituals`, `/festivals`, `/groups`.
 * - Social graph: `/users/{userId}/followers/{followerId}` and `/users/{userId}/following/{followedId}`.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Write permissions on public content are generally restricted to authenticated users.
 * - Data validation is minimal to enable rapid prototyping and will be enhanced in later development phases.
 * - Relational integrity is enforced for user-scoped data (e.g., userId in data must match the path).
 *
 * Denormalization for Authorization:
 * The rules leverage the hierarchical Firestore structure to avoid complex queries. User ownership is
 * determined directly from the path (e.g., `/users/{userId}`), eliminating the need for `get()` calls
 * to verify ownership.
 *
 * Structural Segregation:
 * The platform uses separate collections for public and private data. User-specific information is stored
 * under the `/users/{userId}` path, while public content resides in top-level collections. This segregation
 * enhances security and performance.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for user profile documents. Only the user can read and write their own profile.
     * @path /users/{userId}
     * @allow (read, write) User with ID 'user123' can read/write document 'user123'.
     * @deny (read, write) User with ID 'user123' cannot read/write document 'user456'.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // User listing is not permitted.
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);

      /**
       * @description Rules for user's contest progress. Only the user can read and write their own progress.
       * @path /users/{userId}/contestProgress/{contestId}
       * @allow (read, write) User with ID 'user123' can read/write contest progress 'contest789' under 'user123'.
       * @deny (read, write) User with ID 'user123' cannot read/write contest progress 'contest789' under 'user456'.
       * @principle Enforces document ownership for user contest progress.
       */
      match /contestProgress/{contestId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Rules for user's followers. Only the user can read their own follower list. Writes are denied.
       * @path /users/{userId}/followers/{followerId}
       */
      match /followers/{followerId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Rules for user's following list. Only the user can read their own following list. Writes are denied.
       * @path /users/{userId}/following/{followedId}
       */
      match /following/{followedId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Rules for user's preferences. Only the user can read and write their own preferences.
       * @path /users/{userId}/preferences/default
       */
      match /preferences/default {
        allow get: if isOwner(userId);
        allow list: if false;
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Rules for user's badges. Only the user can read their own badges. Writes are restricted.
       * @path /users/{userId}/badges/{badgeId}
       */
      match /badges/{badgeId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if false; // Badges are likely awarded by the system, not created by the user directly.
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Rules for user's bookmarks. Only the user can read and write their own bookmarks.
       * @path /users/{userId}/bookmarks/{bookmarkId}
       */
      match /bookmarks/{bookmarkId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Rules for user's virtual offerings. Only the user can read and write their own offerings.
       * @path /users/{userId}/virtualOfferings/{offeringId}
       */
      match /virtualOfferings/{offeringId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Rules for user's shopping cart. Only the user can read and write their own cart.
       * @path /users/{userId}/cart/{productId}
       */
      match /cart/{productId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Rules for user's orders. Only the user can read their own orders. Writes are restricted.
       * @path /users/{userId}/orders/{orderId}
       */
      match /orders/{orderId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if false; // Orders are created by the system.
        allow update: if false; // Orders are updated by the system.
        allow delete: if false; // Orders are not typically deleted.
      }

       /**
        * @description Rules for user's playlists. Only the user can read and write their own playlists.
        * @path /users/{userId}/playlists/{playlistId}
        */
      match /playlists/{playlistId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId);
          allow update: if isExistingOwner(userId);
          allow delete: if isExistingOwner(userId);
        }

       /**
        * @description Rules for user's challenge progress. Only the user can read and write their own challenge progress.
        * @path /users/{userId}/challenges/{challengeId}
        */
       match /challenges/{challengeId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId);
          allow update: if isExistingOwner(userId);
          allow delete: if isExistingOwner(userId);
        }

        /**
         * @description Rules for horoscopes specific to a user. Only the user can access their horoscopes.
         * @path /users/{userId}/horoscopes/{horoscopeId}
         */
        match /horoscopes/{horoscopeId} {
            allow get: if isOwner(userId);
            allow list: if isOwner(userId);
            allow create: if false;  // Horoscopes are generated by the system.
            allow update: if false;  // Horoscopes should not be updated directly by users.
            allow delete: if false;  // Horoscopes should not be deleted directly by users.
        }
    }

    /**
     * @description Rules for global chanting contests. Anyone can read contests, logged-in users can write (to be tightened later).
     * @path /contests/{contestId}
     * @allow (read) Any user can read contest details.
     * @allow (write) Logged-in user can create, update, or delete a contest.
     * @principle Public read access with authenticated write access.
     */
    match /contests/{contestId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Rules for media items. Anyone can read media items, logged-in users can write (to be tightened later).
     * @path /media/{mediaId}
     * @allow (read) Any user can read media items.
     * @allow (write) Logged-in user can create, update, or delete a media item.
     * @principle Public read access with authenticated write access.
     */
    match /media/{mediaId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;

       /**
         * @description Rules for comments on media items. Public read, logged-in write.
         * @path /media/{mediaId}/comments/{commentId}
         */
      match /comments/{commentId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
      }

      /**
       * @description Rules for likes on media items. Logged-in users can like an item once.
       * @path /media/{mediaId}/likes/{userId}
       */
      match /likes/{userId} {
          allow get: if isSignedIn();
          allow list: if isSignedIn();
          allow create: if isSignedIn();
          allow update: if false; // Cannot update a like
          allow delete: if isSignedIn() && resource != null;
      }
    }

     /**
      * @description Rules for community challenges. Anyone can read challenges, logged-in users can write (to be tightened later).
      * @path /challenges/{challengeId}
      * @allow (read) Any user can read challenge details.
      */
    match /challenges/{challengeId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Rules for channels. Anyone can read, logged-in write.
     * @path /channels/{channelId}
     */
    match /channels/{channelId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Rules for playlists. Anyone can read, logged-in write.
     * @path /playlists/{playlistId}
     */
    match /playlists/{playlistId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Rules for deities. Anyone can read, logged-in write.
     * @path /deities/{deityId}
     */
    match /deities/{deityId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Rules for shops. Anyone can read, logged-in write.
     * @path /shops/{shopId}
     */
    match /shops/{shopId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Rules for products. Anyone can read, logged-in write.
     * @path /products/{productId}
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Rules for temples. Anyone can read, logged-in write.
     * @path /temples/{templeId}
     */
    match /temples/{templeId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;

      /**
       * @description Rules for temple reviews. Anyone can read, logged-in write.
       * @path /temples/{templeId}/reviews/{reviewId}
       */
      match /reviews/{reviewId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
      }

      /**
       * @description Rules for temple posts. Anyone can read, logged-in write.
       * @path /temples/{templeId}/posts/{postId}
       */
      match /posts/{postId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
      }
    }

     /**
      * @description Rules for stories. Anyone can read, logged-in write.
      * @path /stories/{storyId}
      */
    match /stories/{storyId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Rules for epic heroes. Anyone can read, logged-in write.
     * @path /epicHeroes/{heroId}
     */
    match /epicHeroes/{heroId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Rules for rituals. Anyone can read, logged-in write.
     * @path /rituals/{ritualId}
     */
    match /rituals/{ritualId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Rules for panchang. Anyone can read, logged-in write.
     * @path /panchang/{date}
     */
    match /panchang/{date} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Rules for festivals. Anyone can read, logged-in write.
     * @path /festivals/{festivalId}
     */
    match /festivals/{festivalId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Rules for groups. Anyone can read, logged-in write.
     * @path /groups/{groupId}
     */
    match /groups/{groupId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;

        /**
         * @description Rules for group members. Users can only create/delete their own membership record.
         * @path /groups/{groupId}/members/{userId}
         */
        match /members/{userId} {
            allow get: if true;  // Anyone can check who is a member
            allow list: if false; // Prevent listing all members (privacy)
            allow create: if isOwner(userId); // A user can add themselves
            allow update: if false; // Membership cannot be updated.
            allow delete: if isOwner(userId) && resource != null; // A user can remove themselves
        }
    }

    /**
     * @description Rules for posts. Anyone can read, logged-in write.
     * @path /posts/{postId}
     */
    match /posts/{postId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;

        /**
         * @description Rules for comments on posts. Public read, logged-in write.
         * @path /posts/{postId}/comments/{commentId}
         */
        match /comments/{commentId} {
            allow get: if true;
            allow list: if true;
            allow create: if isSignedIn();
            allow update: if isSignedIn() && resource != null;
            allow delete: if isSignedIn() && resource != null;
        }

        /**
         * @description Rules for likes on posts.  Logged-in users can like an item once.
         * @path /posts/{postId}/likes/{userId}
         */
        match /likes/{userId} {
            allow get: if isSignedIn();
            allow list: if isSignedIn();
            allow create: if isSignedIn();
            allow update: if false; // Cannot update a like
            allow delete: if isSignedIn() && resource != null;
        }
    }

    /**
     * @description Rules for manifestations. Anyone can read, logged-in write.
     * @path /manifestations/{manifestationId}
     */
    match /manifestations/{manifestationId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;

      /**
       * @description Rules for comments on manifestations. Public read, logged-in write.
       * @path /manifestations/{manifestationId}/comments/{commentId}
       */
      match /comments/{commentId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
      }

      /**
       * @description Rules for likes on manifestations. Logged-in users can like an item once.
       * @path /manifestations/{manifestationId}/likes/{userId}
       */
      match /likes/{userId} {
          allow get: if isSignedIn();
          allow list: if isSignedIn();
          allow create: if isSignedIn();
          allow update: if false; // Cannot update a like
          allow delete: if isSignedIn() && resource != null;
      }
    }

    /**
     * @description Generic rules for any other collection. Public read, logged-in write.
     * @path /{collectionName}/{docId}
     * @allow (read) Any user can read any document.
     * @allow (write) Logged-in user can create, update, or delete any document.
     * @principle Public read access with authenticated write access.  This is a fallback.
     */
    match /{collectionName}/{docId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }
  }
}