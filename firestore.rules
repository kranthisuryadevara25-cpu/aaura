/**
 * @fileoverview Firestore Security Rules for the aaura app.
 *
 * Core Philosophy:
 * This ruleset prioritizes user data ownership and content access control.
 * Users have full control over their profile data and preferences. Public content
 * (e.g., media, deities, temples) is readable by everyone, but write access
 * is restricted.  Likes are handled as subcollections for scalability.
 *
 * Data Structure:
 * - User-specific data is nested under `/users/{userId}`.
 * - Public content resides in top-level collections like `/media`, `/deities`, and `/temples`.
 * - Likes are stored in subcollections like `/media/{mediaId}/likes/{userId}`.
 *
 * Key Security Decisions:
 * - Users can only read and write their own user data.
 * - Listing of users is disallowed.
 * - Public content is generally readable, but writes are restricted.
 * - Data validation is limited to fields critical for authorization.
 * - Subcollections of shared documents inherit the parent's access control.
 *
 * Denormalization for Authorization:
 * To avoid costly `get()` calls, authorization-critical data (e.g., owner IDs) should be
 * denormalized directly onto the documents being secured. For example, the `Post` entity
 * has an `authorId` field.
 *
 * Structural Segregation:
 * Private user data is stored under `/users/{userId}`, while public content
 * is stored in top-level collections. This avoids the need for complex rules
 * based on boolean flags (e.g., `isPublic`).
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    // Users Collection
    /**
     * @description Manages user profiles.
     * @path /users/{userId}
     * @allow (create) - User with matching userId creates their profile.
     * @allow (get, update, delete) - User with matching userId accesses their profile.
     * @deny (create) - User attempts to create a profile with a mismatched userId.
     * @deny (get, update, delete) - Another user attempts to access this user's profile.
     * @principle Enforces document ownership for writes and reads.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Listing users is not permitted.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id; // Enforce immutability of user ID
      allow delete: if isExistingOwner(userId);
    }

    // Followers subcollection
    /**
     * @description Manages the followers of a user.
     * @path /users/{userId}/followers/{followerId}
     * @allow (create) - A user can follow another user by creating a document with their userId as the document ID.
     * @allow (get, list) - The owner can read their followers.
     * @deny (create) - A user cannot create a follow document with mismatched user IDs.
     * @deny (update, delete) - Follow relationships are created/deleted, not updated.
     * @principle Enforces document ownership for reads and prevents updates.
     */
    match /users/{userId}/followers/{followerId} {
        allow get, list: if isOwner(userId);
        allow create: if isSignedIn(); // Any signed-in user can create a follow relationship
        allow update, delete: if false;
    }

    // Following subcollection
    /**
     * @description Manages the users a user is following.
     * @path /users/{userId}/following/{followedId}
     * @allow (create) - A user can follow another user by creating a document with their userId as the document ID.
     * @allow (get, list) - The owner can read the list of people they are following.
     * @deny (create) - A user cannot create a follow document with mismatched user IDs.
     * @deny (update, delete) - Follow relationships are created/deleted, not updated.
     * @principle Enforces document ownership for reads and prevents updates.
     */
    match /users/{userId}/following/{followedId} {
        allow get, list: if isOwner(userId);
        allow create: if isSignedIn(); // Any signed-in user can create a follow relationship
        allow update, delete: if false;
    }


    // Preferences Collection (Singleton)
    /**
     * @description Manages user preferences.
     * @path /users/{userId}/preferences/default
     * @allow (get, update) - User with matching userId accesses their preferences.
     * @allow (create) - User with matching userId creates their preferences.
     * @deny (get, update) - Another user attempts to access this user's preferences.
     * @principle Enforces document ownership for writes and reads.
     */
    match /users/{userId}/preferences/default {
      allow get, update, create: if isOwner(userId);
      allow list, delete: if false;
    }

    // Badges Collection
    /**
     * @description Manages gamification badges awarded to users.
     * @path /users/{userId}/badges/{badgeId}
     * @allow (get, list) - User with matching userId accesses their badges.
     * @deny (create, update, delete) - Badges are awarded by the system, not directly created/modified by users.
     * @principle Enforces document ownership for reads, restricts writes.
     */
    match /users/{userId}/badges/{badgeId} {
      allow get, list: if isOwner(userId);
      allow create, update, delete: if false;
    }

    // Bookmarks Collection
    /**
     * @description Manages user bookmarks for temples.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (get, list, create, delete) - User with matching userId accesses their bookmarks.
     * @deny (update) - Bookmarks are created/deleted, not updated.
     * @principle Enforces document ownership for writes and reads, restricts updates.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get, list, create, delete: if isOwner(userId);
      allow update: if false;
    }

    // Virtual Offerings Collection
    /**
     * @description Manages user interactions in the virtual pooja room.
     * @path /users/{userId}/virtualOfferings/{offeringId}
     * @allow (get, list, create) - User with matching userId creates offerings.
     * @deny (update, delete) - Offerings are typically created, not updated/deleted by user.
     * @principle Enforces document ownership for creates, restricts updates and deletes.
     */
    match /users/{userId}/virtualOfferings/{offeringId} {
      allow get, list, create: if isOwner(userId);
      allow update, delete: if false;
    }

    // Cart Items Collection
    /**
     * @description Manages items in a user's shopping cart.
     * @path /users/{userId}/cart/{productId}
     * @allow (get, list, create, update, delete) - User with matching userId manages their cart.
     * @principle Enforces document ownership for writes and reads.
     */
    match /users/{userId}/cart/{productId} {
        allow get, list, create, update, delete: if isOwner(userId);
    }

    // Orders Collection
    /**
     * @description Manages a user's past orders.
     * @path /users/{userId}/orders/{orderId}
     * @allow (get, list) - User with matching userId views their orders.
     * @deny (create, update, delete) - Orders are created by the system.
     * @principle Enforces document ownership for reads, restricts writes.
     */
    match /users/{userId}/orders/{orderId} {
        allow get, list: if isOwner(userId);
        allow create, update, delete: if false;
    }

    // Playlists Collection (References Only)
    /**
     * @description Manages references to playlists created by a user.
     * @path /users/{userId}/playlists/{playlistId}
     * @allow (get, list, create) - User with matching userId manages their playlist references.
     * @deny (update, delete) - Playlist references are created/deleted, not updated.
     * @principle Enforces document ownership for writes and reads.
     */
    match /users/{userId}/playlists/{playlistId} {
      allow get, list, create: if isOwner(userId);
      allow update, delete: if false;
    }

    // User Challenge Progress Collection
    /**
     * @description Tracks user progress in community challenges.
     * @path /users/{userId}/challenges/{challengeId}
     * @allow (get, list, create, update) - User with matching userId manages their challenge progress.
     * @deny (delete) - Challenges progress is created/updated.
     * @principle Enforces document ownership for writes and reads.
     */
    match /users/{userId}/challenges/{challengeId} {
      allow get, list, create, update: if isOwner(userId);
      allow delete: if false;
    }

    // Media Collection
    /**
     * @description Manages all media on the platform.
     * @path /media/{mediaId}
     * @allow (get, list) - Public read access.
     * @allow (create) - Only the media owner can create a media item.
     * @allow (update, delete) - Only the media owner can update or delete a media item.
     * @deny (create) - Another user attempts to create a media item with this user's userId.
     * @deny (update, delete) - Another user attempts to update or delete this media item.
     * @principle Public read access with owner-only writes.
     */
    match /media/{mediaId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if isExistingOwner(resource.data.userId);
        allow delete: if isExistingOwner(resource.data.userId);
    }

    // Media Comments Collection
    /**
     * @description Manages comments for a specific media item.
     * @path /media/{mediaId}/comments/{commentId}
     * @allow (get, list, create) - Any signed-in user can read/create comments.
     * @allow (update, delete) - Only the comment owner can update/delete their comment.
     * @principle Signed-in users can comment; owners can manage their comments.
     */
    match /media/{mediaId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }
    
     // Media Likes Collection
    /**
     * @description Manages likes for a specific media item.
     * @path /media/{mediaId}/likes/{userId}
     * @allow (get, list, create, delete) - Any signed-in user can like/unlike media.
     * @deny (update) - Likes are created/deleted, not updated.
     * @principle Signed-in users can like, and delete their like.
     */
    match /media/{mediaId}/likes/{userId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if isSignedIn() && request.auth.uid == userId;
    }

    // Channels Collection
    /**
     * @description Manages all channels on the platform.
     * @path /channels/{channelId}
     * @allow (get, list) - Public read access.
     * @allow (create) - Only the channel owner (user) can create a channel.
     * @allow (update, delete) - Only the channel owner can update or delete a channel.
     * @principle Public read access with owner-only writes.
     */
    match /channels/{channelId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid && request.resource.data.id == request.auth.uid; //Also force channelId == userId
        allow update: if isExistingOwner(resource.data.userId);
        allow delete: if isExistingOwner(resource.data.userId);
    }

    // Playlists Collection
    /**
     * @description Manages all public or user-created playlists.
     * @path /playlists/{playlistId}
     * @allow (get, list) - Public read access.
     * @allow (create) - Only the playlist creator can create a playlist.
     * @allow (update, delete) - Only the playlist creator can update or delete a playlist.
     */
    match /playlists/{playlistId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.creatorId == request.auth.uid;
        allow update: if isExistingOwner(resource.data.creatorId);
        allow delete: if isExistingOwner(resource.data.creatorId);
    }

    // Horoscopes Collection
    /**
     * @description Manages horoscopes generated for users.
     * @path /users/{userId}/horoscopes/{horoscopeId}
     * @allow (get, list) - User with matching userId accesses their horoscopes.
     * @deny (create, update, delete) - Horoscopes are generated by the system, not directly created/modified by users.
     * @principle Enforces document ownership for reads, restricts writes.
     */
    match /users/{userId}/horoscopes/{horoscopeId} {
      allow get, list: if isOwner(userId);
      allow create, update, delete: if false;
    }

    // Deities Collection
    /**
     * @description Manages information about Hindu deities.
     * @path /deities/{deityId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - Deity data is managed by the platform.
     * @principle Public read access, restricted writes.
     */
    match /deities/{deityId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    // Shops Collection
    /**
     * @description Manages all shops for the marketplace.
     * @path /shops/{shopId}
     * @allow (get, list) - Public read access.
     * @allow (create) - Only the shop owner can create a shop.
     * @allow (update, delete) - Only the shop owner can update or delete a shop.
     * @principle Public read access with owner-only writes.
     */
    match /shops/{shopId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
        allow update: if isExistingOwner(resource.data.ownerId);
        allow delete: if isExistingOwner(resource.data.ownerId);
    }

    // Products Collection
    /**
     * @description Manages all products for the marketplace.
     * @path /products/{productId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - Products are managed by shop owners.
     * @principle Public read access, restricted writes.
     */
    match /products/{productId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    // Temples Collection
    /**
     * @description Manages all temple and pilgrimage data.
     * @path /temples/{templeId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - Temple data is managed by the platform.
     * @principle Public read access, restricted writes.
     */
    match /temples/{templeId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    // Temple Reviews Collection
    /**
     * @description Manages user reviews for a specific temple.
     * @path /temples/{templeId}/reviews/{reviewId}
     * @allow (get, list, create) - Any signed-in user can create reviews.
     * @allow (update, delete) - Only the review owner can update or delete.
     * @principle Signed-in users can review; owners can manage their reviews.
     */
    match /temples/{templeId}/reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }
      // Temples Posts Collection
    /**
     * @description Manages user posts for a specific temple.
     * @path /temples/{templeId}/posts/{postId}
     * @allow (get, list, create) - Any signed-in user can create post.
     * @allow (update, delete) - Only the post owner can update or delete.
     * @principle Signed-in users can post; owners can manage their posts.
     */
    match /temples/{templeId}/posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    // Stories Collection
    /**
     * @description Manages mythological stories.
     * @path /stories/{storyId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - Stories are managed by the platform.
     * @principle Public read access, restricted writes.
     */
    match /stories/{storyId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    // Epic Heroes Collection
    /**
     * @description Manages mythological heroes and characters.
     * @path /epicHeroes/{heroId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - Heroes are managed by the platform.
     * @principle Public read access, restricted writes.
     */
    match /epicHeroes/{heroId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

   // Rituals Collection
    /**
     * @description Manages guidelines for various rituals and poojas.
     * @path /rituals/{ritualId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - Rituals are managed by the platform.
     * @principle Public read access, restricted writes.
     */
    match /rituals/{ritualId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    // Panchang Collection
    /**
     * @description Manages daily panchang data.
     * @path /panchang/{date}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - Panchang data is managed by the platform.
     * @principle Public read access, restricted writes.
     */
    match /panchang/{date} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    // Festivals Collection
    /**
     * @description Manages details about cultural and religious festivals.
     * @path /festivals/{festivalId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - Festivals are managed by the platform.
     * @principle Public read access, restricted writes.
     */
    match /festivals/{festivalId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    // Groups Collection
    /**
     * @description Manages community groups.
     * @path /groups/{groupId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - Groups data is managed by the platform.
     * @principle Public read access, restricted writes.
     */
    match /groups/{groupId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    // Groups Members Collection
    /**
     * @description Manages members of a group.
     * @path /groups/{groupId}/members/{userId}
     * @allow (get, list) - Group members can view other members.
     * @allow (create) - Signed-in users can join groups.
     * @allow (delete) - Signed-in users can leave groups.
     * @deny (update) - Membership is managed through create/delete.
     * @principle Shared Access (Closed Collaborators)
     */
    match /groups/{groupId}/members/{userId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if isSignedIn() && request.auth.uid == userId;
    }

     // Posts Collection
    /**
     * @description Manages posts within a specific group.
     * @path /posts/{postId}
     * @allow (get, list) - Public read access.
     * @allow (create) - Signed-in user can create a post with matching authorId
     * @allow (update, delete) - Only the post owner can update or delete their post.
     * @principle Signed-in users can post; owners can manage their posts.
     */
    match /posts/{postId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
        allow update: if isExistingOwner(resource.data.authorId);
        allow delete: if isExistingOwner(resource.data.authorId);
    }

      // Posts Comments Collection
    /**
     * @description Manages comments for a specific post within a group.
     * @path /posts/{postId}/comments/{commentId}
     * @allow (get, list, create) - Any signed-in user can create comments.
     * @allow (update, delete) - Only the comment owner can update or delete.
     * @principle Signed-in users can comment; owners can manage their comments.
     */
    match /posts/{postId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    // Posts Likes Collection
    /**
     * @description Manages likes for a specific forum post within a group.
     * @path /posts/{postId}/likes/{userId}
     * @allow (get, list, create, delete) - Any signed-in user can like/unlike posts.
     * @deny (update) - Likes are created/deleted, not updated.
     * @principle Signed-in users can like, and delete their like.
     */
    match /posts/{postId}/likes/{userId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if isSignedIn() && request.auth.uid == userId;
    }

    // Challenges Collection
    /**
     * @description Manages community challenges.
     * @path /challenges/{challengeId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - Challenges are managed by the platform.
     * @principle Public read access, restricted writes.
     */
    match /challenges/{challengeId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    // Manifestations Collection
    /**
     * @description Manages user-submitted manifestation techniques and stories.
     * @path /manifestations/{manifestationId}
     * @allow (get, list) - Public read access.
     * @allow (create) - Signed-in user can create with matching userId
     * @allow (update, delete) - Only the post owner can update or delete their post.
     * @principle Signed-in users can manifest; owners can manage their posts.
     */
    match /manifestations/{manifestationId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if isExistingOwner(resource.data.userId);
        allow delete: if isExistingOwner(resource.data.userId);
    }

        // Manifestations Comments Collection
    /**
     * @description Manages comments on a manifestation post.
     * @path /manifestations/{manifestationId}/comments/{commentId}
     * @allow (get, list, create) - Any signed-in user can create comments.
     * @allow (update, delete) - Only the comment owner can update or delete.
     * @principle Signed-in users can comment; owners can manage their comments.
     */
    match /manifestations/{manifestationId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }
    
    // Manifestations Likes Collection
    /**
     * @description Manages likes for a manifestation post.
     * @path /manifestations/{manifestationId}/likes/{userId}
     * @allow (get, list, create, delete) - Any signed-in user can like/unlike.
     * @deny (update) - Likes are created/deleted, not updated.
     * @principle Signed-in users can like, and delete their like.
     */
    match /manifestations/{manifestationId}/likes/{userId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if isSignedIn() && request.auth.uid == userId;
    }
  }
}