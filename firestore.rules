rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSuperAdmin(userId) {
        return exists(/databases/$(database)/documents/admins/$(userId));
    }

    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;

      match /groups/{groupId} {
          allow read: if true;
          allow create: if request.auth != null && request.auth.uid == userId && request.resource.data.groupId == groupId && exists(/databases/$(database)/documents/groups/$(groupId));
          allow delete: if request.auth != null && request.auth.uid == userId;
      }
      match /cart/{productId} {
          allow read, write, delete: if request.auth != null && request.auth.uid == userId;
      }
      match /horoscopes/{docId} {
           allow read, write, delete: if request.auth != null && request.auth.uid == userId;
      }
       match /badges/{docId} {
           allow read, write, delete: if request.auth != null && request.auth.uid == userId;
      }
      match /preferences/{docId} {
           allow read, write, delete: if request.auth != null && request.auth.uid == userId;
      }
    }

    match /media/{mediaId} {
      allow read: if true;
      // Allow create for any authenticated user
      allow create: if request.auth != null;
      // Allow update/delete only for the user who created it or a superadmin
      allow update, delete: if request.auth != null && (resource.data.userId == request.auth.uid || isSuperAdmin(request.auth.uid));

       match /comments/{commentId} {
        allow read: if true;
        allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
        allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;
      }
       match /likes/{userId} {
        allow read: if true;
        allow write, delete: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    match /channels/{channelId} {
        allow read: if true;
        allow create: if request.auth != null && request.auth.uid == channelId;
        allow update: if request.auth != null && request.auth.uid == channelId;
    }
    
     match /playlists/{playlistId} {
        allow read: if resource.data.isPublic == true || (request.auth != null && resource.data.creatorId == request.auth.uid);
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null && resource.data.creatorId == request.auth.uid;
    }

    match /posts/{postId} {
        allow read: if true;
        allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
        allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;
        
        match /comments/{commentId} {
            allow read: if true;
            allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
            allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;
        }

        match /likes/{userId} {
            allow read: if true;
            allow write, delete: if request.auth != null && request.auth.uid == userId;
        }
    }
    
    match /groups/{groupId} {
        allow read: if true;
        allow create: if request.auth != null;
    }

    match /stories/{storyId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null && isSuperAdmin(request.auth.uid);
    }
    
    match /temples/{templeId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null && isSuperAdmin(request.auth.uid);
    }
    
     match /deities/{deityId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null && isSuperAdmin(request.auth.uid);
    }

     match /epicHeroes/{heroId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null && isSuperAdmin(request.auth.uid);
    }
    
    match /products/{productId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null && isSuperAdmin(request.auth.uid);
    }
    
     match /orders/{orderId} {
      allow read, write: if request.auth != null && isSuperAdmin(request.auth.uid);
      allow create: if request.auth != null;
    }
    
    match /contests/{contestId} {
        allow read: if true;
        allow create, update, delete: if request.auth != null && isSuperAdmin(request.auth.uid);
        
        match /chants/{chantId} {
            allow read: if true;
            allow create: if request.auth != null;
        }
    }
    
     match /manifestations/{manifestationId} {
        allow read: if true;
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
        allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
        match /comments/{commentId} {
            allow read: if true;
            allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
            allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;
        }
        match /likes/{userId} {
            allow read: if true;
            allow write: if request.auth != null && request.auth.uid == userId;
        }
    }
  }
}
