/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a user-ownership model for private user data,
 * allows public read access to certain collections, and uses role-based access
 * control for managing group memberships.
 *
 * Data Structure:
 * - User-specific data is nested under `/users/{userId}`.
 * - Public content resides in top-level collections like `/media`, `/deities`, `/temples`, etc.
 * - Group memberships are tracked in `/groups/{groupId}/members/{userId}`.
 * - Likes are modeled as subcollections on content items (e.g., `/media/{mediaId}/likes/{userId}`).
 *
 * Key Security Decisions:
 * - Users can only access their own data under `/users/{userId}`.
 * - Listing of users is disallowed for privacy.
 * - Public read access is granted to certain content collections.
 * - Group membership is managed through the `groups/{groupId}/members/{userId}` collection.
 * - Orders are stored globally in the `/orders` collection, but write access is not currently defined (TODO).
 *
 * Denormalization for Authorization:
 * To avoid costly `get()` calls, authorization decisions are based on data
 * directly available within the documents being secured.
 * For example, ownership is determined by matching `request.auth.uid`
 * against an `ownerId` field within the document.
 *
 * Structural Segregation:
 * Private user data is stored under `/users/{userId}`, while public content
 * is stored in top-level collections. This separation simplifies security rules
 * and improves performance for list operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided user ID.
     * @param {string} userId - The user ID to compare against.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of an existing document.
     * @param {string} userId - The user ID to compare against.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces document ownership for writes.
     * @path /users/{userId}
     * @allow (create) - A user can create their own profile if their auth UID matches the document ID.
     * @allow (update, delete) - A user can update or delete their own profile.
     * @deny (create) - A user cannot create a profile for another user.
     * @deny (update, delete) - A user cannot update or delete another user's profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if false;
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Tracks a user's progress in a specific contest.
     * @path /users/{userId}/contestProgress/{contestId}
     * @allow (create) - A user can create their own contest progress if their auth UID matches the userId.
     * @allow (update, delete) - A user can update or delete their own contest progress.
     * @deny (create) - A user cannot create contest progress for another user.
     * @deny (update, delete) - A user cannot update or delete another user's contest progress.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/contestProgress/{contestId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description A subcollection storing the users who are following this user.
     * @path /users/{userId}/followers/{followerId}
     * @allow (create) - A user can create a follow relationship if the userId matches the path.
     * @allow (delete) - A user can delete a follow relationship if the userId matches the path.
     * @deny (create) - A user cannot create a follow relationship for another user.
     * @deny (delete) - A user cannot delete another user's follow relationship.
     * @principle Enforces document ownership for writes.
     */
     match /users/{userId}/followers/{followerId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if request.auth.uid == followerId;
        allow update: if false;
        allow delete: if request.auth.uid == followerId;
     }

    /**
     * @description A subcollection storing the users this user is following.
     * @path /users/{userId}/following/{followedId}
     * @allow (create) - A user can create a following relationship if their auth UID matches the userId.
     * @allow (delete) - A user can delete a following relationship if their auth UID matches the userId.
     * @deny (create) - A user cannot create a following relationship for another user.
     * @deny (delete) - A user cannot delete another user's following relationship.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/following/{followedId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if false;
        allow delete: if isOwner(userId);
    }

    /**
     * @description Stores user preferences, using a singleton document 'default'.
     * @path /users/{userId}/preferences/default
     * @allow (create) - A user can create their own preferences if their auth UID matches the userId.
     * @allow (update, delete) - A user can update or delete their own preferences.
     * @deny (create) - A user cannot create preferences for another user.
     * @deny (update, delete) - A user cannot update or delete another user's preferences.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/preferences/default {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores gamification badges awarded to the user.
     * @path /users/{userId}/badges/{badgeId}
     * @allow (create) - A user can create their own badge if their auth UID matches the userId.
     * @allow (update, delete) - A user can update or delete their own badge.
     * @deny (create) - A user cannot create a badge for another user.
     * @deny (update, delete) - A user cannot update or delete another user's badge.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/badges/{badgeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if false; // Badges are likely awarded server-side.
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores user bookmarks for temples.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (create) - A user can create their own bookmark if their auth UID matches the userId.
     * @allow (update, delete) - A user can update or delete their own bookmark.
     * @deny (create) - A user cannot create a bookmark for another user.
     * @deny (update, delete) - A user cannot update or delete another user's bookmark.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores a user's interactions in the virtual pooja room.
     * @path /users/{userId}/virtualOfferings/{offeringId}
     * @allow (create) - A user can create their own offering if their auth UID matches the userId.
     * @allow (update, delete) - A user can update or delete their own offering.
     * @deny (create) - A user cannot create an offering for another user.
     * @deny (update, delete) - A user cannot update or delete another user's offering.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/virtualOfferings/{offeringId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores items in a user's shopping cart.
     * @path /users/{userId}/cart/{productId}
     * @allow (create) - A user can add items to their cart if their auth UID matches the userId.
     * @allow (update, delete) - A user can update or delete items in their cart.
     * @deny (create) - A user cannot add items to another user's cart.
     * @deny (update, delete) - A user cannot update or delete another user's cart.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/cart/{productId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores all user orders globally for easier admin access.
     * @path /orders/{orderId}
     * @allow (create, update, delete) - Currently not implemented, add later depending on the specific requirements.
     * @deny (create, update, delete) - No write permissions granted to the public by default.
     */
    match /orders/{orderId} {
      allow get: if false; //For now, prevent access.
      allow list: if false; //For now, prevent access.
      allow create: if false; // TODO: Add order creation logic.
      allow update: if false; // TODO: Add order update logic.
      allow delete: if false; // TODO: Add order cancellation logic.
    }

    /**
     * @description Reference to playlists created by the user.
     * @path /users/{userId}/playlists/{playlistId}
     * @allow (create) - A user can create their own playlist reference if their auth UID matches the userId.
     * @allow (update, delete) - A user can update or delete their own playlist reference.
     * @deny (create) - A user cannot create a playlist reference for another user.
     * @deny (update, delete) - A user cannot update or delete another user's playlist reference.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/playlists/{playlistId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

     /**
      * @description Tracks user progress in community challenges.
      * @path /users/{userId}/challenges/{challengeId}
      * @allow (create) - A user can create their own challenge progress if their auth UID matches the userId.
      * @allow (update, delete) - A user can update or delete their own challenge progress.
      * @deny (create) - A user cannot create challenge progress for another user.
      * @deny (update, delete) - A user cannot update or delete another user's challenge progress.
      * @principle Enforces document ownership for writes.
      */
    match /users/{userId}/challenges/{challengeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores all media on the platform (videos, audio, etc.).
     * @path /media/{mediaId}
     * @allow (get, list) - Anyone can read media.
     *
     * @description CRITICAL: Cannot implement owner-only writes. The 'Media' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /media/{mediaId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores comments for a specific media item.
     * @path /media/{mediaId}/comments/{commentId}
     * @allow (create) - Any signed-in user can comment on media.
     * @allow (read, list) - Anyone can read comments.
     * @deny (update, delete) - Only the author can edit or delete.
     */
    match /media/{mediaId}/comments/{commentId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if false; // TODO: Add author validation.
        allow delete: if false; // TODO: Add author validation.
    }

    /**
     * @description Stores likes for a specific media item.
     * @path /media/{mediaId}/likes/{userId}
     * @allow (create) - A user can like media if their auth UID matches the userId.
     * @allow (delete) - A user can unlike media if their auth UID matches the userId.
     * @deny (create) - A user cannot like media for another user.
     * @deny (delete) - A user cannot unlike media for another user.
     * @principle Enforces document ownership for writes.
     */
    match /media/{mediaId}/likes/{userId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update: if false;
        allow delete: if isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Stores all channels on the platform.
     * @path /channels/{channelId}
     *
     * @description CRITICAL: Cannot implement owner-only writes. The 'Channel' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /channels/{channelId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores all public or user-created playlists.
     * @path /playlists/{playlistId}
     *
     * @description CRITICAL: Cannot implement owner-only writes. The 'Playlist' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /playlists/{playlistId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores horoscopes generated for users.
     * @path /users/{userId}/horoscopes/{horoscopeId}
     * @allow (create) - A user can create their own horoscope if their auth UID matches the userId.
     * @allow (update, delete) - A user can update or delete their own horoscope.
     * @deny (create) - A user cannot create a horoscope for another user.
     * @deny (update, delete) - A user cannot update or delete another user's horoscope.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/horoscopes/{horoscopeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if false; //Horoscopes are likely created server-side.
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores information about Hindu deities.
     * @path /deities/{deityId}
     */
    match /deities/{deityId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores all shops for the marketplace.
     * @path /shops/{shopId}
     *
     * @description CRITICAL: Cannot implement owner-only writes. The 'Shop' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /shops/{shopId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores all products for the marketplace.
     * @path /products/{productId}
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores all temple and pilgrimage data.
     * @path /temples/{templeId}
     */
    match /temples/{templeId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores user reviews for a specific temple.
     * @path /temples/{templeId}/reviews/{reviewId}
     * @allow (create) - Any signed-in user can create a review.
     * @allow (read, list) - Anyone can read reviews.
     * @deny (update, delete) - Only the author can edit or delete.
     */
    match /temples/{templeId}/reviews/{reviewId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if false; // TODO: Add author validation.
        allow delete: if false; // TODO: Add author validation.
    }

    /**
     * @description Stores user posts for a specific temple.
     * @path /temples/{templeId}/posts/{postId}
     * @allow (create) - Any signed-in user can create a post in a temple.
     * @allow (read, list) - Anyone can read posts in temples.
     * @deny (update, delete) - Only the author can edit or delete.
     */
    match /temples/{templeId}/posts/{postId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if false; // TODO: Add author validation.
        allow delete: if false; // TODO: Add author validation.
    }

    /**
     * @description Stores mythological stories.
     * @path /stories/{storyId}
     */
    match /stories/{storyId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores mythological heroes and characters.
     * @path /epicHeroes/{heroId}
     */
    match /epicHeroes/{heroId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores guidelines for various rituals and poojas.
     * @path /rituals/{ritualId}
     */
    match /rituals/{ritualId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores daily panchang data, with the document ID being the date (e.g., '2025-10-05').
     * @path /panchang/{date}
     */
    match /panchang/{date} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores details about cultural and religious festivals.
     * @path /festivals/{festivalId}
     */
    match /festivals/{festivalId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores community groups.
     * @path /groups/{groupId}
     * @allow (create) - Any signed-in user can create a group.
     * @allow (read, list) - Anyone can read/list groups.
     * @deny (update, delete) - No public updates or deletes allowed.
     */
    match /groups/{groupId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if false;
    }

    /**
     * @description Subcollection to track members of a group.
     * @path /groups/{groupId}/members/{userId}
     * @allow (create) - A user can join a group if their auth UID matches the userId.
     * @allow (delete) - A user can leave a group if their auth UID matches the userId.
     * @deny (create) - A user cannot add another user to a group.
     * @deny (delete) - A user cannot remove another user from a group.
     * @principle Enforces document ownership for writes.
     */
    match /groups/{groupId}/members/{userId} {
        allow get: if true; // can list group members.
        allow list: if true; // can list group members.
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update: if false;
        allow delete: if isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Stores posts within a specific group.
     * @path /posts/{postId}
     * @allow (create) - Any signed-in user can create a post in a group.
     * @allow (read, list) - Anyone can read posts in groups.
     * @deny (update, delete) - Only the author can edit or delete.
     */
    match /posts/{postId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if false; // TODO: Add author validation.
        allow delete: if false; // TODO: Add author validation.
    }

    /**
     * @description Stores comments for a specific post within a group.
     * @path /posts/{postId}/comments/{commentId}
     * @allow (create) - Any signed-in user can comment on a post.
     * @allow (read, list) - Anyone can read comments on posts.
     * @deny (update, delete) - Only the author can edit or delete their own comments.
     */
    match /posts/{postId}/comments/{commentId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if false; // TODO: Add author validation.
        allow delete: if false; // TODO: Add author validation.
    }

    /**
     * @description Stores likes for a specific forum post within a group.
     * @path /posts/{postId}/likes/{userId}
     * @allow (create) - A user can like a post if their auth UID matches the userId.
     * @allow (delete) - A user can unlike a post if their auth UID matches the userId.
     * @deny (create) - A user cannot like a post for another user.
     * @deny (delete) - A user cannot unlike a post for another user.
     * @principle Enforces document ownership for writes.
     */
     match /posts/{postId}/likes/{userId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update: if false;
        allow delete: if isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Stores community challenges.
     * @path /challenges/{challengeId}
     */
    match /challenges/{challengeId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores global chanting contests.
     * @path /contests/{contestId}
     */
    match /contests/{contestId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores user-submitted manifestation techniques and stories.
     * @path /manifestations/{manifestationId}
     *
     * @description CRITICAL: Cannot implement owner-only writes. The 'Manifestation' entity is missing an 'ownerId' or 'authorId' field.
     */
    match /manifestations/{manifestationId} {
        allow get: if true;
        allow list: if true;
        allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores comments on a manifestation post.
     * @path /manifestations/{manifestationId}/comments/{commentId}
     * @allow (create) - Any signed-in user can comment on a manifestation post.
     * @allow (read, list) - Anyone can read comments on manifestation posts.
     */
    match /manifestations/{manifestationId}/comments/{commentId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if false;
    }

    /**
     * @description Stores likes for a manifestation post.
     * @path /manifestations/{manifestationId}/likes/{userId}
     * @allow (create) - A user can like a manifestation post if their auth UID matches the userId.
     * @allow (delete) - A user can unlike a manifestation post if their auth UID matches the userId.
     * @principle Enforces document ownership for writes.
     */
    match /manifestations/{manifestationId}/likes/{userId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update: if false;
        allow delete: if isSignedIn() && request.auth.uid == userId;
    }
  }
}