/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for personal data while allowing public read access to certain collections.
 *
 * Data Structure:
 * - User-specific data is nested under `/users/{userId}`.
 * - Public content (e.g., media, deities, temples) resides in top-level collections.
 * - Likes and other interactions are modeled as subcollections for scalability.
 *
 * Key Security Decisions:
 * - Users can only access their own data under `/users/{userId}`.
 * - Public read access is granted for collections like `/media`, `/deities`, `/temples`.
 * - Write access to public collections is restricted to ensure data integrity.
 * - Listing all users is disallowed for privacy.
 *
 * Denormalization for Authorization:
 * - For improved security and performance, resource ownership is enforced via the `isOwner()` function, which checks `request.auth.uid == userId`.
 * - No get() calls are required in the rules, as all necessary data for authorization is either in the path or in the document itself.
 *
 * Structural Segregation:
 * - Private user data (e.g., bookmarks, cart) is stored under `/users/{userId}`, while public content (e.g., temples, deities) is stored in top-level collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     * @param {string} userId - The user ID to compare against.
     * @return {boolean} True if the user is the owner, false otherwise.
     * @example isOwner('someUserId') -> true if request.auth.uid == 'someUserId'
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of an existing resource.
     * @param {string} userId - The user ID of the owner.
     * @return {boolean} True if the user is the owner and the resource exists.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces access control for user profiles.
     * @path /users/{userId}
     * @allow (create) - User 'abc' can create their profile if authenticated as 'abc'.
     * @allow (get, update, delete) - User 'abc' can access and manage their profile if authenticated as 'abc'.
     * @deny (create) - User 'def' cannot create a profile with ID 'abc'.
     * @deny (get, update, delete) - User 'def' cannot access or manage user 'abc's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for user's contest progress.
     * @path /users/{userId}/contestProgress/{contestId}
     * @allow (create, get, update, delete) - User 'abc' can manage their own contest progress if authenticated as 'abc'.
     * @deny (create, get, update, delete) - User 'def' cannot manage user 'abc's contest progress.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/contestProgress/{contestId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for a user's followers.
     * @path /users/{userId}/followers/{followerId}
     * @allow (get, list) - User 'abc' can see their own followers if authenticated as 'abc'.
     * @allow (create) - User 'def' can create a follower document with followerId 'def' to follow 'abc' if authenticated as 'def'.
     * @deny (create) - User 'def' cannot create a follower document with followerId 'ghi' to follow 'abc'.
     * @deny (update, delete) - Only the owner (the follower) can update/delete their follow entry.
     * @deny (get, list) - User 'def' cannot list user 'abc's followers if authenticated as 'def'.
     * @principle Enforces document ownership for writes, owner read for lists.
     */
    match /users/{userId}/followers/{followerId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(followerId);
      allow update: if isExistingOwner(followerId);
      allow delete: if isExistingOwner(followerId);
    }

    /**
     * @description Enforces access control for a user's followings.
     * @path /users/{userId}/following/{followedId}
     * @allow (get, list) - User 'abc' can see who they are following if authenticated as 'abc'.
     * @allow (create) - User 'abc' can create a following document with followedId 'def' if authenticated as 'abc'.
     * @deny (create) - User 'abc' cannot create a following document with followedId 'ghi'.
     * @deny (update, delete) - Only the owner (the follower) can update/delete their follow entry.
     * @deny (get, list) - User 'def' cannot list user 'abc's followings if authenticated as 'def'.
     * @principle Enforces document ownership for writes, owner read for lists.
     */
    match /users/{userId}/following/{followedId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for a user's subscriptions.
     * @path /users/{userId}/subscriptions/{channelId}
     * @allow (get, list) - User 'abc' can see their own subscriptions if authenticated as 'abc'.
     * @allow (create) - User 'abc' can create a subscription document with channelId 'def' if authenticated as 'abc'.
     * @deny (create) - User 'abc' cannot create a subscription document with channelId 'ghi'.
     * @deny (update, delete) - Only the owner (the subscriber) can update/delete their subscription entry.
     * @deny (get, list) - User 'def' cannot list user 'abc's subscriptions if authenticated as 'def'.
     * @principle Enforces document ownership for writes, owner read for lists.
     */
    match /users/{userId}/subscriptions/{channelId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for user preferences.
     * @path /users/{userId}/preferences/default
     * @allow (create, get, update, delete) - User 'abc' can manage their own preferences if authenticated as 'abc'.
     * @deny (create, get, update, delete) - User 'def' cannot manage user 'abc's preferences.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/preferences/default {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for user badges.
     * @path /users/{userId}/badges/{badgeId}
     * @allow (get, list) - User 'abc' can read their own badges if authenticated as 'abc'.
     * @deny (create, update, delete) - Badges are awarded by the system, not created/modified by users directly.
     * @principle Read-only access to user-owned badges.
     */
    match /users/{userId}/badges/{badgeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Enforces access control for user bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (create, get, update, delete) - User 'abc' can manage their own bookmarks if authenticated as 'abc'.
     * @deny (create, get, update, delete) - User 'def' cannot manage user 'abc's bookmarks.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for user virtual offerings.
     * @path /users/{userId}/virtualOfferings/{offeringId}
     * @allow (create, get, update, delete) - User 'abc' can manage their own virtual offerings if authenticated as 'abc'.
     * @deny (create, get, update, delete) - User 'def' cannot manage user 'abc's virtual offerings.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/virtualOfferings/{offeringId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for user's cart items.
     * @path /users/{userId}/cart/{productId}
     * @allow (create, get, update, delete) - User 'abc' can manage their own cart items if authenticated as 'abc'.
     * @deny (create, get, update, delete) - User 'def' cannot manage user 'abc's cart items.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/cart/{productId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for user playlists.
     * @path /users/{userId}/playlists/{playlistId}
     * @allow (create, get, update, delete) - User 'abc' can manage their own playlists if authenticated as 'abc'.
     * @deny (create, get, update, delete) - User 'def' cannot manage user 'abc's playlists.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/playlists/{playlistId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for user challenge progress.
     * @path /users/{userId}/challenges/{challengeId}
     * @allow (create, get, update, delete) - User 'abc' can manage their own challenge progress if authenticated as 'abc'.
     * @deny (create, get, update, delete) - User 'def' cannot manage user 'abc's challenge progress.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/challenges/{challengeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

     /**
     * @description Allows public read access but restricts writes to authorized users.
     * @path /orders/{orderId}
     * @allow (get, list) - Anyone can read order details.
     * @deny (create, update, delete) - Orders can only be created, updated, or deleted via backend functions.
     * @principle Public read, restricted write access.
     */
    match /orders/{orderId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to media, but enforces owner-only writes.
     * @path /media/{mediaId}
     * @allow (get, list) - Anyone can read media details.
     * @allow (create) - User 'abc' can create new media item if request.resource.data.userId == request.auth.uid
     * @allow (update, delete) - User 'abc' can update or delete media if they are the owner.
     * @deny (create) - User 'abc' cannot create new media item if request.resource.data.userId != request.auth.uid
     * @deny (update, delete) - User 'def' cannot update or delete media owned by 'abc'.
     * @principle Public read, owner-only writes.
     */
    match /media/{mediaId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Enforces access control for comments on media items.
     * @path /media/{mediaId}/comments/{commentId}
     * @allow (get, list) - Anyone can read the comments on a media item.
     * @allow (create) - Any signed-in user can create a comment.
     * @allow (update, delete) - Only the comment's author can update or delete it.
     * @principle Public read, owner-only writes.
     */
    match /media/{mediaId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Likes for a media item
     * @path /media/{mediaId}/likes/{userId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn() && request.auth.uid == userId;
     * @allow update, delete: if isExistingOwner(userId);
     */
    match /media/{mediaId}/likes/{userId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to channels, but enforces owner-only writes.
     * @path /channels/{channelId}
     * @allow (get, list) - Anyone can read channel details.
     * @allow (create) - User 'abc' can create a new channel if request.resource.data.userId == request.auth.uid.
     * @allow (update, delete) - User 'abc' can update or delete channel if they are the owner.
     * @deny (create) - User 'abc' cannot create a new channel if request.resource.data.userId != request.auth.uid.
     * @deny (update, delete) - User 'def' cannot update or delete channel owned by 'abc'.
     * @principle Public read, owner-only writes.
     */
    match /channels/{channelId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

      /**
     * @description Subscribers subcollection of a channel
     * @path /channels/{channelId}/subscribers/{userId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn() && request.auth.uid == userId;
     * @allow update, delete: if isExistingOwner(userId);
     */
    match /channels/{channelId}/subscribers/{userId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to playlists, but enforces creator-only writes.
     * @path /playlists/{playlistId}
     * @allow (get, list) - Anyone can read playlist details.
     * @allow (create) - User 'abc' can create playlist if request.resource.data.creatorId == request.auth.uid
     * @allow (update, delete) - User 'abc' can update or delete playlist if they are the creator.
     * @deny (create) - User 'abc' cannot create playlist if request.resource.data.creatorId != request.auth.uid
     * @deny (update, delete) - User 'def' cannot update or delete playlist owned by 'abc'.
     * @principle Public read, creator-only writes.
     */
    match /playlists/{playlistId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.creatorId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.creatorId);
      allow delete: if isExistingOwner(resource.data.creatorId);
    }

    /**
     * @description Enforces access control for user horoscopes.
     * @path /users/{userId}/horoscopes/{horoscopeId}
     * @allow (get, list) - User 'abc' can read their own horoscopes if authenticated as 'abc'.
     * @deny (create, update, delete) - Horoscopes are generated by the system, not created/modified by users directly.
     * @principle Read-only access to user-owned horoscopes.
     */
    match /users/{userId}/horoscopes/{horoscopeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to deities.
     * @path /deities/{deityId}
     * @allow (get, list) - Anyone can read deity details.
     * @deny (create, update, delete) - Deities are managed by admins, not regular users.
     * @principle Public read, restricted write access.
     */
    match /deities/{deityId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to shops, but enforces owner-only writes.
     * @path /shops/{shopId}
     * @allow (get, list) - Anyone can read shop details.
     * @allow (create) - User 'abc' can create a new shop if request.resource.data.ownerId == request.auth.uid.
     * @allow (update, delete) - User 'abc' can update or delete shop if they are the owner.
     * @deny (create) - User 'abc' cannot create a new shop if request.resource.data.ownerId != request.auth.uid.
     * @deny (update, delete) - User 'def' cannot update or delete shop owned by 'abc'.
     * @principle Public read, owner-only writes.
     */
    match /shops/{shopId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.ownerId);
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Allows public read access to products.
     * @path /products/{productId}
     * @allow (get, list) - Anyone can read product details.
     * @deny (create, update, delete) - Products are managed by shop owners.
     * @principle Public read, restricted write access.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to temples.
     * @path /temples/{templeId}
     * @allow (get, list) - Anyone can read temple details.
     * @deny (create, update, delete) - Temples are managed by admins, not regular users.
     * @principle Public read, restricted write access.
     */
    match /temples/{templeId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Enforces access control for reviews on temples.
     * @path /temples/{templeId}/reviews/{reviewId}
     * @allow (get, list) - Anyone can read the reviews on a temple.
     * @allow (create) - Any signed-in user can create a review.
     * @allow (update, delete) - Only the review's author can update or delete it.
     * @principle Public read, owner-only writes.
     */
    match /temples/{templeId}/reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Enforces access control for posts on temples.
     * @path /temples/{templeId}/posts/{postId}
     * @allow (get, list) - Anyone can read the posts on a temple.
     * @allow (create) - Any signed-in user can create a post.
     * @allow (update, delete) - Only the post's author can update or delete it.
     * @principle Public read, owner-only writes.
     */
    match /temples/{templeId}/posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Allows public read access to stories.
     * @path /stories/{storyId}
     * @allow (get, list) - Anyone can read story details.
     * @deny (create, update, delete) - Stories are managed by admins, not regular users.
     * @principle Public read, restricted write access.
     */
    match /stories/{storyId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to epic heroes.
     * @path /epicHeroes/{heroId}
     * @allow (get, list) - Anyone can read epic hero details.
     * @deny (create, update, delete) - Epic heroes are managed by admins, not regular users.
     * @principle Public read, restricted write access.
     */
    match /epicHeroes/{heroId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to rituals.
     * @path /rituals/{ritualId}
     * @allow (get, list) - Anyone can read ritual details.
     * @deny (create, update, delete) - Rituals are managed by admins, not regular users.
     * @principle Public read, restricted write access.
     */
    match /rituals/{ritualId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to panchang data.
     * @path /panchang/{date}
     * @allow (get, list) - Anyone can read panchang details.
     * @deny (create, update, delete) - Panchang data is updated by the system, not regular users.
     * @principle Public read, restricted write access.
     */
    match /panchang/{date} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to festivals.
     * @path /festivals/{festivalId}
     * @allow (get, list) - Anyone can read festival details.
     * @deny (create, update, delete) - Festivals are managed by admins, not regular users.
     * @principle Public read, restricted write access.
     */
    match /festivals/{festivalId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

     /**
     * @description Allows public read access to groups.
     * @path /groups/{groupId}
     * @allow (get, list) - Anyone can read group details.
     * @deny (create, update, delete) - Groups are managed by admins, not regular users.
     * @principle Public read, restricted write access.
     */
    match /groups/{groupId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Enforces access control for members of a group.
     * @path /groups/{groupId}/members/{userId}
     * @allow (get, list) - Anyone can read group membership.
     * @allow (create) - User 'abc' can join a group with documentId 'abc'.
     * @deny (create) - User 'abc' cannot join with documentId 'def'.
     * @allow (update, delete) - User 'abc' can update or delete their group membership if they are the member.
     * @principle Public read, owner-only membership management.
     */
    match /groups/{groupId}/members/{userId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

     /**
     * @description Allows public read access to posts.
     * @path /posts/{postId}
     * @allow (get, list) - Anyone can read post details.
     * @allow (create) - User 'abc' can create a new post if request.resource.data.authorId == request.auth.uid.
     * @allow (update, delete) - User 'abc' can update or delete post if they are the owner.
     * @deny (create) - User 'abc' cannot create a new post if request.resource.data.authorId != request.auth.uid.
     * @deny (update, delete) - User 'def' cannot update or delete post owned by 'abc'.
     * @principle Public read, owner-only writes.
     */
    match /posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

     /**
     * @description Enforces access control for comments on posts.
     * @path /posts/{postId}/comments/{commentId}
     * @allow (get, list) - Anyone can read the comments on a post.
     * @allow (create) - Any signed-in user can create a comment.
     * @allow (update, delete) - Only the comment's author can update or delete it.
     * @principle Public read, owner-only writes.
     */
    match /posts/{postId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Likes for a forum post
     * @path /posts/{postId}/likes/{userId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn() && request.auth.uid == userId;
     * @allow update, delete: if isExistingOwner(userId);
     */
    match /posts/{postId}/likes/{userId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to challenges.
     * @path /challenges/{challengeId}
     * @allow (get, list) - Anyone can read challenge details.
     * @deny (create, update, delete) - Challenges are managed by admins, not regular users.
     * @principle Public read, restricted write access.
     */
    match /challenges/{challengeId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to contests.
     * @path /contests/{contestId}
     * @allow (get, list) - Anyone can read contest details.
     * @deny (create, update, delete) - Contests are managed by admins, not regular users.
     * @principle Public read, restricted write access.
     */
    match /contests/{contestId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to manifestation posts, but enforces owner-only writes.
     * @path /manifestations/{manifestationId}
     * @allow (get, list) - Anyone can read manifestation post details.
     * @allow (create) - User 'abc' can create a new manifestation post if request.resource.data.userId == request.auth.uid.
     * @allow (update, delete) - User 'abc' can update or delete manifestation post if they are the owner.
     * @deny (create) - User 'abc' cannot create a new manifestation post if request.resource.data.userId != request.auth.uid.
     * @deny (update, delete) - User 'def' cannot update or delete manifestation post owned by 'abc'.
     * @principle Public read, owner-only writes.
     */
    match /manifestations/{manifestationId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

     /**
     * @description Enforces access control for comments on manifestation posts.
     * @path /manifestations/{manifestationId}/comments/{commentId}
     * @allow (get, list) - Anyone can read the comments on a manifestation post.
     * @allow (create) - Any signed-in user can create a comment.
     * @allow (update, delete) - Only the comment's author can update or delete it.
     * @principle Public read, owner-only writes.
     */
    match /manifestations/{manifestationId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Likes for a manifestation post
     * @path /manifestations/{manifestationId}/likes/{userId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn() && request.auth.uid == userId;
     * @allow update, delete: if isExistingOwner(userId);
     */
    match /manifestations/{manifestationId}/likes/{userId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}