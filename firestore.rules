rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID and the resource exists.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
    }

    /**
     * @description Allows read access if the document exists.
     */
    function existsAfter() {
      return exists(after);
    }


    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) Signed-in user can create their profile if the UID matches the document ID.
     * @allow (get, update, delete) Signed-in user can access and modify their own profile.
     * @deny (create) Signed-in user cannot create a profile with a mismatched UID.
     * @deny (get, update, delete) Signed-in user cannot access or modify another user's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing users is not permitted

      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Rules for user contest progress.
     * @path /users/{userId}/contestProgress/{contestId}
     * @allow (create, get, update, delete, list) Signed-in user can access and modify their own contest progress.
     * @deny (create, get, update, delete, list) Signed-in user cannot access or modify another user's contest progress.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/contestProgress/{contestId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Rules for user followers.
     * @path /users/{userId}/followers/{followerId}
     * @allow (create, get, list) Signed-in user can access their own followers.
     * @deny (create, get, list) Signed-in user cannot access another user's followers.
     */
    match /users/{userId}/followers/{followerId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for users being followed.
     * @path /users/{userId}/following/{followedId}
     * @allow (create, get, list) Signed-in user can access their own following list.
     * @deny (create, get, list) Signed-in user cannot access another user's following list.
     */
    match /users/{userId}/following/{followedId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == followedId;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for channel subscriptions.
     * @path /users/{userId}/subscriptions/{channelId}
     * @allow (create, get, list) Signed-in user can access their own subscriptions.
     * @deny (create, get, list) Signed-in user cannot access another user's subscriptions.
     */
    match /users/{userId}/subscriptions/{channelId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == channelId;
      allow update: if false;
      allow delete: if false;
    }


    /**
     * @description Rules for user preferences.
     * @path /users/{userId}/preferences/default
     * @allow (create, get, update, delete) Signed-in user can access and modify their own preferences.
     * @deny (create, get, update, delete) Signed-in user cannot access or modify another user's preferences.
     */
    match /users/{userId}/preferences/default {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;

      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Rules for user badges.
     * @path /users/{userId}/badges/{badgeId}
     * @allow (create, get, list) Signed-in user can access their own badges.
     * @deny (create, get, list) Signed-in user cannot access another user's badges.
     */
    match /users/{userId}/badges/{badgeId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == badgeId;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for user bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (create, get, list) Signed-in user can access their own bookmarks.
     * @deny (create, get, list) Signed-in user cannot access another user's bookmarks.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == bookmarkId;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for user virtual offerings.
     * @path /users/{userId}/virtualOfferings/{offeringId}
     * @allow (create, get, list) Signed-in user can access their own virtual offerings.
     * @deny (create, get, list) Signed-in user cannot access another user's virtual offerings.
     */
    match /users/{userId}/virtualOfferings/{offeringId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == offeringId;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for user shopping cart.
     * @path /users/{userId}/cart/{productId}
     * @allow (create, get, update, delete, list) Signed-in user can access their own cart.
     * @deny (create, get, update, delete, list) Signed-in user cannot access another user's cart.
     */
    match /users/{userId}/cart/{productId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Rules for user playlists.
     * @path /users/{userId}/playlists/{playlistId}
     * @allow (create, get, update, delete, list) Signed-in user can access their own playlists.
     * @deny (create, get, update, delete, list) Signed-in user cannot access another user's playlists.
     */
    match /users/{userId}/playlists/{playlistId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Rules for user challenges.
     * @path /users/{userId}/challenges/{challengeId}
     * @allow (create, get, update, delete, list) Signed-in user can access and modify their own challenge progress.
     * @deny (create, get, update, delete, list) Signed-in user cannot access or modify another user's challenge progress.
     */
    match /users/{userId}/challenges/{challengeId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Rules for orders.
     * @path /orders/{orderId}
     * @allow (read) Anyone can read orders.
     * @deny (create, update, delete) No one can create, update, or delete orders.
     * @TODO: Add role-based access control for order management (e.g., admin role).
     */
    match /orders/{orderId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add admin role validation for order management.
    }

    /**
     * @description Rules for media.
     * @path /media/{mediaId}
     * @allow (read) Anyone can read media.
     * @allow (create, update, delete) Only the media owner can modify it.
     */
    match /media/{mediaId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Rules for media comments.
     * @path /media/{mediaId}/comments/{commentId}
     * @allow (read, create) Any signed-in user can create and read comments.
     * @allow (update, delete) Only the comment owner can modify it.
     */
    match /media/{mediaId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

     /**
      * @description Rules for media likes.
      * @path /media/{mediaId}/likes/{userId}
      * @allow (create, get, list, delete) Any signed-in user can like or unlike media.
      * @deny (update) No updates allowed.
      */
     match /media/{mediaId}/likes/{userId} {
       allow get, list: if true;
       allow create: if isSignedIn() && request.auth.uid == userId;
       allow update: if false;
       allow delete: if isSignedIn() && request.auth.uid == userId;
     }

    /**
     * @description Rules for channels.
     * @path /channels/{channelId}
     * @allow (read) Anyone can read channels.
     * @allow (create, update, delete) Only the channel owner can modify it.
     */
    match /channels/{channelId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Rules for channel subscribers.
     * @path /channels/{channelId}/subscribers/{userId}
     * @allow (create, get, list, delete) Any signed-in user can subscribe to or unsubscribe from a channel.
     * @deny (update) No updates allowed.
     */
    match /channels/{channelId}/subscribers/{userId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if false;
      allow delete: if isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Rules for playlists.
     * @path /playlists/{playlistId}
     * @allow (read) Anyone can read playlists.
     * @allow (create, update, delete) Only the playlist owner can modify it.
     */
    match /playlists/{playlistId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource.data.creatorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.creatorId == request.auth.uid;
    }

    /**
     * @description Rules for horoscopes.
     * @path /users/{userId}/horoscopes/{horoscopeId}
     * @allow (create, get, list) Signed-in user can access their own horoscopes.
     * @deny (create, get, list) Signed-in user cannot access another user's horoscopes.
     */
    match /users/{userId}/horoscopes/{horoscopeId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == horoscopeId;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for deities.
     * @path /deities/{deityId}
     * @allow (read) Anyone can read deities.
     * @deny (create, update, delete) No one can create, update, or delete deities.
     * @TODO: Add role-based access control for deity management (e.g., admin role).
     */
    match /deities/{deityId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add admin role validation for deity management.
    }

    /**
     * @description Rules for shops.
     * @path /shops/{shopId}
     * @allow (read) Anyone can read shops.
     * @allow (create, update, delete) Only the shop owner can modify it.
     */
    match /shops/{shopId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource.data.ownerId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    /**
     * @description Rules for products.
     * @path /products/{productId}
     * @allow (read) Anyone can read products.
     * @deny (create, update, delete) No one can create, update, or delete products.
     * @TODO: Add role-based access control for product management (e.g., shop owner or admin role).
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add shop owner/admin role validation for product management.
    }

    /**
     * @description Rules for temples.
     * @path /temples/{templeId}
     * @allow (read) Anyone can read temples.
     * @deny (create, update, delete) No one can create, update, or delete temples.
     * @TODO: Add role-based access control for temple management (e.g., admin role).
     */
    match /temples/{templeId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add admin role validation for temple management.
    }

    /**
     * @description Rules for temple reviews.
     * @path /temples/{templeId}/reviews/{reviewId}
     * @allow (read, create) Any signed-in user can read and create reviews.
     * @allow (update, delete) Only the review owner can modify it.
     */
    match /temples/{templeId}/reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Rules for temple posts.
     * @path /temples/{templeId}/posts/{postId}
     * @allow (read, create) Any signed-in user can read and create posts.
     * @allow (update, delete) Only the post owner can modify it.
     */
    match /temples/{templeId}/posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Rules for stories.
     * @path /stories/{storyId}
     * @allow (read) Anyone can read stories.
     * @deny (create, update, delete) No one can create, update, or delete stories.
     * @TODO: Add role-based access control for story management (e.g., admin role).
     */
    match /stories/{storyId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add admin role validation for story management.
    }

    /**
     * @description Rules for epic heroes.
     * @path /epicHeroes/{heroId}
     * @allow (read) Anyone can read epic heroes.
     * @deny (create, update, delete) No one can create, update, or delete epic heroes.
     * @TODO: Add role-based access control for epic hero management (e.g., admin role).
     */
    match /epicHeroes/{heroId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add admin role validation for epic hero management.
    }

    /**
     * @description Rules for rituals.
     * @path /rituals/{ritualId}
     * @allow (read) Anyone can read rituals.
     * @deny (create, update, delete) No one can create, update, or delete rituals.
     * @TODO: Add role-based access control for ritual management (e.g., admin role).
     */
    match /rituals/{ritualId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add admin role validation for ritual management.
    }

    /**
     * @description Rules for panchang.
     * @path /panchang/{date}
     * @allow (read) Anyone can read panchang.
     * @deny (create, update, delete) No one can create, update, or delete panchang.
     * @TODO: Add role-based access control for panchang management (e.g., admin role).
     */
    match /panchang/{date} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add admin role validation for panchang management.
    }

    /**
     * @description Rules for festivals.
     * @path /festivals/{festivalId}
     * @allow (read) Anyone can read festivals.
     * @deny (create, update, delete) No one can create, update, or delete festivals.
     * @TODO: Add role-based access control for festival management (e.g., admin role).
     */
    match /festivals/{festivalId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add admin role validation for festival management.
    }

    /**
     * @description Rules for community groups.
     * @path /groups/{groupId}
     * @allow (read) Anyone can read group information.
     * @deny (create, update, delete) Only group members can create/update/delete groups.
     *  @TODO: Implement group membership checks.
     */
    match /groups/{groupId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add membership validation.
      allow update: if false; // TODO: Add membership validation.
      allow delete: if false; // TODO: Add membership validation.
    }

    /**
     * @description Rules for group members.
     * @path /groups/{groupId}/members/{userId}
     * @allow (create, get, list, delete) Only signed-in users can manage their group membership.
     * @deny (update) No updates allowed.
     * @principle Enforces that only signed-in users can manage their group membership
     */
    match /groups/{groupId}/members/{userId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update: if false;
        allow delete: if isSignedIn() && request.auth.uid == userId;
    }
    
     /**
      * @description Rules for the legacy groups collection. This is not correct.
      * @path /users/{userId}/groups/{groupId}
      * @allow (create) Denied: Creating these documents should not be allowed in this location.
      */
     match /users/{userId}/groups/{groupId} {
       allow create: if false;
       allow get: if false;
       allow list: if false;
       allow update: if false;
       allow delete: if false;
    }

    /**
     * @description Rules for posts within a group.
     * @path /posts/{postId}
     * @allow (read) Anyone can read posts.
     * @allow (create) Only signed-in users can create posts.
     * @allow (update, delete) Only the post owner can modify it.
     */
    match /posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Rules for comments on posts.
     * @path /posts/{postId}/comments/{commentId}
     * @allow (read, create) Any signed-in user can read and create comments.
     * @allow (update, delete) Only the comment owner can modify it.
     */
    match /posts/{postId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

     /**
      * @description Rules for post likes.
      * @path /posts/{postId}/likes/{userId}
      * @allow (create, get, list, delete) Any signed-in user can like or unlike a post.
      * @deny (update) No updates allowed.
      */
     match /posts/{postId}/likes/{userId} {
       allow get, list: if true;
       allow create: if isSignedIn() && request.auth.uid == userId;
       allow update: if false;
       allow delete: if isSignedIn() && request.auth.uid == userId;
     }

      /**
       * @description Rules for community challenges.
       * @path /challenges/{challengeId}
       * @allow (read) Anyone can read challenges.
       * @deny (create, update, delete) No one can create, update, or delete challenges.
       * @TODO: Add role-based access control for challenge management (e.g., admin role).
       */
      match /challenges/{challengeId} {
        allow get, list: if true;
        allow create, update, delete: if false; // TODO: Add admin role validation for challenge management.
      }

      /**
       * @description Rules for global chanting contests.
       * @path /contests/{contestId}
       * @allow (read) Anyone can read contests.
       * @deny (create, update, delete) No one can create, update, or delete contests.
       * @TODO: Add role-based access control for contest management (e.g., admin role).
       */
      match /contests/{contestId} {
        allow get, list: if true;
        allow create, update, delete: if false; // TODO: Add admin role validation for contest management.
      }

      /**
       * @description Rules for manifestation posts.
       * @path /manifestations/{manifestationId}
       * @allow (read) Anyone can read manifestation posts.
       * @allow (create) Only signed-in users can create manifestation posts.
       * @allow (update, delete) Only the post owner can modify it.
       */
      match /manifestations/{manifestationId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      }

      /**
       * @description Rules for comments on manifestation posts.
       * @path /manifestations/{manifestationId}/comments/{commentId}
       * @allow (read, create) Any signed-in user can read and create comments.
       * @allow (update, delete) Only the comment owner can modify it.
       */
      match /manifestations/{manifestationId}/comments/{commentId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
      }

       /**
        * @description Rules for manifestation post likes.
        * @path /manifestations/{manifestationId}/likes/{userId}
        * @allow (create, get, list, delete) Any signed-in user can like or unlike a manifestation post.
        * @deny (update) No updates allowed.
        */
       match /manifestations/{manifestationId}/likes/{userId} {
         allow get, list: if true;
         allow create: if isSignedIn() && request.auth.uid == userId;
         allow update: if false;
         allow delete: if isSignedIn() && request.auth.uid == userId;
       }
  }
}