/**
 * @fileoverview Firestore Security Rules for the aaura app.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for personal data,
 * while allowing public read access to certain content collections.
 * User-generated content is generally accessible, but modifications are restricted to the owner.
 *
 * Data Structure:
 * - User data and related subcollections (followers, following, preferences, badges, etc.)
 *   are nested under `/users/{userId}`.
 * - Public content like media, deities, temples, stories, and rituals are stored
 *   in top-level collections like `/media/{mediaId}` and `/temples/{templeId}`.
 * - Likes are stored as subcollections of the item being liked (e.g., `/media/{mediaId}/likes/{userId}`).
 *
 * Key Security Decisions:
 * - Users can only read/write their own data.
 * - Listing of user documents is disallowed for privacy.
 * - Certain top-level collections (e.g., `media`, `deities`, `temples`, `stories`, `rituals`)
 *   are publicly readable but have owner-restricted writes (create/update/delete).
 * - Relational integrity is enforced on `create` and `update` operations
 *   for user-owned resources.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the resource.
     * @param {string} userId - The user ID to check against.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the request is made by the owner of an existing resource.
     * @param {string} userId - The user ID to check against.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) - User can create their own profile.
     * @allow (update) - User can update their own profile.
     * @allow (get) - User can get their own profile.
     * @allow (list) - Listing all users is disallowed.
     * @deny (create) - User cannot create a profile with an ID that doesn't match their own.
     * @deny (update) - User cannot update someone else's profile.
     * @principle Enforces document ownership.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if false; // User's cannot delete their profile.
    }

    /**
     * @description Rules for followers subcollection.
     * @path /users/{userId}/followers/{followerId}
     * @allow (create) - User can create a follower entry in their own subcollection.
     * @allow (get) - User can get a follower entry in their own subcollection.
     * @allow (list) - User can list followers in their own subcollection.
     * @deny (create) - User cannot create a follower entry with an ID that doesn't match their own.
     * @deny (update) - Follower entries cannot be updated.
     * @deny (delete) - User cannot delete a follower entry in their own subcollection.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/followers/{followerId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for following subcollection.
     * @path /users/{userId}/following/{followedId}
     * @allow (create) - User can create a following entry in their own subcollection.
     * @allow (get) - User can get a following entry in their own subcollection.
     * @allow (list) - User can list following entries in their own subcollection.
     * @deny (create) - User cannot create a following entry with an ID that doesn't match their own.
     * @deny (update) - Following entries cannot be updated.
     * @deny (delete) - User can delete a following entry in their own subcollection.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/following/{followedId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for user preferences.
     * @path /users/{userId}/preferences/default
     * @allow (get) - User can get their preferences.
     * @allow (update) - User can update their preferences.
     * @allow (create) - User can create their preferences.
     * @allow (list) - Listing preferences is disallowed.
     * @deny (create) - User cannot create preferences for a different user.
     * @deny (update) - User cannot update preferences for a different user.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/preferences/default {
      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if false; // User's cannot delete their preferences.
    }

    /**
     * @description Rules for user badges.
     * @path /users/{userId}/badges/{badgeId}
     * @allow (get) - User can get their badges.
     * @allow (create) - User can create their own badges.
     * @allow (list) - User can list their own badges.
     * @deny (create) - User cannot create badges for a different user.
     * @deny (update) - Badges cannot be updated.
     * @deny (delete) - Badges cannot be deleted.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/badges/{badgeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if false; // Badges should be awarded by the system.
      allow update: if false;
      allow delete: if false;
    }

   /**
     * @description Rules for user bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (get) - User can get their bookmarks.
     * @allow (create) - User can create their own bookmarks.
     * @allow (list) - User can list their own bookmarks.
     * @deny (create) - User cannot create bookmarks for a different user.
     * @deny (update) - Bookmarks cannot be updated.
     * @deny (delete) - Bookmarks can be deleted by the user.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for virtual offerings.
     * @path /users/{userId}/virtualOfferings/{offeringId}
     * @allow (get) - User can get their virtual offerings.
     * @allow (create) - User can create their own virtual offerings.
     * @allow (list) - User can list their own virtual offerings.
     * @deny (create) - User cannot create virtual offerings for a different user.
     * @deny (update) - Virtual offerings cannot be updated.
     * @deny (delete) - Virtual offerings cannot be deleted.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/virtualOfferings/{offeringId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for items in the user's cart.
     * @path /users/{userId}/cart/{productId}
     * @allow (get) - User can get items in their cart.
     * @allow (create) - User can add items to their cart.
     * @allow (list) - User can list the items in their cart.
     * @deny (create) - User cannot add items to another user's cart.
     * @deny (update) - Cart items cannot be updated (only replaced by deleting and re-adding).
     * @deny (delete) - User can delete cart items.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/cart/{productId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for user orders.
     * @path /users/{userId}/orders/{orderId}
     * @allow (get) - User can get their orders.
     * @allow (create) - User can create their own orders.
     * @allow (list) - User can list their orders.
     * @deny (create) - User cannot create orders for another user.
     * @deny (update) - Orders cannot be updated (should be immutable).
     * @deny (delete) - Orders cannot be deleted.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/orders/{orderId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for user playlists.
     * @path /users/{userId}/playlists/{playlistId}
     * @allow (get) - User can get their playlist references.
     * @allow (create) - User can create playlist references.
     * @allow (list) - User can list playlist references.
     * @deny (create) - User cannot create a playlist reference for a different user.
     * @deny (update) - Playlist references cannot be updated.
     * @deny (delete) - User can delete a playlist reference.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/playlists/{playlistId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for user challenge progress.
     * @path /users/{userId}/challenges/{challengeId}
     * @allow (get) - User can get their challenge progress.
     * @allow (create) - User can create their challenge progress.
     * @allow (list) - User can list their challenge progress.
     * @deny (create) - User cannot create challenge progress for a different user.
     * @deny (update) - User can update their challenge progress.
     * @deny (delete) - Challenge progress cannot be deleted.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/challenges/{challengeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Rules for media items.
     * @path /media/{mediaId}
     * @allow (get) - Everyone can read media items.
     * @allow (list) - Everyone can list media items.
     * @allow (create) - Only the owner can create a media item, and the `userId` must match their auth UID.
     * @allow (update) - Only the owner can update a media item.
     * @deny (create) - If the incoming `userId` doesn't match the authenticated user's UID.
     * @deny (update) - Non-owners cannot update media items.
     * @deny (delete) - Only the owner can delete a media item.
     * @principle Public read, owner-only writes.
     */
    match /media/{mediaId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Rules for media comments.
     * @path /media/{mediaId}/comments/{commentId}
     * @allow (get) - Everyone can read comments.
     * @allow (create) - Any signed-in user can create comments.
     * @allow (list) - Everyone can list comments.
     * @allow (update) - No one can update comments.
     * @allow (delete) - No one can delete comments.
     */
    match /media/{mediaId}/comments/{commentId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for likes on media items.
     * @path /media/{mediaId}/likes/{userId}
     * @allow (get) - Everyone can read likes.
     * @allow (create) - Any signed-in user can create a like.
     * @allow (list) - Everyone can list likes.
     * @allow (update) - No one can update likes.
     * @allow (delete) - No one can delete likes.
     */
    match /media/{mediaId}/likes/{userId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for channels.
     * @path /channels/{channelId}
     * @allow (get) - Everyone can read channels.
     * @allow (list) - Everyone can list channels.
     * @allow (create) - Only the owner can create a channel, and the `userId` must match their auth UID.
     * @allow (update) - Only the owner can update their channel.
     * @deny (create) - If the incoming `userId` doesn't match the authenticated user's UID.
     * @deny (update) - Non-owners cannot update channels.
     * @deny (delete) - Channels cannot be deleted.
     * @principle Public read, owner-only writes.
     */
    match /channels/{channelId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if false; // Prevent channel deletion
    }

    /**
     * @description Rules for playlists.
     * @path /playlists/{playlistId}
     * @allow (get) - Everyone can read playlists.
     * @allow (list) - Everyone can list playlists.
     * @allow (create) - Any signed-in user can create a playlist.
     * @allow (update) - No one can update a playlist.
     * @allow (delete) - No one can delete a playlist.
     */
    match /playlists/{playlistId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for user horoscopes.
     * @path /users/{userId}/horoscopes/{horoscopeId}
     * @allow (get) - User can get their horoscopes.
     * @allow (create) - Horoscopes should be generated by the system, not the user.
     * @allow (list) - User can list their horoscopes.
     * @deny (create) - User cannot create horoscopes for a different user.
     * @deny (update) - Horoscopes cannot be updated.
     * @deny (delete) - Horoscopes cannot be deleted.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/horoscopes/{horoscopeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if false; // Horoscopes are system-generated.
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for deities.
     * @path /deities/{deityId}
     * @allow (get) - Everyone can read deities.
     * @allow (list) - Everyone can list deities.
     * @allow create, update, delete: if false; // TODO: Add admin role check.
     * @principle Public read, restricted writes.
     */
    match /deities/{deityId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false; // TODO: Add admin role check.
    }

    /**
     * @description Rules for shops.
     * @path /shops/{shopId}
     * @allow (get) - Everyone can read shop information.
     * @allow (list) - Everyone can list shops.
     * @allow (create) - Only the owner can create a shop, and the `ownerId` must match their auth UID.
     * @allow (update) - Only the owner can update their shop.
     * @deny (create) - If the incoming `ownerId` doesn't match the authenticated user's UID.
     * @deny (update) - Non-owners cannot update shops.
     * @deny (delete) - Shops cannot be deleted.
     * @principle Public read, owner-only writes.
     */
    match /shops/{shopId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.ownerId == request.auth.uid;
      allow delete: if false;
    }

    /**
     * @description Rules for products.
     * @path /products/{productId}
     * @allow (get) - Everyone can read products.
     * @allow (list) - Everyone can list products.
     * @allow create, update, delete: if false; // TODO: Add shop owner validation once the schema is updated with an ownership field.
     * @principle Public read, owner-only writes.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false; // TODO: Add shop owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for temples.
     * @path /temples/{templeId}
     * @allow (get) - Everyone can read temple data.
     * @allow (list) - Everyone can list temples.
     * @allow create, update, delete: if false; // TODO: Add admin role check.
     * @principle Public read, restricted writes.
     */
    match /temples/{templeId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false; // TODO: Add admin role check.
    }

    /**
     * @description Rules for temple reviews.
     * @path /temples/{templeId}/reviews/{reviewId}
     * @allow (get) - Everyone can read temple reviews.
     * @allow (create) - Any signed-in user can create a review.
     * @allow (list) - Everyone can list temple reviews.
     * @allow (update) - No one can update reviews.
     * @allow (delete) - Reviews cannot be deleted.
     */
    match /temples/{templeId}/reviews/{reviewId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for temple posts.
     * @path /temples/{templeId}/posts/{postId}
     * @allow (get) - Everyone can read temple posts.
     * @allow (create) - Any signed-in user can create a post.
     * @allow (list) - Everyone can list temple posts.
     * @allow (update) - No one can update posts.
     * @allow (delete) - No one can delete posts.
     */
    match /temples/{templeId}/posts/{postId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

   /**
     * @description Rules for stories.
     * @path /stories/{storyId}
     * @allow (get) - Everyone can read stories.
     * @allow (list) - Everyone can list stories.
     * @allow create, update, delete: if false; // TODO: Add admin role check.
     * @principle Public read, restricted writes.
     */
    match /stories/{storyId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false; // TODO: Add admin role check.
    }

   /**
     * @description Rules for epic heroes.
     * @path /epicHeroes/{heroId}
     * @allow (get) - Everyone can read epic heroes.
     * @allow (list) - Everyone can list epic heroes.
     * @allow create, update, delete: if false; // TODO: Add admin role check.
     * @principle Public read, restricted writes.
     */
    match /epicHeroes/{heroId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false; // TODO: Add admin role check.
    }

    /**
     * @description Rules for rituals.
     * @path /rituals/{ritualId}
     * @allow (get) - Everyone can read rituals.
     * @allow (list) - Everyone can list rituals.
     * @allow create, update, delete: if false; // TODO: Add admin role check.
     * @principle Public read, restricted writes.
     */
    match /rituals/{ritualId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false; // TODO: Add admin role check.
    }

    /**
     * @description Rules for panchang data.
     * @path /panchang/{date}
     * @allow (get) - Everyone can read panchang data.
     * @allow (list) - Everyone can list panchang data.
     * @allow create, update, delete: if false; // TODO: Add admin role check.
     * @principle Public read, restricted writes.
     */
    match /panchang/{date} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false; // TODO: Add admin role check.
    }

    /**
     * @description Rules for festivals.
     * @path /festivals/{festivalId}
     * @allow (get) - Everyone can read festival data.
     * @allow (list) - Everyone can list festival data.
     * @allow create, update, delete: if false; // TODO: Add admin role check.
     * @principle Public read, restricted writes.
     */
    match /festivals/{festivalId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false; // TODO: Add admin role check.
    }

    /**
     * @description Rules for community groups.
     * @path /groups/{groupId}
     * @allow (get) - Everyone can read groups.
     * @allow (list) - Everyone can list groups.
     * @allow create, update, delete: if false; // TODO: Add admin role check.
     */
    match /groups/{groupId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for group members.
     * @path /groups/{groupId}/members/{userId}
     * @allow (get) - Everyone can read group members.
     * @allow (list) - Everyone can list group members.
     * @allow create: if isSignedIn();
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /groups/{groupId}/members/{userId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for forum posts.
     * @path /posts/{postId}
     * @allow (get) - Everyone can read forum posts.
     * @allow (create) - Any signed-in user can create a post.
     * @allow (list) - Everyone can list forum posts.
     * @allow (update) - No one can update a post.
     * @allow (delete) - No one can delete a post.
     */
    match /posts/{postId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for comments on forum posts.
     * @path /posts/{postId}/comments/{commentId}
     * @allow (get) - Everyone can read comments.
     * @allow (create) - Any signed-in user can create a comment.
     * @allow (list) - Everyone can list comments.
     * @allow (update) - No one can update a comment.
     * @allow (delete) - No one can delete a comment.
     */
    match /posts/{postId}/comments/{commentId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for likes on forum posts.
     * @path /posts/{postId}/likes/{userId}
     * @allow (get) - Everyone can read likes.
     * @allow (create) - Any signed-in user can create a like.
     * @allow (list) - Everyone can list likes.
     * @allow (update) - No one can update a like.
     * @allow (delete) - No one can delete a like.
     */
    match /posts/{postId}/likes/{userId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for community challenges.
     * @path /challenges/{challengeId}
     * @allow (get) - Everyone can read challenge data.
     * @allow (list) - Everyone can list challenges.
     * @allow create, update, delete: if false; // TODO: Add admin role check.
     * @principle Public read, restricted writes.
     */
    match /challenges/{challengeId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false; // TODO: Add admin role check.
    }

    /**
     * @description Rules for manifestation posts.
     * @path /manifestations/{manifestationId}
     * @allow (get) - Everyone can read manifestation posts.
     * @allow (list) - Everyone can list manifestation posts.
     * @allow (create) - Only the owner can create a manifestation post, and the `userId` must match their auth UID.
     * @allow (update) - Only the owner can update a manifestation post.
     * @deny (create) - If the incoming `userId` doesn't match the authenticated user's UID.
     * @deny (update) - Non-owners cannot update manifestation posts.
     */
    match /manifestations/{manifestationId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Rules for comments on manifestation posts.
     * @path /manifestations/{manifestationId}/comments/{commentId}
     * @allow (get) - Everyone can read comments on manifestation posts.
     * @allow (create) - Any signed-in user can create a comment.
     * @allow (list) - Everyone can list comments on manifestation posts.
     * @allow (update) - No one can update comments.
     * @allow (delete) - No one can delete comments.
     */
    match /manifestations/{manifestationId}/comments/{commentId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for likes on manifestation posts.
     * @path /manifestations/{manifestationId}/likes/{userId}
     * @allow (get) - Everyone can read likes on manifestation posts.
     * @allow (create) - Any signed-in user can create a like.
     * @allow (list) - Everyone can list likes on manifestation posts.
     * @allow (update) - No one can update a like.
     * @allow (delete) - No one can delete a like.
     */
    match /manifestations/{manifestationId}/likes/{userId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}