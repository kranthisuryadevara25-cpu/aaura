/**
 * @file Firebase Security Rules for the aaura app.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal data while allowing public read access to shared content.
 *
 * Data Structure:
 * - User-specific data is nested under `/users/{userId}`.
 * - Public content (media, temples, deities, stories, etc.) resides in top-level collections.
 * - Social graph is implemented with `/users/{userId}/followers/{followerId}` and `/users/{userId}/following/{followedId}`.
 *
 * Key Security Decisions:
 * - Users can only access their own data under `/users/{userId}`.
 * - Listing of users is disallowed for privacy.
 * - Public content collections are readable by everyone but writable only with proper authorization (e.g., ownership).
 * - Data required for authorization is denormalized onto the secured documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Manages access to user profile data.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile.
     * @allow (get, update, delete) User with ID 'user123' can read/update/delete their own profile.
     * @deny (create, get, update, delete) User with ID 'user456' cannot access data for user 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

     /**
      * @description Manages access to user contest progress data.
      * @path /users/{userId}/contestProgress/{contestId}
      * @allow (create, get, update, delete) User with ID 'user123' can manage their contest progress.
      * @deny (create, get, update, delete) User with ID 'user456' cannot access data for user 'user123'.
      * @principle Enforces document ownership for all operations.
      */
    match /users/{userId}/contestProgress/{contestId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages user following other users.
     * @path /users/{userId}/followers/{followerId}
     * @allow (create) User with ID 'follower123' can follow user 'user123'.
     * @allow (get, list) User with ID 'user123' can view their list of followers.
     * @deny (create, get, list, update, delete) User with ID 'user456' cannot access follow data for user 'user123'.
     * @principle Enforces document ownership and prevents unauthorized access to social graph data.
     */
    match /users/{userId}/followers/{followerId} {
        allow get, list: if isOwner(userId);
        allow create: if isSignedIn();
        allow update, delete: if false;
    }

    /**
     * @description Manages users following other users.
     * @path /users/{userId}/following/{followedId}
     * @allow (create) User with ID 'user123' can follow user 'followed456'.
     * @allow (get, list) User with ID 'user123' can view who they are following.
     * @deny (create, get, list, update, delete) User with ID 'user456' cannot access follow data for user 'user123'.
     * @principle Enforces document ownership and prevents unauthorized access to social graph data.
     */
    match /users/{userId}/following/{followedId} {
        allow get, list: if isOwner(userId);
        allow create: if isSignedIn();
        allow update, delete: if false;
    }


    /**
     * @description Manages user preference data.
     * @path /users/{userId}/preferences/default
     * @allow (get, update) User with ID 'user123' can read/update their own preferences.
     * @deny (create, get, update, delete) User with ID 'user456' cannot access preferences for user 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/preferences/default {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if false;
      allow update: if isExistingOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Manages user badges.
     * @path /users/{userId}/badges/{badgeId}
     * @allow (get, list, create) User with ID 'user123' can manage their badges.
     * @deny (create, get, list, update, delete) User with ID 'user456' cannot access badges for user 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/badges/{badgeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages user bookmarks for temples.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (get, list, create) User with ID 'user123' can manage their bookmarks.
     * @deny (create, get, list, update, delete) User with ID 'user456' cannot access bookmarks for user 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages user virtual offerings.
     * @path /users/{userId}/virtualOfferings/{offeringId}
     * @allow (get, list, create) User with ID 'user123' can manage their virtual offerings.
     * @deny (create, get, list, update, delete) User with ID 'user456' cannot access offerings for user 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/virtualOfferings/{offeringId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages items in a user's shopping cart.
     * @path /users/{userId}/cart/{productId}
     * @allow (get, list, create, update, delete) User with ID 'user123' can manage their cart.
     * @deny (create, get, list, update, delete) User with ID 'user456' cannot access cart for user 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/cart/{productId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages a user's past orders.
     * @path /users/{userId}/orders/{orderId}
     * @allow (get, list, create, update, delete) User with ID 'user123' can manage their orders.
     * @deny (create, get, list, update, delete) User with ID 'user456' cannot access orders for user 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/orders/{orderId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages playlist references created by the user.
     * @path /users/{userId}/playlists/{playlistId}
     * @allow (get, list, create, update, delete) User with ID 'user123' can manage their playlist references.
     * @deny (create, get, list, update, delete) User with ID 'user456' cannot access playlist references for user 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/playlists/{playlistId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages user challenge progress.
     * @path /users/{userId}/challenges/{challengeId}
     * @allow (get, list, create, update, delete) User with ID 'user123' can manage their challenges.
     * @deny (create, get, list, update, delete) User with ID 'user456' cannot access challenges for user 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/challenges/{challengeId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages media content.
     * @path /media/{mediaId}
     * @allow (get, list) Public read access to all media.
     * @allow (create) Only signed-in users can create media. MUST ensure media.userId == request.auth.uid in the create request.
     * @allow (update, delete) Only the owner of the media can update or delete it.
     * @principle Allows public read with owner-only writes, enforcing ownership on create and subsequent modifications.
     */
    match /media/{mediaId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages comments for a specific media item.
     * @path /media/{mediaId}/comments/{commentId}
     * @allow (get, list) Public read access to all comments.
     * @allow (create) Only signed-in users can create comments.
     * @allow (update, delete) Only the comment's author can update or delete it.
     * @principle Allows public read access with owner-only writes, enforcing ownership on create and subsequent modifications.
     */
    match /media/{mediaId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages likes for a specific media item.
     * @path /media/{mediaId}/likes/{userId}
     * @allow (get, list) Public read access to all likes.
     * @allow (create, delete) Any signed in user can like and unlike.
     * @principle Public read, signed-in users can like/unlike.
     */
    match /media/{mediaId}/likes/{userId} {
      allow get, list: if true;
      allow create, delete: if isSignedIn();
      allow update: if false;
    }

    /**
     * @description Manages channel data.
     * @path /channels/{channelId}
     * @allow (get, list) Public read access to all channels.
     * @allow (create, update, delete) Only the channel owner can create, update, or delete the channel.
     * @principle Allows public read with owner-only writes.
     */
    match /channels/{channelId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages public playlists.
     * @path /playlists/{playlistId}
     * @allow (get, list) Public read access to all playlists.
     * @allow (create) Only signed-in users can create playlists.
     * @allow (update, delete) Only the creator can update or delete the playlist.
     * @principle Allows public read with owner-only writes, enforcing ownership on create and subsequent modifications.
     */
    match /playlists/{playlistId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages user-specific horoscope data.
     * @path /users/{userId}/horoscopes/{horoscopeId}
     * @allow (get, list, create, update, delete) User with ID 'user123' can manage their horoscopes.
     * @deny (create, get, list, update, delete) User with ID 'user456' cannot access horoscopes for user 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/horoscopes/{horoscopeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages deity data.
     * @path /deities/{deityId}
     * @allow (get, list) Public read access to all deities.
     * @allow create, update, delete: if false; // TODO: Add role-based admin validation
     * @principle Allows public read, admin-only writes (TODO).
     */
    match /deities/{deityId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based admin validation
    }

    /**
     * @description Manages shop data.
     * @path /shops/{shopId}
     * @allow (get, list) Public read access to all shops.
     * @allow (create) Only signed-in users can create shops. MUST ensure shop.ownerId == request.auth.uid in the create request.
     * @allow (update, delete) Only the owner of the shop can update or delete it.
     * @principle Allows public read with owner-only writes, enforcing ownership on create and subsequent modifications.
     */
    match /shops/{shopId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages product data.
     * @path /products/{productId}
     * @allow (get, list) Public read access to all products.
     * allow create, update, delete: if false; // TODO: Add shop owner validation
     * @principle Allows public read, shop owner-only writes (TODO).
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add shop owner validation
    }

    /**
     * @description Manages temple data.
     * @path /temples/{templeId}
     * @allow (get, list) Public read access to all temples.
     * @allow create, update, delete: if false; // TODO: Add role-based admin validation
     * @principle Allows public read, admin-only writes (TODO).
     */
    match /temples/{templeId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based admin validation
    }

    /**
     * @description Manages user reviews for a specific temple.
     * @path /temples/{templeId}/reviews/{reviewId}
     * @allow (get, list) Public read access to all reviews.
     * @allow (create) Only signed-in users can create reviews.
     * @allow (update, delete) Only the review's author can update or delete it.
     * @principle Allows public read access with owner-only writes, enforcing ownership on create and subsequent modifications.
     */
    match /temples/{templeId}/reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages user posts for a specific temple.
     * @path /temples/{templeId}/posts/{postId}
     * @allow (get, list) Public read access to all posts.
     * @allow (create) Only signed-in users can create posts.
     * @allow (update, delete) Only the post's author can update or delete it.
     * @principle Allows public read access with owner-only writes, enforcing ownership on create and subsequent modifications.
     */
    match /temples/{templeId}/posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages story data.
     * @path /stories/{storyId}
     * @allow (get, list) Public read access to all stories.
     * @allow create, update, delete: if false; // TODO: Add role-based admin validation
     * @principle Allows public read, admin-only writes (TODO).
     */
    match /stories/{storyId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based admin validation
    }

    /**
     * @description Manages epic hero data.
     * @path /epicHeroes/{heroId}
     * @allow (get, list) Public read access to all heroes.
     * @allow create, update, delete: if false; // TODO: Add role-based admin validation
     * @principle Allows public read, admin-only writes (TODO).
     */
    match /epicHeroes/{heroId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based admin validation
    }

    /**
     * @description Manages ritual data.
     * @path /rituals/{ritualId}
     * @allow (get, list) Public read access to all rituals.
     * @allow create, update, delete: if false; // TODO: Add role-based admin validation
     * @principle Allows public read, admin-only writes (TODO).
     */
    match /rituals/{ritualId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based admin validation
    }

    /**
     * @description Manages daily panchang data.
     * @path /panchang/{date}
     * @allow (get, list) Public read access to all panchang data.
     * @allow create, update, delete: if false; // TODO: Add role-based admin validation
     * @principle Allows public read, admin-only writes (TODO).
     */
    match /panchang/{date} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based admin validation
    }

    /**
     * @description Manages festival data.
     * @path /festivals/{festivalId}
     * @allow (get, list) Public read access to all festivals.
     * @allow create, update, delete: if false; // TODO: Add role-based admin validation
     * @principle Allows public read, admin-only writes (TODO).
     */
    match /festivals/{festivalId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based admin validation
    }

    /**
     * @description Manages community groups.
     * @path /groups/{groupId}
     * @allow (get, list) Public read access to all groups.
     * @allow (create) Only signed-in users can create groups.
     * @allow (update, delete) Only group admins can update or delete a group. // TODO: Add group admin check
     * @principle Allows public read with restricted writes based on group admin role.
     */
    match /groups/{groupId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if false; // TODO: Add group admin check
      allow delete: if false; // TODO: Add group admin check
    }

    /**
     * @description Manages group membership.
     * @path /groups/{groupId}/members/{userId}
     * @allow (get, list) Any signed-in user can list and get membership.
     * @allow (create, delete) Any signed-in user can join/leave a group.
     * @allow update: if false;
     * @principle Signed-in users can manage their own membership.
     */
    match /groups/{groupId}/members/{userId} {
      allow get, list: if isSignedIn();
      allow create, delete: if isSignedIn();
      allow update: if false;
    }

    /**
     * @description Manages posts within a specific group.
     * @path /posts/{postId}
     * @allow (get, list) Public read access to all posts.
     * @allow (create) Only signed-in users can create posts.
     * @allow (update, delete) Only the post's author can update or delete it.
     * @principle Allows public read access with owner-only writes, enforcing ownership on create and subsequent modifications.
     */
    match /posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages comments for a specific post within a group.
     * @path /posts/{postId}/comments/{commentId}
     * @allow (get, list) Public read access to all comments.
     * @allow (create) Only signed-in users can create comments.
     * @allow (update, delete) Only the comment's author can update or delete it.
     * @principle Allows public read access with owner-only writes, enforcing ownership on create and subsequent modifications.
     */
    match /posts/{postId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages likes for a specific forum post within a group.
     * @path /posts/{postId}/likes/{userId}
     * @allow (get, list) Public read access to all likes.
     * @allow (create, delete) Any signed in user can like and unlike.
     * @principle Public read, signed-in users can like/unlike.
     */
    match /posts/{postId}/likes/{userId} {
      allow get, list: if true;
      allow create, delete: if isSignedIn();
      allow update: if false;
    }

    /**
     * @description Manages community challenges.
     * @path /challenges/{challengeId}
     * @allow (get, list) Public read access to all challenges.
     * @allow create, update, delete: if false; // TODO: Add role-based admin validation
     * @principle Allows public read, admin-only writes (TODO).
     */
    match /challenges/{challengeId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based admin validation
    }

      /**
       * @description Manages global chanting contests.
       * @path /contests/{contestId}
       * @allow (get, list) Public read access to all contests.
       * @allow create, update, delete: if false; // TODO: Add role-based admin validation
       * @principle Allows public read, admin-only writes (TODO).
       */
    match /contests/{contestId} {
      allow get, list: if true;
        allow create, update, delete: if false; // TODO: Add role-based admin validation
    }

    /**
     * @description Manages user-submitted manifestation techniques and stories.
     * @path /manifestations/{manifestationId}
     * @allow (get, list) Public read access to all manifestation posts.
     * @allow (create) Only signed-in users can create manifestation posts.
     * @allow (update, delete) Only the manifestation post's author can update or delete it.
     * @principle Allows public read access with owner-only writes, enforcing ownership on create and subsequent modifications.
     */
    match /manifestations/{manifestationId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

     /**
      * @description Manages comments on a manifestation post.
      * @path /manifestations/{manifestationId}/comments/{commentId}
      * @allow (get, list) Public read access to all comments.
      * @allow (create) Only signed-in users can create comments.
      * @allow (update, delete) Only the comment's author can update or delete it.
      * @principle Allows public read access with owner-only writes, enforcing ownership on create and subsequent modifications.
      */
    match /manifestations/{manifestationId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages likes for a manifestation post.
     * @path /manifestations/{manifestationId}/likes/{userId}
     * @allow (get, list) Public read access to all likes.
     * @allow (create, delete) Any signed in user can like and unlike.
     * @principle Public read, signed-in users can like/unlike.
     */
    match /manifestations/{manifestationId}/likes/{userId} {
      allow get, list: if true;
      allow create, delete: if isSignedIn();
      allow update: if false;
    }
  }
}