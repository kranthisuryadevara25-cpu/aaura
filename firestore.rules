/**
 * @file Firestore Security Rules for Aaura App
 * @core_philosophy This ruleset employs a hybrid security model. User-specific data is secured via strict ownership,
 * while public content is generally readable but requires ownership for modification.
 * @data_structure The Firestore database is structured with user data nested under `/users/{userId}`,
 * public content (media, temples, etc.) in top-level collections, and subcollections for relational data (likes, followers, etc.).
 * @key_security_decisions
 * - User listing is disallowed for privacy.
 * - All write operations require user authentication.
 * - Roles or shared access patterns are not implemented.
 * - To ensure security and efficiency, data necessary for authorization is denormalized directly into the documents.
 * For instance, media documents contain an 'authorId' field to quickly verify ownership.
 * @authorization_denormalization To ensure security and efficiency, data necessary for authorization is denormalized directly into the documents.
 *   For instance, media documents contain an 'authorId' field to quickly verify ownership. This avoids costly `get()` calls in the security rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Root-level access control.
     * @path /
     * @allow (get, list) Any authenticated user.
     * @deny (create, update, delete) No one can directly create, update, or delete at the root.
     * @principle Prevents accidental modification of the database root.
     */
    match /{document=**} {
      allow read: if true;
      allow create, update, delete: if false;
    }

    // Helper function to check if the user is signed in.
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if the authenticated user's UID matches the provided userId.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Helper function to check if the authenticated user is the owner of an existing document.
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }


    /**
     * @description Grants access to user profiles based on ownership.
     * @path /users/{userId}
     * @allow (create) The user can create their own profile if the userId matches their auth UID (self-creation).
     * @allow (get, list, update, delete) The user can get, list, update, or delete their own profile.
     * @deny (create, update, delete) A user cannot create, update, or delete another user's profile.
     * @principle Enforces strict user ownership of profile data.
     */
    match /users/{userId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants access to a user's followers based on ownership.
     * @path /users/{userId}/followers/{followerId}
     * @allow (get, list) The user can list their own followers.
     * @allow (create) Any signed in user can follow another user if the followerId matches their auth UID.
     * @allow (delete) The user can remove a follower if the followerId matches their auth UID.
     * @deny (create, delete) A user cannot create or delete another user's followers.
     * @principle Enforces strict user ownership of follower data.
     */
    match /users/{userId}/followers/{followerId} {
        allow get, list: if isOwner(userId);
        allow create: if isSignedIn() && request.auth.uid == followerId;
        allow update: if false;
        allow delete: if isSignedIn() && request.auth.uid == followerId;
    }

    /**
     * @description Grants access to the users a user is following based on ownership.
     * @path /users/{userId}/following/{followedId}
     * @allow (get, list) The user can list who they are following.
     * @allow (create) Any signed in user can follow another user if the userId matches their auth UID.
     * @allow (delete) The user can unfollow another user if the userId matches their auth UID.
     * @deny (create, delete) A user cannot create or delete another user's following relationships for another user.
     * @principle Enforces strict user ownership of following data.
     */
    match /users/{userId}/following/{followedId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if false;
        allow delete: if isOwner(userId);
    }

    /**
     * @description Grants access to user preferences based on ownership.
     * @path /users/{userId}/preferences/default
     * @allow (get, list, update, delete) The user can get, list, update, or delete their own preferences.
     * @allow (create) The user can create their own preferences.
     * @deny (create, update, delete) A user cannot create, update, or delete another user's preferences.
     * @principle Enforces strict user ownership of preference data.
     */
    match /users/{userId}/preferences/default {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants access to user badges based on ownership.
     * @path /users/{userId}/badges/{badgeId}
     * @allow (get, list) The user can get and list their own badges.
     * @deny (create, update, delete) No one can create, update, or delete a user's badges except the server.
     * @principle Enforces strict user ownership of badge data, with server-only modification.
     */
    match /users/{userId}/badges/{badgeId} {
      allow get, list: if isOwner(userId);
      allow create, update, delete: if false;
    }

    /**
     * @description Grants access to user bookmarks based on ownership.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (get, list, create, delete) The user can get, list, create, and delete their own bookmarks.
     * @deny (update) Users cannot update bookmarks, only create or delete them.
     * @principle Enforces strict user ownership of bookmark data.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants access to user virtual offerings based on ownership.
     * @path /users/{userId}/virtualOfferings/{offeringId}
     * @allow (get, list, create, delete) The user can get, list, create, and delete their own virtual offerings.
     * @deny (update) Users cannot update virtual offerings, only create or delete them.
     * @principle Enforces strict user ownership of virtual offering data.
     */
    match /users/{userId}/virtualOfferings/{offeringId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants access to user cart items based on ownership.
     * @path /users/{userId}/cart/{productId}
     * @allow (get, list, create, update, delete) The user can manage items in their own cart.
     * @deny (create, update, delete) A user cannot manage another user's cart.
     * @principle Enforces strict user ownership of cart data.
     */
    match /users/{userId}/cart/{productId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants access to user orders based on ownership.
     * @path /users/{userId}/orders/{orderId}
     * @allow (get, list) The user can view their own order history.
     * @deny (create, update, delete) No one can create, update, or delete orders except the server.
     * @principle Enforces strict user ownership of order data, with server-only modification.
     */
    match /users/{userId}/orders/{orderId} {
      allow get, list: if isOwner(userId);
      allow create, update, delete: if false;
    }

    /**
     * @description Grants access to user playlists based on ownership.
     * @path /users/{userId}/playlists/{playlistId}
     * @allow (get, list, create, delete) The user can create, get, list and delete their own playlists.
     * @deny (update) A user cannot update playlist metadata.
     * @principle Enforces strict user ownership of playlist data.
     */
    match /users/{userId}/playlists/{playlistId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

       /**
     * @description Grants access to user challenges progress based on ownership.
     * @path /users/{userId}/challenges/{challengeId}
     * @allow (get, list, create, update) The user can create, get, list and update their own challenges progress.
     * @deny (delete) Users cannot delete their challenge progress.
     * @principle Enforces strict user ownership of challenge progress data.
     */
    match /users/{userId}/challenges/{challengeId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if false;
    }

    /**
     * @description Grants access to media documents.
     * @path /media/{mediaId}
     * @allow (get, list) Any authenticated user can read media.
     * @allow (create) Any authenticated user can create media.
     * @allow (update, delete) Only the owner (creator) of the media can update or delete it.
     * @deny (create, update, delete) If the 'authorId' field is missing, writes are denied.
     * @principle Public read, owner-only writes for media content.
     */
    match /media/{mediaId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Grants access to comments on media documents.
     * @path /media/{mediaId}/comments/{commentId}
     * @allow (get, list) Any authenticated user can read comments.
     * @allow (create) Any authenticated user can create comments.
     * @allow (update, delete) Only the owner (creator) of the comment can update or delete it.
     * @principle Public read, owner-only writes for comments on media.
     */
    match /media/{mediaId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

       /**
        * @description Grants access to likes on media documents.
        * @path /media/{mediaId}/likes/{userId}
        * @allow (get, list) Any authenticated user can read likes.
        * @allow (create) Any signed in user can like a media if the userId matches their auth UID.
        * @allow (delete) The user can unlike a media if the userId matches their auth UID.
        * @principle Users can only like/unlike content using their own id.
        */
    match /media/{mediaId}/likes/{userId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update: if false;
        allow delete: if isSignedIn() && request.auth.uid == userId;
    }


    /**
     * @description Grants access to channel documents.
     * @path /channels/{channelId}
     * @allow (get, list) Any authenticated user can read channels.
     * @allow (create, update, delete) Only the owner (creator) of the channel can create, update, or delete it.
     * @principle Owner-only access for channel management.
     */
    match /channels/{channelId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Grants access to playlist documents.
     * @path /playlists/{playlistId}
     * @allow (get, list) Any authenticated user can read playlists.
     * @allow (create, update, delete) Only the owner (creator) of the playlist can create, update, or delete it.
     * @principle Owner-only access for playlist management.
     */
    match /playlists/{playlistId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.creatorId);
      allow delete: if isExistingOwner(resource.data.creatorId);
    }

    /**
     * @description Grants access to horoscope documents.
     * @path /users/{userId}/horoscopes/{horoscopeId}
     * @allow (get, list) The user can read their own horoscopes.
     * @deny (create, update, delete) No one can create, update, or delete horoscopes except the server.
     * @principle Enforces strict user ownership of horoscope data, with server-only modification.
     */
    match /users/{userId}/horoscopes/{horoscopeId} {
      allow get, list: if isOwner(userId);
      allow create, update, delete: if false;
    }

    /**
     * @description Grants access to deity documents.
     * @path /deities/{deityId}
     * @allow (get, list) Any authenticated user can read deity information.
     * @deny (create, update, delete) No one can create, update, or delete deity information except the server.
     * @principle Public read access for deity data, with server-only modification.
     */
    match /deities/{deityId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Grants access to shop documents.
     * @path /shops/{shopId}
     * @allow (get, list) Any authenticated user can read shop information.
     * @allow (create, update, delete) Only the owner (creator) of the shop can create, update, or delete it.
     * @principle Owner-only access for shop management.
     */
    match /shops/{shopId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.ownerId;
      allow update: if isExistingOwner(resource.data.ownerId);
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Grants access to product documents.
     * @path /products/{productId}
     * @allow (get, list) Any authenticated user can read product information.
     * @deny (create, update, delete) No one can create, update, or delete products except the server.
     * @principle Public read access for product data, with server-only modification.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Grants access to temple documents.
     * @path /temples/{templeId}
     * @allow (get, list) Any authenticated user can read temple information.
     * @deny (create, update, delete) No one can create, update, or delete temple information except the server.
     * @principle Public read access for temple data, with server-only modification.
     */
    match /temples/{templeId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Grants access to reviews for a specific temple.
     * @path /temples/{templeId}/reviews/{reviewId}
     * @allow (get, list) Any authenticated user can read reviews.
     * @allow (create) Any authenticated user can create reviews.
     * @allow (update, delete) Only the owner (creator) of the review can update or delete it.
     * @principle Public read, owner-only writes for temple reviews.
     */
    match /temples/{templeId}/reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

   /**
    * @description Grants access to posts for a specific temple.
    * @path /temples/{templeId}/posts/{postId}
    * @allow (get, list) Any authenticated user can read temple posts.
    * @allow (create) Any authenticated user can create temple posts.
    * @allow (update, delete) Only the owner (creator) of the post can update or delete it.
    * @principle Public read, owner-only writes for temple posts.
    */
    match /temples/{templeId}/posts/{postId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if isExistingOwner(resource.data.authorId);
        allow delete: if isExistingOwner(resource.data.authorId);
    }

     /**
      * @description Grants access to stories documents.
      * @path /stories/{storyId}
      * @allow (get, list) Any authenticated user can read stories.
      * @deny (create, update, delete) No one can create, update, or delete stories except the server.
      * @principle Public read access for stories, with server-only modification.
      */
    match /stories/{storyId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Grants access to epic hero documents.
     * @path /epicHeroes/{heroId}
     * @allow (get, list) Any authenticated user can read epic hero information.
     * @deny (create, update, delete) No one can create, update, or delete epic hero information except the server.
     * @principle Public read access for epic hero data, with server-only modification.
     */
    match /epicHeroes/{heroId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Grants access to ritual documents.
     * @path /rituals/{ritualId}
     * @allow (get, list) Any authenticated user can read ritual information.
     * @deny (create, update, delete) No one can create, update, or delete ritual information except the server.
     * @principle Public read access for ritual data, with server-only modification.
     */
    match /rituals/{ritualId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Grants access to panchang documents.
     * @path /panchang/{date}
     * @allow (get, list) Any authenticated user can read panchang information.
     * @deny (create, update, delete) No one can create, update, or delete panchang information except the server.
     * @principle Public read access for panchang data, with server-only modification.
     */
    match /panchang/{date} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Grants access to festival documents.
     * @path /festivals/{festivalId}
     * @allow (get, list) Any authenticated user can read festival information.
     * @deny (create, update, delete) No one can create, update, or delete festival information except the server.
     * @principle Public read access for festival data, with server-only modification.
     */
    match /festivals/{festivalId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Grants access to group documents.
     * @path /groups/{groupId}
     * @allow (get, list) Any authenticated user can read group information.
     * @deny (create, update, delete) No one can create, update, or delete group information except the server.
     * @principle Public read access for groups data, with server-only modification.
     */
    match /groups/{groupId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Grants access to group members.
     * @path /groups/{groupId}/members/{userId}
     * @allow (get, list) Any authenticated user can read group membership information.
     * @allow (create) Any signed in user can join a group if the userId matches their auth UID.
     * @allow (delete) The user can leave a group if the userId matches their auth UID.
     */
    match /groups/{groupId}/members/{userId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update: if false;
        allow delete: if isSignedIn() && request.auth.uid == userId;
    }

     /**
      * @description Grants access to posts within a specific group.
      * @path /groups/{groupId}/posts/{postId}
      * @allow (get, list) Any authenticated user can read group posts.
      * @allow (create) Any authenticated user can create group posts.
      * @allow (update, delete) Only the owner (creator) of the post can update or delete it.
      * @principle Public read, owner-only writes for group posts.
      */
    match /groups/{groupId}/posts/{postId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if isExistingOwner(resource.data.authorId);
        allow delete: if isExistingOwner(resource.data.authorId);
    }

      /**
       * @description Grants access to comments within a specific group post.
       * @path /groups/{groupId}/posts/{postId}/comments/{commentId}
       * @allow (get, list) Any authenticated user can read comments on a group post.
       * @allow (create) Any authenticated user can create comments on a group post.
       * @allow (update, delete) Only the owner (creator) of the comment can update or delete it.
       * @principle Public read, owner-only writes for comments on group posts.
       */
    match /groups/{groupId}/posts/{postId}/comments/{commentId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if isExistingOwner(resource.data.authorId);
        allow delete: if isExistingOwner(resource.data.authorId);
    }


      /**
       * @description Grants access to likes on forum posts within a group.
       * @path /groups/{groupId}/posts/{postId}/likes/{userId}
       * @allow (get, list) Any authenticated user can read likes.
       * @allow (create) Any signed in user can like a post if the userId matches their auth UID.
       * @allow (delete) The user can unlike a post if the userId matches their auth UID.
       * @principle Users can only like/unlike content using their own id.
       */
    match /groups/{groupId}/posts/{postId}/likes/{userId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update: if false;
        allow delete: if isSignedIn() && request.auth.uid == userId;
    }
    /**
     * @description Grants access to challenge documents.
     * @path /challenges/{challengeId}
     * @allow (get, list) Any authenticated user can read challenge information.
     * @deny (create, update, delete) No one can create, update, or delete challenge information except the server.
     * @principle Public read access for challenges data, with server-only modification.
     */
    match /challenges/{challengeId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

       /**
        * @description Grants access to posts.
        * @path /posts/{postId}
        * @allow (get, list) Any authenticated user can read posts.
        * @allow (create) Any authenticated user can create posts.
        * @allow (update, delete) Only the owner (creator) of the post can update or delete it.
        * @principle Public read, owner-only writes for post content.
        */
    match /posts/{postId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.auth.uid == request.resource.data.authorId;
        allow update: if isExistingOwner(resource.data.authorId);
        allow delete: if isExistingOwner(resource.data.authorId);
    }

  }
}