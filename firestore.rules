/**
 * @file Firestore Security Rules for Aaura App
 * @core_philosophy This ruleset enforces a strict user-ownership model for personal data while allowing public read access to certain content.
 * Data validation is relaxed for rapid prototyping, focusing on authorization.
 * @data_structure Data is organized into top-level collections for public content (e.g., /media, /temples) and user subcollections for private data (e.g., /users/{userId}/bookmarks).
 * @key_security_decisions Listing all users is disallowed.  Write operations are generally restricted to the owner of the data or, in some cases, completely denied where write access is not appropriate for clients.  Public read access is granted to certain collections to facilitate content discovery.  To improve security and performance, the rules utilize data denormalization to avoid costly `get()` operations.
 * @denormalization_for_authorization The rules enforce ownership by requiring the `userId` to match `request.auth.uid` for write operations within user subcollections.
 * @structural_segregation The app uses separate collections for public (top-level) and private (user-specific) data. For example, media content is stored in the `/media` collection, while user-specific bookmarks are stored in `/users/{userId}/bookmarks`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource and the resource exists.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Security rules for user profiles.
     * @path /users/{userId}
     * @allow (create) Signed-in user can create their own profile.
     * @allow (get, update, delete) Signed-in user can access and modify their own profile.
     * @deny (create) Non-signed-in user cannot create a profile.
     * @deny (get, update, delete) Non-signed-in user cannot access or modify any profile.
     * @principle Enforces document ownership for writes, prevents unauthorized access.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for followers subcollection. Only the user can manage their followers.
     * @path /users/{userId}/followers/{followerId}
     * @allow (create) Signed-in user can create followers to their own profile.
     * @allow (get, update, delete) Signed-in user can access and modify their own followers.
     * @deny (create) Non-signed-in user cannot create a followers.
     * @deny (get, update, delete) Non-signed-in user cannot access or modify any followers.
     * @principle Enforces document ownership for writes, prevents unauthorized access.
     */
    match /users/{userId}/followers/{followerId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for following subcollection. Only the user can manage who they are following.
     * @path /users/{userId}/following/{followedId}
     * @allow (create) Signed-in user can create following to their own profile.
     * @allow (get, update, delete) Signed-in user can access and modify their own following.
     * @deny (create) Non-signed-in user cannot create a following.
     * @deny (get, update, delete) Non-signed-in user cannot access or modify any following.
     * @principle Enforces document ownership for writes, prevents unauthorized access.
     */
    match /users/{userId}/following/{followedId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for user preferences.
     * @path /users/{userId}/preferences/default
     * @allow (get, update) Signed-in user can access and modify their own preferences.
     * @deny (create, delete) No direct creation or deletion via the client.
     * @principle Restricts access to a user's own data tree, prevents unauthorized data manipulation.
     */
    match /users/{userId}/preferences/default {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if false;
      allow update: if isExistingOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Security rules for user badges.
     * @path /users/{userId}/badges/{badgeId}
     * @allow (get, list) Signed-in user can read their own badges.
     * @deny (create, update, delete) No direct client modifications.
     * @principle Read-only access to a user's own badges.
     */
    match /users/{userId}/badges/{badgeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Security rules for user bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (get, list, create, update, delete) Signed-in user can manage their own bookmarks.
     * @deny (create, update, delete) Non-signed-in user cannot access or modify any bookmarks.
     * @principle Enforces document ownership for writes, prevents unauthorized access.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for virtual offerings.
     * @path /users/{userId}/virtualOfferings/{offeringId}
     * @allow (get, list, create, update, delete) Signed-in user can manage their own virtual offerings.
     * @deny (create, update, delete) Non-signed-in user cannot access or modify any virtual offerings.
     * @principle Enforces document ownership for writes, prevents unauthorized access.
     */
    match /users/{userId}/virtualOfferings/{offeringId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for user cart items.
     * @path /users/{userId}/cart/{productId}
     * @allow (get, list, create, update, delete) Signed-in user can manage their own cart items.
     * @deny (create, update, delete) Non-signed-in user cannot access or modify any cart items.
     * @principle Enforces document ownership for writes, prevents unauthorized access.
     */
    match /users/{userId}/cart/{productId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for user orders.
     * @path /users/{userId}/orders/{orderId}
     * @allow (get, list) Signed-in user can read their own orders.
     * @deny (create, update, delete) No direct client modifications.
     * @principle Read-only access to a user's own orders.
     */
    match /users/{userId}/orders/{orderId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Security rules for media content.
     * @path /media/{mediaId}
     * @allow (get, list) Public read access for all media.
     * @deny (create, update, delete) Only the creator (userId) can modify or delete media.
     * @principle Public read access with owner-only writes.
     */
    match /media/{mediaId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Security rules for comments on media content.
     * @path /media/{mediaId}/comments/{commentId}
     * @allow (get, list) Public read access for all comments.
     * @allow (create) Any signed-in user can create a comment.
     * @allow (update, delete) Only the author of the comment can modify or delete it.
     * @principle Public read access, user-owned writes.
     */
    match /media/{mediaId}/comments/{commentId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Security rules for likes on media content.
     * @path /media/{mediaId}/likes/{userId}
     * @allow (get, list) Public read access for all likes.
     * @allow (create, delete) Signed-in user can like/unlike media.
     * @deny (update) No direct client updates.
     */
    match /media/{mediaId}/likes/{userId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if isSignedIn();
    }

    /**
     * @description Security rules for channels.
     * @path /channels/{channelId}
     * @allow (get, list) Public read access for all channels.
     * @allow (create, update, delete) Only the channel owner (userId) can modify or delete it.
     * @principle Public read access with owner-only writes.
     */
    match /channels/{channelId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Security rules for user horoscopes.
     * @path /users/{userId}/horoscopes/{horoscopeId}
     * @allow (get, list) Signed-in user can read their own horoscopes.
     * @deny (create, update, delete) No direct client modifications.
     * @principle Read-only access to a user's own horoscopes.
     */
    match /users/{userId}/horoscopes/{horoscopeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Security rules for deities.
     * @path /deities/{deityId}
     * @allow (get, list) Public read access for all deities.
     * @deny (create, update, delete) No direct client modifications.
     * @principle Public read access, no client writes.
     */
    match /deities/{deityId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Security rules for shops.
     * @path /shops/{shopId}
     * @allow (get, list) Public read access for all shops.
     * @allow (create, update, delete) Only the shop owner can modify or delete it.
     * @principle Public read access with owner-only writes.
     */
    match /shops/{shopId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.ownerId);
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Security rules for products.
     * @path /products/{productId}
     * @allow (get, list) Public read access for all products.
     * @deny (create, update, delete) No direct client modifications.
     * @principle Public read access, no client writes.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Security rules for temples.
     * @path /temples/{templeId}
     * @allow (get, list) Public read access for all temples.
     * @deny (create, update, delete) No direct client modifications.
     * @principle Public read access, no client writes.
     */
    match /temples/{templeId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Security rules for temple reviews.
     * @path /temples/{templeId}/reviews/{reviewId}
     * @allow (get, list) Public read access for all reviews.
     * @allow (create) Any signed-in user can create a review.
     * @allow (update, delete) Only the author of the review can modify or delete it.
     * @principle Public read access, user-owned writes.
     */
    match /temples/{templeId}/reviews/{reviewId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Security rules for stories.
     * @path /stories/{storyId}
     * @allow (get, list) Public read access for all stories.
     * @deny (create, update, delete) No direct client modifications.
     * @principle Public read access, no client writes.
     */
    match /stories/{storyId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Security rules for characters.
     * @path /characters/{characterId}
     * @allow (get, list) Public read access for all characters.
     * @deny (create, update, delete) No direct client modifications.
     * @principle Public read access, no client writes.
     */
    match /characters/{characterId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Security rules for rituals.
     * @path /rituals/{ritualId}
     * @allow (get, list) Public read access for all rituals.
     * @deny (create, update, delete) No direct client modifications.
     * @principle Public read access, no client writes.
     */
    match /rituals/{ritualId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Security rules for panchang data.
     * @path /panchang/{date}
     * @allow (get, list) Public read access for all panchang data.
     * @deny (create, update, delete) No direct client modifications.
     * @principle Public read access, no client writes.
     */
    match /panchang/{date} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Security rules for festivals.
     * @path /festivals/{festivalId}
     * @allow (get, list) Public read access for all festivals.
     * @deny (create, update, delete) No direct client modifications.
     * @principle Public read access, no client writes.
     */
    match /festivals/{festivalId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Security rules for posts in the community forum.
     * @path /posts/{postId}
     * @allow (get, list) Public read access for all posts.
     * @allow (create) Any signed-in user can create a post.
     * @allow (update, delete) Only the author of the post can modify or delete it.
     * @principle Public read access, user-owned writes.
     */
    match /posts/{postId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Security rules for comments on forum posts.
     * @path /posts/{postId}/comments/{commentId}
     * @allow (get, list) Public read access for all comments.
     * @allow (create) Any signed-in user can create a comment.
     * @allow (update, delete) Only the author of the comment can modify or delete it.
     * @principle Public read access, user-owned writes.
     */
    match /posts/{postId}/comments/{commentId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Security rules for likes on forum posts.
     * @path /posts/{postId}/likes/{userId}
     * @allow (get, list) Public read access for all likes.
     * @allow (create, delete) Signed-in user can like/unlike a post.
     * @deny (update) No direct client updates.
     */
    match /posts/{postId}/likes/{userId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if isSignedIn();
    }
  }
}