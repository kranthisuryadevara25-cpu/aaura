rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if a user is authenticated.
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if the current user is the owner of a document.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Allow anyone to read public content, but only authenticated users to write.
    // Specific write rules are defined for each collection below.
    match /{document=**} {
      allow read: if true;
      allow write: if isSignedIn();
    }
    
    // User profile can only be created by the user themselves, and only updated by the owner.
    match /users/{userId} {
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }
    
    // Subcollections for users (e.g., cart, orders, followers) can only be accessed by the owner.
    match /users/{userId}/{collection}/{docId} {
        allow read, write, delete: if isOwner(userId);
    }

    match /users/{userId}/contestProgress/{contestId} {
        allow get, list: if isOwner(userId);
        allow create, update: if isSignedIn() && request.auth.uid == userId
            && request.resource.data.submissionCount is int
            && request.resource.data.lastSubmissionTime is timestamp;
        allow delete: if isOwner(userId);
    }
    
    // Rules for contests and their subcollections
    match /contests/{contestId} {
      allow get, list: if true;

      // Allow authenticated users to update the total chant count, but only by one.
      allow update: if isSignedIn() && request.resource.data.totalChants == resource.data.totalChants + 1;
      
      // Only admins should be able to create or delete contests (simplified for now).
      // A more robust rule would check for an admin role in the user's custom claims.
      allow create, delete: if isSignedIn(); 

      // Rules for the 'chants' subcollection within each contest
      match /chants/{chantId} {
        allow get, list: if true; // Public read access for the 'RecentChants' component
        
        // Rules for creating a new chant document
        allow create: if isSignedIn()
          && request.resource.data.authorId == request.auth.uid
          && request.resource.data.text == "Jai Shri Ram"
          && request.resource.data.createdAt == request.time
          && request.resource.data.displayName is string
          && (
            !exists(/databases/$(database)/documents/users/$(request.auth.uid)/contestProgress/$(contestId))
            || get(/databases/$(database)/documents/users/$(request.auth.uid)/contestProgress/$(contestId)).data.lastSubmissionTime.date() != request.time.date()
            || get(/databases/$(database)/documents/users/$(request.auth.uid)/contestProgress/$(contestId)).data.submissionCount < 5
          );

        // Chants are immutable once created.
        allow update, delete: if false; 
      }
    }
    
  }
}
