/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for personal data and allows public read access for certain content types.
 *
 * Data Structure:
 * - User profiles and associated data are nested under `/users/{userId}`.
 * - Public content (media, temples, deities, stories, etc.) resides in top-level collections.
 * - Likes are stored in subcollections for scalability.
 * - Follower/following relationships are managed in user subcollections.
 *
 * Key Security Decisions:
 * - User data is generally accessible only to the authenticated user.
 * - Public content is readable by all but requires authentication for creation, updates, and deletion, with ownership enforced.
 * - User listing is disabled to prevent data scraping.
 * - Timestamps and complex data types are not validated for prototyping speed.
 *
 * Denormalization for Authorization:
 * - Many write rules validate ownership by checking the `request.auth.uid` against an `authorId`, `ownerId`, or `userId` field in the document.
 * - For instance, when creating a media document, `request.resource.data.userId == request.auth.uid` must be true.
 *
 * Structural Segregation:
 * - Public content (e.g., published stories) and private content (e.g., user bookmarks) are stored in separate collections, enhancing security and performance for list operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a user to read and write their own profile data.
     * @path /users/{userId}
     * @allow (create, update, delete, get, list) if the user is signed in and their UID matches the userId.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to read and write their contest progress.
     * @path /users/{userId}/contestProgress/{contestId}
     * @allow (create, update, delete, get, list) if the user is signed in and their UID matches the userId.
     */
     match /users/{userId}/contestProgress/{contestId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to read and write their followers.
     * @path /users/{userId}/followers/{followerId}
     * @allow (create, update, delete, get, list) if the user is signed in and their UID matches the userId.
     */
    match /users/{userId}/followers/{followerId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to read and write their following list.
     * @path /users/{userId}/following/{followedId}
     * @allow (create, update, delete, get, list) if the user is signed in and their UID matches the userId.
     */
    match /users/{userId}/following/{followedId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to read and write their preferences.
     * @path /users/{userId}/preferences/default
     * @allow (create, update, delete, get, list) if the user is signed in and their UID matches the userId.
     */
    match /users/{userId}/preferences/default {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to read and write their badges.
     * @path /users/{userId}/badges/{badgeId}
     * @allow (create, update, delete, get, list) if the user is signed in and their UID matches the userId.
     */
    match /users/{userId}/badges/{badgeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to read and write their bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (create, update, delete, get, list) if the user is signed in and their UID matches the userId.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to read and write their virtual offerings.
     * @path /users/{userId}/virtualOfferings/{offeringId}
     * @allow (create, update, delete, get, list) if the user is signed in and their UID matches the userId.
     */
    match /users/{userId}/virtualOfferings/{offeringId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to read and write their shopping cart.
     * @path /users/{userId}/cart/{productId}
     * @allow (create, update, delete, get, list) if the user is signed in and their UID matches the userId.
     */
    match /users/{userId}/cart/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to read and write their orders.
     * @path /users/{userId}/orders/{orderId}
     * @allow (create, update, delete, get, list) if the user is signed in and their UID matches the userId.
     */
    match /users/{userId}/orders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to read and write their playlists.
     * @path /users/{userId}/playlists/{playlistId}
     * @allow (create, update, delete, get, list) if the user is signed in and their UID matches the userId.
     */
    match /users/{userId}/playlists/{playlistId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

     /**
     * @description Allows a user to read and write their community challenge progress.
     * @path /users/{userId}/challenges/{challengeId}
     * @allow (create, update, delete, get, list) if the user is signed in and their UID matches the userId.
     */
      match /users/{userId}/challenges/{challengeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows anyone to read media, but only the owner can create, update, or delete.
     * @path /media/{mediaId}
     * @allow (get, list) to everyone.
     * @allow (create) if the user is signed in and the userId field matches the authenticated user's UID.
     */
    match /media/{mediaId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn() && resource.data.userId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Allows anyone to read media comments, but only the owner can create, update, or delete.
     * @path /media/{mediaId}/comments/{commentId}
     * @allow (get, list) to everyone.
     * @allow (create) if the user is signed in and the authorId field matches the authenticated user's UID.
     */
    match /media/{mediaId}/comments/{commentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn() && resource.data.authorId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Allows a user to like a media item.
     * @path /media/{mediaId}/likes/{userId}
     * @allow (create, get, list) if the user is signed in and their UID matches the userId.
     * @allow delete if the user is signed in and their UID matches the userId.
     */
     match /media/{mediaId}/likes/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if false;
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to read and write their channel data.
     * @path /channels/{channelId}
     * @allow (create, update, delete, get, list) if the user is signed in and their UID matches the channelId.
     */
    match /channels/{channelId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn() && request.auth.uid == channelId;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == channelId;
      allow update: if isOwner();
      allow delete: if isOwner();
    }

    /**
     * @description Allows anyone to read playlists, but only the owner can create, update, or delete.
     * @path /playlists/{playlistId}
     * @allow (get, list) to everyone.
     * @allow (create) if the user is signed in and the creatorId field matches the authenticated user's UID.
     */
    match /playlists/{playlistId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn() && resource.data.creatorId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.creatorId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Allows a user to read and write their horoscopes.
     * @path /users/{userId}/horoscopes/{horoscopeId}
     * @allow (create, update, delete, get, list) if the user is signed in and their UID matches the userId.
     */
    match /users/{userId}/horoscopes/{horoscopeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows anyone to read deities, but no one can create, update, or delete.
     * @path /deities/{deityId}
     */
    match /deities/{deityId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows a shop owner to read and write their shop data.
     * @path /shops/{shopId}
     * @allow (create, update, delete, get, list) if the user is signed in and their UID matches the shop's ownerId.
     */
    match /shops/{shopId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn() && resource.data.ownerId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Allows anyone to read products, but only the shop owner can create, update, or delete.
     * @path /products/{productId}
     * @allow (get, list) to everyone.
     * @allow (create) if the user is signed in and the shopId field matches the shop's ownerId.
     */
    match /products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(shopId) {
        return isSignedIn() && get(/databases/$(database)/documents/shops/$(shopId)).data.ownerId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && exists(/databases/$(database)/documents/shops/$(request.resource.data.shopId)).data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isOwner(resource.data.shopId);
      allow delete: if isSignedIn() && isOwner(resource.data.shopId);
    }

    /**
     * @description Allows anyone to read temples, but no one can create, update, or delete.
     * @path /temples/{templeId}
     */
    match /temples/{templeId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read temple reviews, but only the owner can create, update, or delete.
     * @path /temples/{templeId}/reviews/{reviewId}
     * @allow (get, list) to everyone.
     * @allow (create) if the user is signed in and the userId field matches the authenticated user's UID.
     */
    match /temples/{templeId}/reviews/{reviewId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn() && resource.data.userId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Allows anyone to read temple posts, but only the owner can create, update, or delete.
     * @path /temples/{templeId}/posts/{postId}
     * @allow (get, list) to everyone.
     * @allow (create) if the user is signed in and the authorId field matches the authenticated user's UID.
     */
    match /temples/{templeId}/posts/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn() && resource.data.authorId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Allows anyone to read stories, but no one can create, update, or delete.
     * @path /stories/{storyId}
     */
    match /stories/{storyId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read epic heroes, but no one can create, update, or delete.
     * @path /epicHeroes/{heroId}
     */
    match /epicHeroes/{heroId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read rituals, but no one can create, update, or delete.
     * @path /rituals/{ritualId}
     */
    match /rituals/{ritualId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read panchang data.
     * @path /panchang/{date}
     */
    match /panchang/{date} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read festivals, but no one can create, update, or delete.
     * @path /festivals/{festivalId}
     */
    match /festivals/{festivalId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read group data, but only members can create, update, or delete.
     * @path /groups/{groupId}
     */
    match /groups/{groupId} {
       function isSignedIn() {
          return request.auth != null;
        }

        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
    }

    /**
     * @description Allows group members to read and write their membership data.
     * @path /groups/{groupId}/members/{userId}
     * @allow (create, update, delete, get, list) if the user is signed in and their UID matches the userId.
     */
    match /groups/{groupId}/members/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows anyone to read posts, but only the owner can create, update, or delete.
     * @path /posts/{postId}
     * @allow (get, list) to everyone.
     * @allow (create) if the user is signed in and the authorId field matches the authenticated user's UID.
     */
    match /posts/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn() && resource.data.authorId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

     /**
     * @description Allows anyone to read post comments, but only the owner can create, update, or delete.
     * @path /posts/{postId}/comments/{commentId}
     * @allow (get, list) to everyone.
     * @allow (create) if the user is signed in and the authorId field matches the authenticated user's UID.
     */
    match /posts/{postId}/comments/{commentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn() && resource.data.authorId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Allows a user to like a post.
     * @path /posts/{postId}/likes/{userId}
     * @allow (create, get, list) if the user is signed in and their UID matches the userId.
     * @allow delete if the user is signed in and their UID matches the userId.
     */
     match /posts/{postId}/likes/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if false;
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows anyone to read challenges, but no one can create, update, or delete.
     * @path /challenges/{challengeId}
     */
     match /challenges/{challengeId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read contest data, but only the owner can create, update, or delete.
     * @path /contests/{contestId}
     * @allow (get, list) to everyone.
     * @allow (create) if the user is signed in and the authorId field matches the authenticated user's UID.
     */
    match /contests/{contestId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn() && resource.data.authorId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

     /**
     * @description Allows anyone to read manifestation posts, but only the owner can create, update, or delete.
     * @path /manifestations/{manifestationId}
     * @allow (get, list) to everyone.
     * @allow (create) if the user is signed in and the userId field matches the authenticated user's UID.
     */
    match /manifestations/{manifestationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn() && resource.data.userId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

     /**
     * @description Allows anyone to read manifestation post comments, but only the owner can create, update, or delete.
     * @path /manifestations/{manifestationId}/comments/{commentId}
     * @allow (get, list) to everyone.
     * @allow (create) if the user is signed in and the authorId field matches the authenticated user's UID.
     */
    match /manifestations/{manifestationId}/comments/{commentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn() && resource.data.authorId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Allows a user to like a manifestation post.
     * @path /manifestations/{manifestationId}/likes/{userId}
     * @allow (create, get, list) if the user is signed in and their UID matches the userId.
     * @allow delete if the user is signed in and their UID matches the userId.
     */
     match /manifestations/{manifestationId}/likes/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if false;
      allow delete: if isOwner(userId);
    }
  }
}