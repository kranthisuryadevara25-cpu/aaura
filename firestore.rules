/**
 * @file Firestore Security Rules for aaura app.
 * @core_philosophy This ruleset enforces a strict user-ownership model for personal data while allowing public read access to certain content. User-generated content is generally accessible for reading, but can only be modified or deleted by the original author.
 * @data_structure
 * - User data is nested under `/users/{userId}`.
 * - Public content like media, deities, temples, stories, and rituals are stored in top-level collections.
 * - Likes are stored in subcollections for scalability.
 * @key_security_decisions
 * - Listing of users is disallowed.
 * - Public read access for read-only collections like deities, temples, stories, and rituals.
 * - Strict owner-only access for user-specific data.
 * @denormalization_for_authorization
 * - Owner-only writes for content using the `ownerId` field.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows access to user profiles.
     * @path /users/{userId}
     * @allow (create) Authenticated user can create their own profile.
     * @allow (get, list, update, delete) Authenticated user can only access their own profile.
     * @deny (create) Unauthenticated user cannot create a profile.
     * @deny (get, list, update, delete) Authenticated user cannot access other user profiles.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId} {
      allow create: if isSignedIn() && isOwner(userId);
      allow get, update, delete: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing users is disallowed
    }

    /**
     * @description Allows a user to follow another user.
     * @path /users/{userId}/followers/{followerId}
     * @allow (create) Authenticated user can create a follow relationship where they are the follower.
     * @allow (get, list) Authenticated user can only access their own followers list.
     * @deny (create) Unauthenticated user cannot create a follow relationship.
     * @deny (get, list) Authenticated user cannot access other user's followers list.
     * @deny (update, delete) Follow relationships can not be updated or deleted.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/followers/{followerId} {
      allow create: if isSignedIn() && request.auth.uid == followerId;
      allow get, list: if isSignedIn() && isOwner(userId);
      allow update, delete: if false;
    }

    /**
     * @description Allows a user to see who they are following.
     * @path /users/{userId}/following/{followedId}
     * @allow (create) Authenticated user can create a following relationship where they are following another user.
     * @allow (get, list) Authenticated user can only access their own following list.
     * @deny (create) Unauthenticated user cannot create a following relationship.
     * @deny (get, list) Authenticated user cannot access other user's following list.
     * @deny (update, delete) Following relationships can not be updated or deleted.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/following/{followedId} {
      allow create: if isSignedIn() && isOwner(userId);
      allow get, list: if isSignedIn() && isOwner(userId);
      allow update, delete: if false;
    }

    /**
     * @description Allows access to user preferences.
     * @path /users/{userId}/preferences/default
     * @allow (get, list, update, delete) Authenticated user can only access their own preferences.
     * @allow (create) Authenticated user can create their own preferences document.
     * @deny (create) Unauthenticated user cannot create preferences.
     * @deny (get, list, update, delete) Authenticated user cannot access other user preferences.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/preferences/default {
      allow create: if isSignedIn() && isOwner(userId);
      allow get, update, delete: if isSignedIn() && isOwner(userId);
      allow list: if false;
    }

    /**
     * @description Allows access to user badges.
     * @path /users/{userId}/badges/{badgeId}
     * @allow (get, list) Authenticated user can only access their own badges.
     * @allow (create) Only the system (backend) can award a badge to a user.
     * @deny (create) Unauthenticated user cannot create a badge.
     * @deny (update, delete) User badges can not be updated or deleted.
     * @deny (get, list) Authenticated user cannot access other user badges.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/badges/{badgeId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if false; // Only the system should be able to award badges
      allow update, delete: if false;
    }

    /**
     * @description Allows access to user bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (get, list, create, update, delete) Authenticated user can only access their own bookmarks.
     * @deny (create) Unauthenticated user cannot create a bookmark.
     * @deny (get, list, update, delete) Authenticated user cannot access other user bookmarks.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get, list, create, update, delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows access to virtual offerings.
     * @path /users/{userId}/virtualOfferings/{offeringId}
     * @allow (get, list, create, update, delete) Authenticated user can only access their own virtual offerings.
     * @deny (create) Unauthenticated user cannot create a virtual offering.
     * @deny (get, list, update, delete) Authenticated user cannot access other user virtual offerings.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/virtualOfferings/{offeringId} {
      allow get, list, create, update, delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows access to a user's shopping cart.
     * @path /users/{userId}/cart/{productId}
     * @allow (get, list, create, update, delete) Authenticated user can only access their own cart.
     * @deny (create) Unauthenticated user cannot create a cart item.
     * @deny (get, list, update, delete) Authenticated user cannot access other user carts.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/cart/{productId} {
      allow get, list, create, update, delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows access to a user's order history.
     * @path /users/{userId}/orders/{orderId}
     * @allow (get, list, create) Authenticated user can only access their own orders. Orders can only be created by the user.
     * @deny (create) Unauthenticated user cannot create an order.
     * @deny (get, list) Authenticated user cannot access other user orders.
     * @deny (update, delete) Orders cannot be updated or deleted.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/orders/{orderId} {
      allow get, list, create: if isSignedIn() && isOwner(userId);
      allow update, delete: if false;
    }

    /**
     * @description Allows access to playlists created by the user.
     * @path /users/{userId}/playlists/{playlistId}
     * @allow (get, list, create, update, delete) Authenticated user can only access their own playlists.
     * @deny (create) Unauthenticated user cannot create a playlist.
     * @deny (get, list, update, delete) Authenticated user cannot access other user playlists.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/playlists/{playlistId} {
      allow get, list, create, update, delete: if isSignedIn() && isOwner(userId);
    }
    
    /**
     * @description Allows access to user challenge progress.
     * @path /users/{userId}/challenges/{challengeId}
     * @allow (get, list, create, update, delete) Authenticated user can only access their own challenge progress.
     * @deny (create) Unauthenticated user cannot create challenge progress.
     * @deny (get, list, update, delete) Authenticated user cannot access other user challenge progress.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/challenges/{challengeId} {
        allow get, list, create, update, delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows public read access to media.
     * @path /media/{mediaId}
     * @allow (get, list) Public read access.
     * @allow (create, update, delete) Owner-only access for writes.
     * @deny (create) Cannot create a media if the userId in the document does not match the authenticated user id.
     * @principle Public read with owner-only writes.
     */
    match /media/{mediaId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Allows access to comments for a specific media item.
     * @path /media/{mediaId}/comments/{commentId}
     * @allow (get, list) Public read access.
     * @allow (create) Authenticated user can create a comment.
     * @allow (update, delete) Owner-only access for updates and deletes.
     * @principle Public read access for comments, owner-only writes.
     */
    match /media/{mediaId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }
    
    /**
     * @description Allows users to like a media.
     * @path /media/{mediaId}/likes/{userId}
     * @allow (create) Authenticated user can create a like document with their userId.
     * @allow (get, list) Public read access.
     * @deny (update, delete) Likes cannot be updated or deleted.
     * @principle Public read, authenticated create with self-ownership.
     */
    match /media/{mediaId}/likes/{userId} {
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow get, list: if true;
        allow update, delete: if false;
    }

    /**
     * @description Allows access to channels.
     * @path /channels/{channelId}
     * @allow (get, list) Public read access.
     * @allow (create, update, delete) Owner-only access for writes.
     * @deny (create) Cannot create a channel if the userId in the document does not match the authenticated user id.
     * @principle Public read with owner-only writes.
     */
    match /channels/{channelId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Allows access to playlists.
     * @path /playlists/{playlistId}
     * @allow (get, list) Public read access.
     * @allow (create) Authenticated users can create playlists. creatorId should match user id.
     * @allow (update, delete) Owner-only access for updates and deletes.
     * @deny (create) Cannot create a playlist if the creatorId in the document does not match the authenticated user id.
     * @principle Public read with owner-only writes.
     */
    match /playlists/{playlistId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.creatorId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.creatorId == request.auth.uid;
    }

    /**
     * @description Allows access to user horoscopes.
     * @path /users/{userId}/horoscopes/{horoscopeId}
     * @allow (get, list) Authenticated user can only access their own horoscopes.
     * @allow (create) Only the system can create horoscopes for a user.
     * @deny (create) Unauthenticated user cannot create a horoscope.
     * @deny (get, list) Authenticated user cannot access other user horoscopes.
     * @deny (update, delete) Horoscopes can not be updated or deleted.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/horoscopes/{horoscopeId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if false; // Only backend can generate horoscopes
      allow update, delete: if false;
    }

    /**
     * @description Allows public read access to deities.
     * @path /deities/{deityId}
     * @allow (get, list) Public read access.
     * @deny (create, update, delete) No writes allowed.
     * @principle Read-only collection.
     */
    match /deities/{deityId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows access to shops.
     * @path /shops/{shopId}
     * @allow (get, list) Public read access.
     * @allow (create, update, delete) Owner-only access for writes.
     * @deny (create) Cannot create a shop if the ownerId in the document does not match the authenticated user id.
     * @principle Public read with owner-only writes.
     */
    match /shops/{shopId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    /**
     * @description Allows access to products.
     * @path /products/{productId}
     * @allow (get, list) Public read access.
     * @allow (create, update, delete) No writes allowed.
     * @principle Read-only collection.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false; // Products are created and updated via backend
    }

    /**
     * @description Allows public read access to temples.
     * @path /temples/{templeId}
     * @allow (get, list) Public read access.
     * @deny (create, update, delete) No writes allowed.
     * @principle Read-only collection.
     */
    match /temples/{templeId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows access to reviews for a specific temple.
     * @path /temples/{templeId}/reviews/{reviewId}
     * @allow (get, list) Public read access.
     * @allow (create) Authenticated user can create a review.
     * @allow (update, delete) Owner-only access for updates and deletes.
     * @principle Public read access for reviews, owner-only writes.
     */
    match /temples/{templeId}/reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Allows access to posts for a specific temple.
     * @path /temples/{templeId}/posts/{postId}
     * @allow (get, list) Public read access.
     * @allow (create) Authenticated user can create a post.
     * @allow (update, delete) Owner-only access for updates and deletes.
     * @principle Public read access for posts, owner-only writes.
     */
    match /temples/{templeId}/posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Allows public read access to stories.
     * @path /stories/{storyId}
     * @allow (get, list) Public read access.
     * @deny (create, update, delete) No writes allowed.
     * @principle Read-only collection.
     */
    match /stories/{storyId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to epic heroes.
     * @path /epicHeroes/{heroId}
     * @allow (get, list) Public read access.
     * @deny (create, update, delete) No writes allowed.
     * @principle Read-only collection.
     */
    match /epicHeroes/{heroId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to rituals.
     * @path /rituals/{ritualId}
     * @allow (get, list) Public read access.
     * @deny (create, update, delete) No writes allowed.
     * @principle Read-only collection.
     */
    match /rituals/{ritualId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to panchang data.
     * @path /panchang/{date}
     * @allow (get, list) Public read access.
     * @deny (create, update, delete) No writes allowed.
     * @principle Read-only collection.
     */
    match /panchang/{date} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to festivals.
     * @path /festivals/{festivalId}
     * @allow (get, list) Public read access.
     * @deny (create, update, delete) No writes allowed.
     * @principle Read-only collection.
     */
    match /festivals/{festivalId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows access to groups.
     * @path /groups/{groupId}
     * @allow (get, list) Public read access.
     * @allow (create) Authenticated user can create a group.
     * @deny (create) Cannot create a group if the group's userId in the document does not match the authenticated user id.
     * @deny (update, delete) Groups can not be updated or deleted.
     * @principle Public read with authenticated create.
     */
    match /groups/{groupId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

     /**
      * @description Allows adding and listing members of a group.
      * @path /groups/{groupId}/members/{userId}
      * @allow (create) Authenticated user can join a group by creating a member document with their userId.
      * @allow (get, list) Any authenticated user can see the members of a group.
      * @deny (update, delete) Group membership can not be updated or deleted directly.
      * @principle Public read of members with authenticated user joining.
      */
    match /groups/{groupId}/members/{userId} {
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow get, list: if true;
      allow update, delete: if false;
    }

    /**
     * @description Allows access to posts within a specific group.
     * @path /groups/{groupId}/posts/{postId}
     * @allow (get, list) Public read access.
     * @allow (create) Authenticated user can create a post.
     * @allow (update, delete) Owner-only access for updates and deletes.
     * @principle Public read access for posts, owner-only writes.
     */
    match /groups/{groupId}/posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Allows access to comments for a specific post within a group.
     * @path /groups/{groupId}/posts/{postId}/comments/{commentId}
     * @allow (get, list) Public read access.
     * @allow (create) Authenticated user can create a comment.
     * @allow (update, delete) Owner-only access for updates and deletes.
     * @principle Public read access for comments, owner-only writes.
     */
    match /groups/{groupId}/posts/{postId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Allows users to like a group's forum post.
     * @path /groups/{groupId}/posts/{postId}/likes/{userId}
     * @allow (create) Authenticated user can create a like document with their userId.
     * @allow (get, list) Public read access.
     * @deny (update, delete) Likes cannot be updated or deleted.
     * @principle Public read, authenticated create with self-ownership.
     */
    match /groups/{groupId}/posts/{postId}/likes/{userId} {
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow get, list: if true;
        allow update, delete: if false;
    }
    
    /**
     * @description Allows public read access to community challenges.
     * @path /challenges/{challengeId}
     * @allow (get, list) Public read access.
     * @deny (create, update, delete) No writes allowed.
     * @principle Read-only collection.
     */
    match /challenges/{challengeId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Allows access to manifestation techniques and stories.
     * @path /manifestations/{manifestationId}
     * @allow (get, list) Public read access.
     * @allow (create) Authenticated user can create a manifestation.
     * @allow (update, delete) Owner-only access for updates and deletes.
     * @principle Public read with owner-only writes.
     */
    match /manifestations/{manifestationId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Allows access to comments on a manifestation post.
     * @path /manifestations/{manifestationId}/comments/{commentId}
     * @allow (get, list) Public read access.
     * @allow (create) Authenticated user can create a comment.
     * @allow (update, delete) Owner-only access for updates and deletes.
     * @principle Public read access for comments, owner-only writes.
     */
    match /manifestations/{manifestationId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Allows users to like a manifestation post.
     * @path /manifestations/{manifestationId}/likes/{userId}
     * @allow (create) Authenticated user can create a like document with their userId.
     * @allow (get, list) Public read access.
     * @deny (update, delete) Likes cannot be updated or deleted.
     * @principle Public read, authenticated create with self-ownership.
     */
    match /manifestations/{manifestationId}/likes/{userId} {
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow get, list: if true;
        allow update, delete: if false;
    }

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isSignedIn() && isOwner(userId) && resource != null;
    }
  }
}