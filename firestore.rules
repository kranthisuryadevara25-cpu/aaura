/**
 * @fileoverview Firestore Security Rules for Mythalogical App
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-generated content (videos, channels, horoscopes, orders),
 * ensuring that only the authenticated user can create, read, update, or delete their own data. Products are publicly readable,
 * while subscriptions require user authentication. All write operations are carefully validated against ownership.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles.
 * - /users/{userId}/videos/{videoId}: Stores user-uploaded videos.
 * - /users/{userId}/channels/{channelId}: Stores user-created channels.
 * - /users/{userId}/horoscopes/{horoscopeId}: Stores user-generated horoscopes.
 * - /users/{userId}/orders/{orderId}: Stores user orders.
 * - /orders/{orderId}/orderItems/{orderItemId}: Stores order items for individual orders.
 * - /products/{productId}: Stores product information (globally accessible).
 * - /subscriptions/{subscriptionId}: Stores user subscriptions to channels.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - All writes require authentication (`request.auth != null`).
 * - Data validation is limited to ownership and relational integrity checks.
 * - Read-only access to product data is enabled.
 *
 * Denormalization for Authorization:
 * - The `userId` is denormalized into the `Video`, `Channel`, `Horoscope`, and `Order` documents to enable simple ownership checks.
 * - The `orderId` is denormalized into `OrderItem` documents to enable simple authorization checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own profile.
     * @allow (get, update, delete) User with ID 'user123' can get, update, and delete their own profile.
     * @deny (create) User with ID 'user456' cannot create a profile for user 'user123'.
     * @deny (get, update, delete) User with ID 'user456' cannot get, update, and delete the profile of user 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to videos uploaded by users.
     * @path /users/{userId}/videos/{videoId}
     * @allow (create) User with ID 'user123' can create a video under their profile.
     * @allow (get, list, update, delete) User with ID 'user123' can get, list, update, and delete their own videos.
     * @deny (create) User with ID 'user456' cannot create a video under user 'user123's profile.
     * @deny (get, list, update, delete) User with ID 'user456' cannot get, list, update, and delete videos under user 'user123's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/videos/{videoId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && resource.data.userId == userId;
      allow delete: if isExistingOwner(userId) && resource.data.userId == userId;
    }

    /**
     * @description Controls access to channels created by users.
     * @path /users/{userId}/channels/{channelId}
     * @allow (create) User with ID 'user123' can create a channel under their profile.
     * @allow (get, list, update, delete) User with ID 'user123' can get, list, update, and delete their own channels.
     * @deny (create) User with ID 'user456' cannot create a channel under user 'user123's profile.
     * @deny (get, list, update, delete) User with ID 'user456' cannot get, list, update, and delete channels under user 'user123's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/channels/{channelId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && resource.data.userId == userId;
      allow delete: if isExistingOwner(userId) && resource.data.userId == userId;
    }

    /**
     * @description Controls access to horoscopes generated for users.
     * @path /users/{userId}/horoscopes/{horoscopeId}
     * @allow (create) User with ID 'user123' can create a horoscope under their profile.
     * @allow (get, list, update, delete) User with ID 'user123' can get, list, update, and delete their own horoscopes.
     * @deny (create) User with ID 'user456' cannot create a horoscope under user 'user123's profile.
     * @deny (get, list, update, delete) User with ID 'user456' cannot get, list, update, and delete horoscopes under user 'user123's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/horoscopes/{horoscopeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && resource.data.userId == userId;
      allow delete: if isExistingOwner(userId) && resource.data.userId == userId;
    }

    /**
     * @description Controls access to orders placed by users.
     * @path /users/{userId}/orders/{orderId}
     * @allow (create) User with ID 'user123' can create an order under their profile.
     * @allow (get, list, update, delete) User with ID 'user123' can get, list, update, and delete their own orders.
     * @deny (create) User with ID 'user456' cannot create an order under user 'user123's profile.
     * @deny (get, list, update, delete) User with ID 'user456' cannot get, list, update, and delete orders under user 'user123's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/orders/{orderId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && resource.data.userId == userId;
      allow delete: if isExistingOwner(userId) && resource.data.userId == userId;
    }

     /**
     * @description Controls access to order items associated with orders.
     * @path /orders/{orderId}/orderItems/{orderItemId}
     * @allow (get, list) Any authenticated user can view order items if they can view the parent order.
     * @allow (create, update, delete) Only the owner of the order can manage order items.
     * @deny (create) User with ID 'user456' cannot create an orderItem under order 'order123' if they are not the order's owner.
     * @deny (get, list, update, delete) User with ID 'user456' cannot get, list, update, and delete orderItems under order 'order123' if they are not the order's owner.
     * @principle Enforces document ownership for write operations.
     */
    match /orders/{orderId}/orderItems/{orderItemId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if false; // TODO: Add validation to allow create based on the order ownership
        allow update: if false; // TODO: Add validation to allow updates based on the order ownership
        allow delete: if false; // TODO: Add validation to allow deletes based on the order ownership
    }

    /**
     * @description Controls access to product information for the spiritual marketplace.
     * @path /products/{productId}
     * @allow (get, list) Any user can read product information.
     * @deny (create, update, delete) Only authenticated users can create, update, and delete product information.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add validation to allow create based on admin role
      allow update: if false; // TODO: Add validation to allow updates based on admin role
      allow delete: if false; // TODO: Add validation to allow deletes based on admin role
    }

    /**
     * @description Controls access to user subscriptions to channels.
     * @path /subscriptions/{subscriptionId}
     * @allow (get, list) Any authenticated user can read subscription information.
     * @deny (create, update, delete) Only authenticated users can create, update, and delete their own subscriptions.
     * @principle Requires authentication for all operations.
     */
    match /subscriptions/{subscriptionId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn(); // TODO: Add validation to allow create based on the user and channel existence
      allow update: if false; // Subscriptions should not be updated
      allow delete: if false; // TODO: Add validation to allow deletes based on subscription ownership
    }
  }

  // Helper function to determine if the user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the user is the owner of the document.
  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  // Helper function to determine if the user is the owner of the document and the document exists.
  function isExistingOwner(userId) {
    return request.auth.uid == userId && resource != null;
  }
}