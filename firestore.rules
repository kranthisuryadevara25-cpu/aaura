/**
 * @fileoverview Firestore Security Rules for the aaura app.
 *
 * Core Philosophy:
 * This ruleset implements a strict user-ownership model for personal data
 * while allowing public read access to shared content.
 *
 * Data Structure:
 * - User-specific data (profiles, preferences, bookmarks, cart, orders, playlists, badges, virtual offerings)
 *   is nested under `/users/{userId}`.
 * - Shared content (media, channels, deities, shops, products, temples, stories, characters, rituals, festivals, posts, challenges)
 *   is stored in top-level collections.
 * - Likes for media and posts are stored in subcollections for scalability.
 *
 * Key Security Decisions:
 * - Users can only read and write their own data under `/users/{userId}`.
 * - Listing user subcollections is restricted to the owner.
 * - Public content is readable by all users.
 * - Write access to public content is restricted to authorized users (e.g., content creators).
 * - All write operations require authentication.
 * - Attempts to modify relational fields (e.g., creatorId) are denied.
 *
 * Denormalization for Authorization:
 * - For public read, owner-write collections, ensure the document contains an `ownerId` or `authorId` field.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if the authenticated user is the owner of the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to check if the authenticated user is the owner of the existing document
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Manages access to user profiles.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create their profile.
     * @allow (get, update, delete) - User with UID 'user123' can read, update, and delete their own profile.
     * @deny (create) - User with UID 'anotherUser' cannot create a profile with ID 'user123'.
     * @deny (update, delete) - User with UID 'anotherUser' cannot update or delete the profile of user with ID 'user123'.
     * @principle Enforces user ownership for profile data.
     */
    match /users/{userId} {
      allow get: if true;
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id; // Enforce immutability of userId
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages follower relationships for a user.
     * @path /users/{userId}/followers/{followerId}
     * @allow (create) - User 'follower123' can create a follow relationship to 'user123'.
     * @allow (get, delete) - User 'follower123' can read and delete their own follow relationship to 'user123'.
     * @deny (create, update, delete) - User 'anotherUser' cannot create, update, or delete follow relationships for other users.
     * @principle Enforces user ownership for managing follower relationships.
     */
    match /users/{userId}/followers/{followerId} {
      allow get: if isOwner(followerId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(followerId);
      allow update: if false;
      allow delete: if isExistingOwner(followerId);
    }

    /**
     * @description Manages following relationships for a user.
     * @path /users/{userId}/following/{followedId}
     * @allow (create) - User 'user123' can create a follow relationship to 'followed456'.
     * @allow (get, delete) - User 'user123' can read and delete their own follow relationship to 'followed456'.
     * @deny (create, update, delete) - User 'anotherUser' cannot create, update, or delete follow relationships for other users.
     * @principle Enforces user ownership for managing following relationships.
     */
    match /users/{userId}/following/{followedId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages user preferences.
     * @path /users/{userId}/preferences/default
     * @allow (get, update) - User with UID 'user123' can read and update their preferences.
     * @deny (create, delete) - Prevents creating or deleting the 'default' preference document.
     * @deny (update) - User with UID 'anotherUser' cannot update the preferences of user with ID 'user123'.
     * @principle Enforces user ownership for preference data.
     */
    match /users/{userId}/preferences/default {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if false;
      allow update: if isExistingOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Manages badges awarded to a user.
     * @path /users/{userId}/badges/{badgeId}
     * @allow (get, list) - User with UID 'user123' can read their badges.
     * @deny (create, update, delete) - Only backend functions should award/manage badges.
     * @principle Restricts badge management to the backend.
     */
    match /users/{userId}/badges/{badgeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages user bookmarks for temples.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (get, list, create, delete) - User with UID 'user123' can manage their bookmarks.
     * @deny (create, update, delete) - User with UID 'anotherUser' cannot manage the bookmarks of user with ID 'user123'.
     * @principle Enforces user ownership for bookmark data.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

     /**
      * @description Manages virtual offerings made by users.
      * @path /users/{userId}/virtualOfferings/{offeringId}
      * @allow (get, list, create, delete) - User with UID 'user123' can manage their virtual offerings.
      * @deny (create, update, delete) - User with UID 'anotherUser' cannot manage the virtual offerings of user with ID 'user123'.
      * @principle Enforces user ownership for virtual offering data.
      */
    match /users/{userId}/virtualOfferings/{offeringId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages items in a user's shopping cart.
     * @path /users/{userId}/cart/{productId}
     * @allow (get, list, create, update, delete) - User with UID 'user123' can manage their cart items.
     * @deny (create, update, delete) - User with UID 'anotherUser' cannot manage the cart of user with ID 'user123'.
     * @principle Enforces user ownership for shopping cart data.
     */
    match /users/{userId}/cart/{productId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages user orders.
     * @path /users/{userId}/orders/{orderId}
     * @allow (get, list) - User with UID 'user123' can read their orders.
     * @deny (create, update, delete) - Orders should be created by the backend after checkout. Updates and deletes are disallowed.
     * @principle Restricts order management to the backend.
     */
    match /users/{userId}/orders/{orderId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages playlists created by a user.
     * @path /users/{userId}/playlists/{playlistId}
     * @allow (get, list) - User with UID 'user123' can read their playlists.
     * @deny (create, update, delete) - Only backend functions should create and manage playlist references.
     * @principle Restricts playlist management to the backend.
     */
    match /users/{userId}/playlists/{playlistId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

     /**
      * @description Tracks user progress in community challenges.
      * @path /users/{userId}/challenges/{challengeId}
      * @allow (get, list, create, update) - User with UID 'user123' can manage their challenge progress.
      * @deny (create, update, delete) - User with UID 'anotherUser' cannot manage the challenge progress of user with ID 'user123'.
      * @principle Enforces user ownership for challenge progress data.
      */
    match /users/{userId}/challenges/{challengeId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isSignedIn() && isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if false; // Prevent users from deleting their progress, backend can handle this.
    }

    /**
     * @description Manages all media on the platform.
     * @path /media/{mediaId}
     * @allow (get, list) - Public read access to all media.
     * @deny (create, update, delete) - Only authorized users/backend can create, update, or delete media. Requires schema update with owner.
     * @principle Public read, owner-only write pattern. Requires 'ownerId' field.
     */
    match /media/{mediaId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      // CRITICAL: Cannot implement owner-only writes. The 'Media' entity is missing an 'ownerId' or 'authorId' field.
    }

    /**
     * @description Manages comments for a specific media item.
     * @path /media/{mediaId}/comments/{commentId}
     * @allow (get, list, create) - Any signed-in user can read and create comments.
     * @deny (update, delete) - Only the comment's author can update/delete it. Requires schema update with owner.
     * @principle Public read/create, owner-only update/delete pattern.
     */
    match /media/{mediaId}/comments/{commentId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn(); // Any signed-in user can comment
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      // CRITICAL: Cannot implement owner-only writes. The 'Comment' entity is missing an 'ownerId' or 'authorId' field.
    }

    /**
     * @description Manages likes for a specific media item.
     * @path /media/{mediaId}/likes/{userId}
     * @allow (get, list, create, delete) - Any signed-in user can like/unlike a media item.
     * @deny (update) - Likes themselves should not be updated.
     * @principle  Any signed-in user can like/unlike a media item.
     */
    match /media/{mediaId}/likes/{userId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Manages channels on the platform.
     * @path /channels/{channelId}
     * @allow (get, list) - Public read access to all channels.
     * @deny (create, update, delete) - Only the channel owner can create, update, or delete a channel. Requires schema update with owner.
     * @principle Public read, owner-only write pattern. Requires 'ownerId' field.
     */
    match /channels/{channelId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      // CRITICAL: Cannot implement owner-only writes. The 'Channel' entity is missing an 'ownerId' or 'authorId' field.
    }

    /**
     * @description Manages playlists on the platform.
     * @path /playlists/{playlistId}
     * @allow (get, list) - Public read access to all playlists.
     * @deny (create, update, delete) - Only the playlist creator can create, update, or delete a playlist. Requires schema update with creatorId.
     * @principle Public read, owner-only write pattern. Requires 'creatorId' field.
     */
    match /playlists/{playlistId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
       // CRITICAL: Cannot implement owner-only writes. The 'Playlist' entity is missing an 'ownerId' or 'authorId' field.
    }

    /**
     * @description Manages horoscopes generated for users.
     * @path /users/{userId}/horoscopes/{horoscopeId}
     * @allow (get, list) - User with UID 'user123' can read their horoscopes.
     * @deny (create, update, delete) - Horoscopes should be generated by a backend function.
     * @principle Restricts horoscope management to the backend.
     */
    match /users/{userId}/horoscopes/{horoscopeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages deities on the platform.
     * @path /deities/{deityId}
     * @allow (get, list) - Public read access to all deities.
     * @deny (create, update, delete) - Only authorized admins can create, update, or delete deities.
     * @principle Public read, admin-only write pattern.
     */
    match /deities/{deityId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add admin role check
      allow update: if false; // TODO: Add admin role check
      allow delete: if false; // TODO: Add admin role check
    }

    /**
     * @description Manages shops in the marketplace.
     * @path /shops/{shopId}
     * @allow (get, list) - Public read access to all shops.
     * @deny (create, update, delete) - Only the shop owner can create, update, or delete their shop. Requires schema update with ownerId.
     * @principle Public read, owner-only write pattern. Requires 'ownerId' field.
     */
    match /shops/{shopId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
       // CRITICAL: Cannot implement owner-only writes. The 'Shop' entity is missing an 'ownerId' or 'authorId' field.
    }

    /**
     * @description Manages products in the marketplace.
     * @path /products/{productId}
     * @allow (get, list) - Public read access to all products.
     * @deny (create, update, delete) - Only the shop owner can create, update, or delete products in their shop. Requires schema update with ownerId (via shopId).
     * @principle Public read, shop-owner-only write pattern.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add shop owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add shop owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add shop owner validation once the schema is updated with an ownership field.
       // CRITICAL: Cannot implement owner-only writes. The 'Product' entity is missing an 'ownerId' or 'authorId' field.
    }

    /**
     * @description Manages temples and pilgrimage data.
     * @path /temples/{templeId}
     * @allow (get, list) - Public read access to all temples.
     * @deny (create, update, delete) - Only authorized admins can create, update, or delete temple data.
     * @principle Public read, admin-only write pattern.
     */
    match /temples/{templeId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add admin role check
      allow update: if false; // TODO: Add admin role check
      allow delete: if false; // TODO: Add admin role check
    }

    /**
     * @description Manages user reviews for a specific temple.
     * @path /temples/{templeId}/reviews/{reviewId}
     * @allow (get, list, create) - Any signed-in user can create reviews.
     * @deny (update, delete) - Only the review author can update or delete their review. Requires schema update with owner.
     * @principle Public read/create, owner-only update/delete pattern.
     */
    match /temples/{templeId}/reviews/{reviewId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false;  // TODO: Add owner validation once the schema is updated with an ownership field.
       // CRITICAL: Cannot implement owner-only writes. The 'Review' entity is missing an 'ownerId' or 'authorId' field.
    }

    /**
     * @description Manages mythological stories.
     * @path /stories/{storyId}
     * @allow (get, list) - Public read access to all stories.
     * @deny (create, update, delete) - Only authorized admins can create, update, or delete stories.
     * @principle Public read, admin-only write pattern.
     */
    match /stories/{storyId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add admin role check
      allow update: if false; // TODO: Add admin role check
      allow delete: if false; // TODO: Add admin role check
    }

    /**
     * @description Manages mythological characters.
     * @path /characters/{characterId}
     * @allow (get, list) - Public read access to all characters.
     * @deny (create, update, delete) - Only authorized admins can create, update, or delete characters.
     * @principle Public read, admin-only write pattern.
     */
    match /characters/{characterId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add admin role check
      allow update: if false; // TODO: Add admin role check
      allow delete: if false; // TODO: Add admin role check
    }

    /**
     * @description Manages guidelines for various rituals and poojas.
     * @path /rituals/{ritualId}
     * @allow (get, list) - Public read access to all rituals.
     * @deny (create, update, delete) - Only authorized admins can create, update, or delete rituals.
     * @principle Public read, admin-only write pattern.
     */
    match /rituals/{ritualId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add admin role check
      allow update: if false; // TODO: Add admin role check
      allow delete: if false; // TODO: Add admin role check
    }

    /**
     * @description Manages daily panchang data.
     * @path /panchang/{date}
     * @allow (get, list) - Public read access to all panchang data.
     * @deny (create, update, delete) - Only authorized admins can create, update, or delete panchang data.
     * @principle Public read, admin-only write pattern.
     */
    match /panchang/{date} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add admin role check
      allow update: if false; // TODO: Add admin role check
      allow delete: if false; // TODO: Add admin role check
    }

    /**
     * @description Manages details about cultural and religious festivals.
     * @path /festivals/{festivalId}
     * @allow (get, list) - Public read access to all festivals.
     * @deny (create, update, delete) - Only authorized admins can create, update, or delete festival data.
     * @principle Public read, admin-only write pattern.
     */
    match /festivals/{festivalId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add admin role check
      allow update: if false; // TODO: Add admin role check
      allow delete: if false; // TODO: Add admin role check
    }

   /**
     * @description Manages community forum posts.
     * @path /posts/{postId}
     * @allow (get, list) - Public read access to all posts.
     * @deny (create, update, delete) - The author can create a post. The author can update and delete their own posts. Requires schema update with author.
     * @principle Public read, owner-only write pattern.
     */
    match /posts/{postId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn(); // TODO: Validate that authorId is set correctly on create.
        allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
        allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
         // CRITICAL: Cannot implement owner-only writes. The 'Post' entity is missing an 'ownerId' or 'authorId' field.
    }

    /**
     * @description Manages comments for a specific post.
     * @path /posts/{postId}/comments/{commentId}
     * @allow (get, list, create) - Any signed-in user can read and create comments.
     * @deny (update, delete) - Only the comment's author can update/delete it. Requires schema update with owner.
     * @principle Public read/create, owner-only update/delete pattern.
     */
    match /posts/{postId}/comments/{commentId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn(); // Any signed-in user can comment
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      // CRITICAL: Cannot implement owner-only writes. The 'Comment' entity is missing an 'ownerId' or 'authorId' field.
    }

   /**
     * @description Manages likes for a specific forum post.
     * @path /posts/{postId}/likes/{userId}
     * @allow (get, list, create, delete) - Any signed-in user can like/unlike a forum post.
     * @deny (update) - Likes themselves should not be updated.
     * @principle  Any signed-in user can like/unlike a forum post.
     */
    match /posts/{postId}/likes/{userId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Manages community challenges.
     * @path /challenges/{challengeId}
     * @allow (get, list) - Public read access to all challenges.
     * @deny (create, update, delete) - Only authorized admins can create, update, or delete challenges.
     * @principle Public read, admin-only write pattern.
     */
    match /challenges/{challengeId} {
        allow get: if true;
        allow list: if true;
        allow create: if false; // TODO: Add admin role check
        allow update: if false; // TODO: Add admin role check
        allow delete: if false; // TODO: Add admin role check
    }
  }
}