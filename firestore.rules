
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users can read anyone's profile, but can only write to their own.
    match /users/{userId} {
      allow read;
      allow write: if request.auth != null && request.auth.uid == userId;

      // Users can manage their own subcollections like cart, preferences, etc.
      match /{subcollection}/{docId} {
        allow read, write, delete: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Public content like deities, stories, temples, etc., are read-only for clients.
    // They should be managed via a secure admin interface/backend.
    match /deities/{deityId} {
      allow read: if true;
    }
    match /stories/{storyId} {
      allow read: if true;
    }
    match /epicHeroes/{heroId} {
      allow read: if true;
    }
    match /temples/{templeId} {
      allow read: if true;
    }
    match /rituals/{ritualId} {
      allow read: if true;
    }
    match /festivals/{festivalId} {
      allow read: if true;
    }
     match /products/{productId} {
      allow read: if true;
    }
     match /panchang/{date} {
      allow read: if true;
    }
     match /contests/{contestId} {
      allow read: if true;
      allow write: if request.auth != null; // Allow logged in users to update chant counts, etc
    }

    // Rules for Media Content
    match /media/{mediaId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null && request.resource.data.userId == request.auth.uid;
      
      // Anyone can read comments
      match /comments/{commentId} {
        allow read: if true;
        allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
        allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;
      }

      // Any authenticated user can like/unlike a media item
       match /likes/{userId} {
        allow read: if true;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Rules for community groups
    match /groups/{groupId} {
      allow read: if true;
      allow create: if request.auth != null; // Any authenticated user can create a group
      // Only the creator should be able to update/delete a group. This assumes an 'authorId' or 'creatorId' field.
      allow update, delete: if request.auth != null && resource.data.creatorId == request.auth.uid;
    }
    
    // Rules for posts
    match /posts/{postId} {
        allow read: if true;
        // Users can create posts if they are authenticated
        allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
        // Users can only update or delete their own posts
        allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;
        
        // Rules for comments on posts
        match /comments/{commentId} {
            allow read: if true;
            // Any authenticated user can create a comment
            allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
             // Users can only update or delete their own comments
            allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;
        }

        // Rules for likes on posts
        match /likes/{userId} {
            allow read: if true;
            // An authenticated user can like/unlike (write/delete) their own like document
            allow write: if request.auth != null && request.auth.uid == userId;
        }
    }
    
     // Rules for Manifestations
    match /manifestations/{manifestationId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;

      // Rules for comments on manifestations
      match /comments/{commentId} {
        allow read: if true;
        allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
        allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;
      }

      // Rules for likes on manifestations
      match /likes/{userId} {
        allow read: if true;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}
