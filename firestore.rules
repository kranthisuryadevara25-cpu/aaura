
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------------------------------------------------------------------------
    // ðŸ”¹ Helper Functions
    // ---------------------------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isSuperAdmin() {
      return request.auth.uid == "9RwsoEEkWPR3Wpv6wKZmhos1xTG2";
    }

    function isNotSelf(userId) {
      return request.auth.uid != userId;
    }

    // ---------------------------------------------------------------------------------------------
    // ðŸ”¹ Global Rules - Deny all by default for security
    // ---------------------------------------------------------------------------------------------
    match /{document=**} {
      allow read, write: if false;
    }


    // ---------------------------------------------------------------------------------------------
    // ðŸ”¹ Publicly Readable Collections
    // ---------------------------------------------------------------------------------------------

    match /deities/{deityId} {
      allow get, list: if true;
      allow create, update, delete: if isSuperAdmin();
    }
    
    match /stories/{storyId} {
        allow get, list: if true;
        allow create, update, delete: if isSuperAdmin();
    }
    
    match /epicHeroes/{heroId} {
      allow get, list: if true;
      allow create, update, delete: if isSuperAdmin();
    }

    match /temples/{templeId} {
      allow get, list: if true;
      allow create, update, delete: if isSuperAdmin();
    }
    
    match /rituals/{ritualId} {
        allow get, list: if true;
        allow create, update, delete: if isSuperAdmin();
    }
    
    match /festivals/{festivalId} {
        allow get, list: if true;
        allow create, update, delete: if isSuperAdmin();
    }
    
    match /panchang/{date} {
        allow get, list: if true;
        allow create, update, delete: if isSuperAdmin();
    }

    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if isSuperAdmin();
    }
    
    match /shops/{shopId} {
      allow get, list: if true;
      allow create, update, delete: if isSuperAdmin();
    }

    match /contests/{contestId} {
      allow get, list: if true;
      allow create, delete: if isSuperAdmin();
      allow update: if isSignedIn(); // Allows incrementing chants
    }
    
    match /challenges/{challengeId} {
      allow get, list: if true;
      allow create, update, delete: if isSuperAdmin();
    }

    match /channels/{channelId} {
      allow get, list: if true;
      allow create, update, delete: if isOwner(channelId) || isSuperAdmin();
    }

    match /groups/{groupId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update, delete: if isSuperAdmin();
    }
    

    // ---------------------------------------------------------------------------------------------
    // ðŸ”¹ User Profiles and Subcollections
    // ---------------------------------------------------------------------------------------------

    match /users/{userId} {
      allow get: if true;
      allow create, update, delete: if isOwner(userId) || isSuperAdmin();

      // All default subcollections are managed by their owner or an admin
      match /{subcollection}/{docId} {
        allow read, write: if isOwner(userId) || isSuperAdmin();
      }

      // Followers
      match /followers/{followerId} {
        allow create: if isSignedIn() && request.auth.uid == followerId && isNotSelf(userId);
        allow delete: if isSignedIn() && (request.auth.uid == followerId || isOwner(userId));
        allow get, list: if true;
      }

      // Following
      match /following/{followedId} {
        allow create: if isOwner(userId) && isNotSelf(followedId);
        allow delete: if isOwner(userId);
        allow get, list: if true;
      }
    }
    
    // ---------------------------------------------------------------------------------------------
    // ðŸ”¹ User-Generated & Interactive Content
    // ---------------------------------------------------------------------------------------------

    match /media/{mediaId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isOwner(resource.data.userId) || isSuperAdmin();

      match /comments/{commentId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update, delete: if isOwner(resource.data.authorId) || isSuperAdmin();
      }
      match /likes/{userId} {
        allow get, list: if true;
        allow create, delete: if isOwner(userId);
      }
    }
    
    match /posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isOwner(resource.data.authorId) || isSuperAdmin();

      match /comments/{commentId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update, delete: if isOwner(resource.data.authorId) || isSuperAdmin();
      }
      match /likes/{userId} {
        allow get, list: if true;
        allow create, delete: if isOwner(userId);
      }
    }
    
    match /manifestations/{manifestationId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isOwner(resource.data.userId) || isSuperAdmin();

      match /comments/{commentId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update, delete: if isOwner(resource.data.authorId) || isSuperAdmin();
      }
      match /likes/{userId} {
        allow get, list: if true;
        allow create, delete: if isOwner(userId);
      }
    }

    match /playlists/{playlistId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update, delete: if isOwner(resource.data.creatorId) || isSuperAdmin();
    }

    match /orders/{orderId} {
      allow get, list: if isOwner(resource.data.userId) || isSuperAdmin();
      allow create: if isSignedIn();
      allow update, delete: if isSuperAdmin();
    }
  }
}
