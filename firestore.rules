/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for private data and allows public read access to certain collections while restricting write access to authorized users.
 *
 * Data Structure:
 * - User-specific data is nested under `/users/{userId}`.
 * - Public content (e.g., media, deities, temples) is stored in top-level collections.
 * - Likes are denormalized as subcollections of the liked entity.
 *
 * Key Security Decisions:
 * - Users can only access their own data under `/users/{userId}`.
 * - Public read access is granted to top-level collections like `/media`, `/deities`, `/temples`, etc.
 * - Write access to public collections is restricted to authorized users (typically the content owner).
 * - Listing of user subcollections is restricted to the owning user.
 * - The rules do not validate the specific schema of most data being written, focusing instead on authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of an existing document.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces user-ownership for document reads and writes.
     * @path /users/{userId}
     * @allow (get, create, update, delete, list) - User with matching UID can perform all operations.
     * @deny (get, create, update, delete, list) - User with mismatched UID cannot perform any operation.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for follow relationships (followers).
     * @path /users/{userId}/followers/{followerId}
     * @allow (create, get, delete, list) - Only the owning user can manage their followers.
     * @deny (create, get, delete, list) - Other users cannot manage follow relationships.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/followers/{followerId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for follow relationships (following).
     * @path /users/{userId}/following/{followedId}
     * @allow (create, get, delete, list) - Only the owning user can manage who they are following.
     * @deny (create, get, delete, list) - Other users cannot manage follow relationships.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/following/{followedId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for preferences.
     * @path /users/{userId}/preferences/default
     * @allow (get, create, update, delete) - Only the owning user can manage their preferences.
     * @deny (get, create, update, delete) - Other users cannot manage preferences.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/preferences/default {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for badges.
     * @path /users/{userId}/badges/{badgeId}
     * @allow (get, create, delete, list) - Only the owning user can manage their badges.
     * @deny (get, create, delete, list) - Other users cannot manage badges.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/badges/{badgeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (get, create, delete, list) - Only the owning user can manage their bookmarks.
     * @deny (get, create, delete, list) - Other users cannot manage bookmarks.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for virtual offerings.
     * @path /users/{userId}/virtualOfferings/{offeringId}
     * @allow (get, create, delete, list) - Only the owning user can manage their virtual offerings.
     * @deny (get, create, delete, list) - Other users cannot manage virtual offerings.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/virtualOfferings/{offeringId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for cart items.
     * @path /users/{userId}/cart/{productId}
     * @allow (get, create, update, delete, list) - Only the owning user can manage their cart items.
     * @deny (get, create, update, delete, list) - Other users cannot manage cart items.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/cart/{productId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for orders.
     * @path /users/{userId}/orders/{orderId}
     * @allow (get, create, update, delete, list) - Only the owning user can access their orders.
     * @deny (get, create, update, delete, list) - Other users cannot access orders.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/orders/{orderId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

     /**
     * @description Enforces user-ownership for playlists.
     * @path /users/{userId}/playlists/{playlistId}
     * @allow (get, create, update, delete, list) - Only the owning user can manage their playlists.
     * @deny (get, create, update, delete, list) - Other users cannot manage playlists.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/playlists/{playlistId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for challenges.
     * @path /users/{userId}/challenges/{challengeId}
     * @allow (get, create, update, delete, list) - Only the owning user can manage their challenges.
     * @deny (get, create, update, delete, list) - Other users cannot manage challenges.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/challenges/{challengeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to media items, restricts write access to the owner.
     * @path /media/{mediaId}
     * @allow (get, list) - Anyone can read media items.
     * @allow (create, update, delete) - Only the owner can create, update, or delete media items.
     * @deny (create, update, delete) - Non-owners cannot modify media items.
     * @principle Public read with owner-only writes.
     */
    match /media/{mediaId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn(); // Assuming any signed-in user can create media. Adjust as needed.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows comments to be created by signed-in users, anyone can read.
     * @path /media/{mediaId}/comments/{commentId}
     * @allow (get, list) - Anyone can read the comments.
     * @allow (create) - Only signed-in users can create new comments.
     * @deny (update, delete) - No one can update or delete comments (for now).
     * @principle Public read, authenticated create.
     */
    match /media/{mediaId}/comments/{commentId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

     /**
     * @description Allows any signed in user to like media.
     * @path /media/{mediaId}/likes/{userId}
     * @allow (create) - Only signed-in users can create likes.
     * @allow (delete) - Only signed-in users can delete likes.
     * @deny (update) - No one can update a like.
     * @principle Authenticated users can like.
     */
    match /media/{mediaId}/likes/{userId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if isSignedIn();
    }

    /**
     * @description Allows public read access to channels, restricts write access to the owner.
     * @path /channels/{channelId}
     * @allow (get, list) - Anyone can read channel information.
     * @allow (create, update, delete) - Only the owner can create, update, or delete channels.
     * @deny (create, update, delete) - Non-owners cannot modify channels.
     * @principle Public read with owner-only writes.
     */
    match /channels/{channelId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn(); // Assuming any signed-in user can create channel. Adjust as needed.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to playlists, restricts write access to the owner.
     * @path /playlists/{playlistId}
     * @allow (get, list) - Anyone can read playlist information.
     * @allow (create, update, delete) - Only the owner can create, update, or delete playlists.
     * @deny (create, update, delete) - Non-owners cannot modify playlists.
     * @principle Public read with owner-only writes.
     */
    match /playlists/{playlistId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn(); // Assuming any signed-in user can create playlist. Adjust as needed.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Enforces user-ownership for horoscopes.
     * @path /users/{userId}/horoscopes/{horoscopeId}
     * @allow (get, create, update, delete, list) - Only the owning user can access their horoscopes.
     * @deny (get, create, update, delete, list) - Other users cannot access horoscopes.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/horoscopes/{horoscopeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to deities.
     * @path /deities/{deityId}
     * @allow (get, list) - Anyone can read deity information.
     * @deny (create, update, delete) - No one can create, update, or delete deities (for now).
     * @principle Public read-only.
     */
    match /deities/{deityId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to shops.
     * @path /shops/{shopId}
     * @allow (get, list) - Anyone can read shop information.
     * @deny (create, update, delete) - No one can create, update, or delete shops (for now).
     * @principle Public read-only.
     */
    match /shops/{shopId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to products.
     * @path /products/{productId}
     * @allow (get, list) - Anyone can read product information.
     * @deny (create, update, delete) - No one can create, update, or delete products (for now).
     * @principle Public read-only.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to temples.
     * @path /temples/{templeId}
     * @allow (get, list) - Anyone can read temple information.
     * @deny (create, update, delete) - No one can create, update, or delete temples (for now).
     * @principle Public read-only.
     */
    match /temples/{templeId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows any signed-in user to create reviews.
     * @path /temples/{templeId}/reviews/{reviewId}
     */
    match /temples/{templeId}/reviews/{reviewId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows any signed-in user to create a post.
     * @path /temples/{templeId}/posts/{postId}
     */
    match /temples/{templeId}/posts/{postId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to stories.
     * @path /stories/{storyId}
     * @allow (get, list) - Anyone can read stories.
     * @deny (create, update, delete) - No one can create, update, or delete stories (for now).
     * @principle Public read-only.
     */
    match /stories/{storyId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to epic heroes.
     * @path /epicHeroes/{heroId}
     * @allow (get, list) - Anyone can read epic heroes.
     * @deny (create, update, delete) - No one can create, update, or delete epic heroes (for now).
     * @principle Public read-only.
     */
    match /epicHeroes/{heroId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to rituals.
     * @path /rituals/{ritualId}
     * @allow (get, list) - Anyone can read rituals.
     * @deny (create, update, delete) - No one can create, update, or delete rituals (for now).
     * @principle Public read-only.
     */
    match /rituals/{ritualId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to panchang data.
     * @path /panchang/{date}
     * @allow (get, list) - Anyone can read panchang data.
     * @deny (create, update, delete) - No one can create, update, or delete panchang data (for now).
     * @principle Public read-only.
     */
    match /panchang/{date} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to festivals.
     * @path /festivals/{festivalId}
     * @allow (get, list) - Anyone can read festival information.
     * @deny (create, update, delete) - No one can create, update, or delete festivals (for now).
     * @principle Public read-only.
     */
    match /festivals/{festivalId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

     /**
     * @description Allows public read access to groups. Signed in users can create groups.
     * @path   /groups/{groupId}
     * @allow  (get, list) - Anyone can read group information.
     * @deny   (update, delete) - No one can update or delete groups (for now).
     * @principle Public read, authenticated create.
     */
    match /groups/{groupId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows signed in users to join groups.
     * @path   /groups/{groupId}/members/{userId}
     * @allow  (create) - Signed-in user can create a membership for themselves.
     * @deny   (get, list, update, delete) - No one can get, list, update, or delete group memberships (for now).
     * @principle Authenticated users can create.
     */
    match /groups/{groupId}/members/{userId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to group posts. Signed in users can create group posts.
     * @path   /groups/{groupId}/posts/{postId}
     * @allow  (get, list) - Anyone can read posts in a group.
     * @allow  (create) - Signed-in users can create posts.
     * @deny   (update, delete) - No one can update or delete posts (for now).
     * @principle Public read, authenticated create.
     */
    match /groups/{groupId}/posts/{postId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read comments, and signed-in users to create comments on group posts.
     * @path   /groups/{groupId}/posts/{postId}/comments/{commentId}
     * @allow  (get, list) - Anyone can read comments.
     * @allow  (create) - Signed-in users can create comments.
     * @deny   (update, delete) - No one can update or delete comments (for now).
     * @principle Public read, authenticated create.
     */
    match /groups/{groupId}/posts/{postId}/comments/{commentId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows any signed in user to like a group post.
     * @path /groups/{groupId}/posts/{postId}/likes/{userId}
     * @allow (create) - Only signed-in users can create likes.
     * @allow (delete) - Only signed-in users can delete likes.
     * @deny (update) - No one can update a like.
     * @principle Authenticated users can like.
     */
    match /groups/{groupId}/posts/{postId}/likes/{userId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if isSignedIn();
    }

    /**
     * @description Allows public read access to challenges. Signed in users can create challenges.
     * @path   /challenges/{challengeId}
     * @allow  (get, list) - Anyone can read challenge information.
     * @deny   (update, delete) - No one can update or delete challenges (for now).
     * @principle Public read, authenticated create.
     */
    match /challenges/{challengeId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to Manifestations. Signed in users can create Manifestations.
     * @path   /manifestations/{manifestationId}
     * @allow  (get, list) - Anyone can read manifestation information.
     * @deny   (update, delete) - No one can update or delete manifestations (for now).
     * @principle Public read, authenticated create.
     */
    match /manifestations/{manifestationId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows anyone to read comments, and signed-in users to create comments on Manifestations.
     * @path   /manifestations/{manifestationId}/comments/{commentId}
     * @allow  (get, list) - Anyone can read comments.
     * @allow  (create) - Signed-in users can create comments.
     * @deny   (update, delete) - No one can update or delete comments (for now).
     * @principle Public read, authenticated create.
     */
    match /manifestations/{manifestationId}/comments/{commentId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows any signed in user to like a manifestation.
     * @path /manifestations/{manifestationId}/likes/{userId}
     * @allow (create) - Only signed-in users can create likes.
     * @allow (delete) - Only signed-in users can delete likes.
     * @deny (update) - No one can update a like.
     * @principle Authenticated users can like.
     */
    match /manifestations/{manifestationId}/likes/{userId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if isSignedIn();
    }
  }
}