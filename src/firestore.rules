
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------------------------------------------------------------------------
    // ðŸ”¹ Helper Functions
    // ---------------------------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isSuperAdmin() {
      return isSignedIn() && request.auth.uid == "9RwsoEEkWPR3Wpv6wKZmhos1xTG2";
    }

    function isNotSelf(userId) {
      return request.auth.uid != userId;
    }

    // ---------------------------------------------------------------------------------------------
    // ðŸ”¹ Global Read Access for Everyone
    // ---------------------------------------------------------------------------------------------

    match /{document=**} {
      allow get, list: if true; // Everyone (even anonymous) can read
    }

    // ---------------------------------------------------------------------------------------------
    // ðŸ”¹ User Profiles and Subcollections
    // ---------------------------------------------------------------------------------------------

    match /users/{userId} {
      allow create, update: if isOwner(userId) || isSuperAdmin();
      allow delete: if isSuperAdmin();

      // Followers
      match /followers/{followerId} {
        allow create: if isSignedIn() && request.auth.uid == followerId && isNotSelf(userId);
        allow delete: if isSignedIn() && (request.auth.uid == followerId || isOwner(userId));
      }

      // Following
      match /following/{followedId} {
        allow create: if isOwner(userId) && isNotSelf(followedId);
        allow delete: if isOwner(userId);
      }

      // Preferences
      match /preferences/{prefId} {
        allow create, update, delete: if isOwner(userId) || isSuperAdmin();
      }

      // Bookmarks
      match /bookmarks/{bookmarkId} {
        allow create, delete: if isOwner(userId);
      }

      // Cart
      match /cart/{productId} {
        allow create, update, delete: if isOwner(userId);
      }
      
      // Rule to allow users to join/leave groups
      match /groups/{groupId} {
        allow create, delete: if isOwner(userId);
      }

      // Challenges / Playlist / Contest progress
      match /{subcollection}/{docId} {
        allow create, update, delete: if isOwner(userId) || isSuperAdmin();
      }
    }

    // ---------------------------------------------------------------------------------------------
    // ðŸ”¹ Content Collections (with if condition instead of 'where')
    // ---------------------------------------------------------------------------------------------

    match /{collectionId}/{docId} {
      allow create, update, delete: if isSuperAdmin() &&
        (collectionId in ['deities', 'epicHeroes', 'rituals', 'panchang', 'festivals', 'challenges', 'stories', 'temples', 'products']);
    }

    // ---------------------------------------------------------------------------------------------
    // ðŸ”¹ Media
    // ---------------------------------------------------------------------------------------------

    match /media/{mediaId} {
      allow create: if isSignedIn();
      allow update, delete: if isOwner(resource.data.userId) || isSuperAdmin();

      match /comments/{commentId} {
        allow create: if isSignedIn();
        allow update, delete: if isOwner(resource.data.authorId) || isSuperAdmin();
      }
      match /likes/{userId} {
        allow create, delete: if isOwner(userId);
      }
    }

    // ---------------------------------------------------------------------------------------------
    // ðŸ”¹ Posts
    // ---------------------------------------------------------------------------------------------

    match /posts/{postId} {
      allow create: if isSignedIn();
      allow update, delete: if isOwner(resource.data.authorId) || isSuperAdmin();

      match /comments/{commentId} {
        allow create: if isSignedIn();
        allow update, delete: if isOwner(resource.data.authorId) || isSuperAdmin();
      }
      match /likes/{userId} {
        allow create, delete: if isOwner(userId);
      }
    }

    // ---------------------------------------------------------------------------------------------
    // ðŸ”¹ Manifestations
    // ---------------------------------------------------------------------------------------------

    match /manifestations/{manifestationId} {
      allow create: if isSignedIn();
      allow update, delete: if isOwner(resource.data.userId) || isSuperAdmin();

      match /comments/{commentId} {
        allow create: if isSignedIn();
        allow update, delete: if isOwner(resource.data.authorId) || isSuperAdmin();
      }
      match /likes/{userId} {
        allow create, delete: if isOwner(userId);
      }
    }

    // ---------------------------------------------------------------------------------------------
    // ðŸ”¹ Channels
    // ---------------------------------------------------------------------------------------------

    match /channels/{channelId} {
      allow create, update, delete: if isOwner(channelId) || isSuperAdmin();
      match /subscribers/{userId} {
        allow create, delete: if isOwner(userId);
      }
    }

    // ---------------------------------------------------------------------------------------------
    // ðŸ”¹ Groups
    // ---------------------------------------------------------------------------------------------

    match /groups/{groupId} {
      allow create: if isSignedIn();
      allow update: if isSuperAdmin() || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberCount']);
      allow delete: if isSuperAdmin();
    }

    // ---------------------------------------------------------------------------------------------
    // ðŸ”¹ Orders
    // ---------------------------------------------------------------------------------------------

    match /orders/{orderId} {
      allow create: if isSignedIn();
      allow update, delete: if isSuperAdmin();
    }

    // ---------------------------------------------------------------------------------------------
    // ðŸ”¹ Contests
    // ---------------------------------------------------------------------------------------------

    match /contests/{contestId} {
      allow create, delete: if isSuperAdmin();
      allow update: if isSignedIn(); // Allows incrementing chants
      match /chants/{chantId} {
        allow create: if isSignedIn();
      }
    }
  }
}
