
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------------------------------------------------------------------------
    // Helper Functions
    // ---------------------------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isSuperAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true;
    }
    
    function isPublicRead() {
      return true; // anyone (including anonymous users) can read
    }

    // Ensures that a user cannot follow themselves.
    function isNotSelf(userId) {
      return request.auth.uid != userId;
    }

    // Validates the shape of a post being created
    function isValidPost() {
      return request.resource.data.authorId == request.auth.uid &&
             request.resource.data.content is string &&
             request.resource.data.content.size() > 0 &&
             request.resource.data.createdAt == request.time &&
             request.resource.data.contextType in ['group', 'temple', 'channel'] &&
             exists(/databases/$(database)/documents/$(request.resource.data.contextType + 's')/$(request.resource.data.contextId));
    }
    
    // Validates the shape of a comment being created
    function isValidComment(contentType) {
       return request.resource.data.authorId == request.auth.uid &&
              request.resource.data.text is string &&
              request.resource.data.text.size() > 0 &&
              request.resource.data.createdAt == request.time &&
              request.resource.data.contentType == contentType &&
              exists(/databases/$(database)/documents/$(contentType)/$(request.resource.data.contentId));
    }


    // ---------------------------------------------------------------------------------------------
    // User Collections
    // ---------------------------------------------------------------------------------------------

    match /users/{userId} {
      // Public profile is readable by anyone
      allow get: if true;
      // Users can only list their own subcollections, not other users'
      allow list: if isOwner(userId);
      // Only the owner can create, update, or delete their profile
      allow create, update, delete: if isOwner(userId);

      // --- Social Subcollections ---
      match /followers/{followerId} {
        allow read, list: if true;
        allow create: if isSignedIn() && request.auth.uid == followerId && isNotSelf(userId);
        allow delete: if isSignedIn() && (request.auth.uid == followerId || isOwner(userId));
        allow update: if false;
      }

      match /following/{followedId} {
        allow read, list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == followedId && isNotSelf(followedId);
        allow delete: if isOwner(userId);
        allow update: if false;
      }
      
      match /subscriptions/{channelId} {
        allow read, list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.channelId == channelId && isNotSelf(channelId);
        allow delete: if isOwner(userId);
        allow update: if false;
      }
      
      match /preferences/default {
        allow get, create, update, delete: if isOwner(userId);
      }
      match /badges/{badgeId} {
        allow get, list: if isOwner(userId);
        allow create, update, delete: if false; // Awarded server-side
      }
      match /bookmarks/{bookmarkId} {
        allow get, list, create, delete: if isOwner(userId);
        allow update: if false;
      }
       match /cart/{productId} {
        allow get, list, create, update, delete: if isOwner(userId);
      }
       match /horoscopes/{horoscopeId} {
        allow get: if isOwner(userId);
        allow list, create, update, delete: if false; // Generated server-side
      }
       match /challenges/{challengeId} {
         allow get, create, update, delete: if isOwner(userId);
       }
    }


    // ---------------------------------------------------------------------------------------------
    // Content Collections
    // ---------------------------------------------------------------------------------------------
    
    // Publicly readable content stubs
    match /{collectionId}/{docId} where collectionId in ['deities', 'stories', 'epicHeroes', 'rituals', 'panchang', 'festivals', 'challenges'] {
      allow get, list: if true;
      allow create, update, delete: if isSuperAdmin();
    }
    
    // Media
    match /media/{mediaId} {
      allow get, list: if true;
      allow create: if isOwner(request.resource.data.userId);
      allow update, delete: if isOwner(resource.data.userId) || isSuperAdmin();
      
      match /comments/{commentId} {
          allow list: if true;
          allow create: if isSignedIn() && isValidComment('media');
          allow update, delete: if isOwner(resource.data.authorId) || isSuperAdmin();
      }
      match /likes/{userId} {
          allow get, list: if true;
          allow create, delete: if isOwner(userId);
      }
    }
    
    // Temples
    match /temples/{templeId} {
      allow get, list: if true;
      allow create, update, delete: if isSuperAdmin();
      
       match /posts/{postId} {
         allow get, list: if true;
         allow create: if isSignedIn() && isValidPost();
         allow update, delete: if isOwner(resource.data.authorId) || isSuperAdmin();
       }
    }

    // Channels
    match /channels/{channelId} {
        allow get, list: if true;
        allow create, update: if isOwner(channelId);
        allow delete: if isOwner(channelId) || isSuperAdmin();

        match /subscribers/{userId} {
            allow read, list: if true;
            allow create: if isOwner(userId) && isNotSelf(channelId);
            allow delete: if isOwner(userId);
        }
    }
    
    // Playlists
    match /playlists/{playlistId} {
        allow get, list: if resource.data.isPublic == true || (isSignedIn() && isOwner(resource.data.creatorId));
        allow create, update, delete: if isSignedIn() && isOwner(request.resource.data.creatorId);
    }
    
    // Posts (Global collection for simplicity, context is key)
    match /posts/{postId} {
        allow get, list: if true;
        allow create: if isSignedIn() && isValidPost();
        allow update, delete: if isOwner(resource.data.authorId) || isSuperAdmin();

         match /comments/{commentId} {
            allow list: if true;
            allow create: if isSignedIn() && isValidComment('post');
            allow update, delete: if isOwner(resource.data.authorId) || isSuperAdmin();
        }
        match /likes/{userId} {
            allow get, list: if true;
            allow create, delete: if isOwner(userId);
        }
    }

    match /manifestations/{manifestationId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update, delete: if isOwner(resource.data.userId) || isSuperAdmin();

        match /comments/{commentId} {
            allow list: if true;
            allow create: if isSignedIn() && isValidComment('manifestation');
            allow update, delete: if isOwner(resource.data.authorId) || isSuperAdmin();
        }
        match /likes/{userId} {
            allow get, list: if true;
            allow create, delete: if isOwner(userId);
        }
    }


    // ---------------------------------------------------------------------------------------------
    // E-commerce & Community
    // ---------------------------------------------------------------------------------------------
    
    // Orders
    match /orders/{orderId} {
      allow get: if isOwner(resource.data.userId) || isSuperAdmin();
      allow list: if isSuperAdmin();
      allow create: if isOwner(request.resource.data.userId);
      allow update: if isSuperAdmin();
      allow delete: if false;
    }
    
    // Products
    match /products/{productId} {
        allow get, list: if true;
        allow create, update, delete: if isSuperAdmin();
    }
    
    // Contests
    match /contests/{contestId} {
        allow get, list: if true;
        // Allow any signed-in user to increment the totalChants count.
        // For all other fields, only a super admin can update.
        allow update: if (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['totalChants']))
                      || isSuperAdmin();
        allow create, delete: if isSuperAdmin();
        
        match /chants/{chantId} {
            allow list: if true;
            allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
            allow read, update, delete: if false;
        }
    }
  }
}
